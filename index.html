<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scrum PRO - Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <!-- Inclusão do plugin de rótulos de dados para Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <!-- Biblioteca para geração de PowerPoint -->
    <script src="https://cdn.jsdelivr.net/gh/gitbrent/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Manrope:wght@200..800&display=swap');
        
        :root {
            --bg-main: #F4F5F7;
            --primary: #1F3BB3;
            --secondary: #a3a4a5;
            --success: #1FDB84;
            --info: #05C283;
            --warning: #ffaf00;
            --danger: #f95f53;
            --text-main: #3e4b5b;
            --text-muted: #6c757d;
            --border-color: #e5e7eb;
        }

        body { 
            font-family: 'Manrope', sans-serif; 
            background-color: var(--bg-main); 
            color: var(--text-main);
            font-size: 13px;
            -webkit-font-smoothing: antialiased;
        }

        .card {
            background: white;
            border-radius: 0.5rem;
            border: 1px solid var(--border-color);
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.02);
            transition: all 0.3s ease;
        }

        .btn-primary {
            background-color: var(--primary);
            color: white !important;
            padding: 8px 16px;
            border-radius: 4px;
            font-weight: 700;
            font-size: 10px;
            letter-spacing: 0.5px;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border: none;
            cursor: pointer;
        }
        .btn-primary:hover { opacity: 0.9; transform: translateY(-1px); }

        .btn-secondary {
            background-color: white;
            color: #334155 !important;
            padding: 8px 16px;
            border-radius: 4px;
            font-weight: 700;
            font-size: 10px;
            letter-spacing: 0.5px;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border: 1px solid var(--border-color);
            cursor: pointer;
        }
        .btn-secondary:hover { background-color: #f8fafc; transform: translateY(-1px); }

        .sidebar {
            background: #FFFFFF;
            border-right: 1px solid var(--border-color);
            height: 100vh;
        }

        .nav-btn {
            border-radius: 6px;
            font-weight: 500;
            margin: 2px 0;
            padding: 10px 15px;
            transition: all 0.2s ease;
            color: #484848;
            font-size: 12px;
            cursor: pointer;
            text-align: left;
            width: 100%;
        }

        .nav-btn:hover { background: #f8f9fa; color: var(--primary); }
        .nav-btn.active { background: var(--primary); color: white !important; }

        .status-badge {
            padding: 2px 6px;
            font-weight: 700;
            font-size: 9px;
            border-radius: 3px;
            display: inline-flex;
            align-items: center;
            letter-spacing: 0.3px;
            white-space: nowrap;
        }

        .dense-table {
            border-collapse: collapse;
            width: 100%;
        }

        .dense-table thead th {
            background: #fdfdfd;
            border-bottom: 1px solid #f1f3f9;
            color: var(--text-muted);
            font-size: 9px;
            font-weight: 800;
            padding: 10px 15px;
            text-align: left;
            letter-spacing: 0.8px;
            white-space: nowrap;
        }

        .dense-table tbody td {
            padding: 8px 15px;
            border-bottom: 1px solid #f1f3f9;
            font-size: 11px;
            color: #555;
            vertical-align: middle;
        }

        .dense-table tbody tr.selected { background-color: #f0f7ff; }
        .dense-table tbody tr:hover { background-color: #fcfcfc; }

        .filter-select, .form-input {
            border: 1px solid #d1d5db;
            font-size: 11px;
            font-weight: 500;
            color: #374151;
            border-radius: 4px;
            padding: 6px 10px;
            outline: none;
            background: #fff;
            transition: all 0.2s;
            height: 32px;
        }
        .filter-select:hover, .form-input:hover { border-color: #9ca3af; }
        .filter-select:focus, .form-input:focus { border-color: var(--primary); }

        .top-navbar {
            background: #FFFFFF;
            border-bottom: 1px solid var(--border-color);
            height: 75px;
            min-height: 75px;
            max-height: 75px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.02);
            z-index: 100;
            box-sizing: border-box;
        }

        .submenu-item {
            padding: 6px 15px 6px 40px;
            font-size: 12px;
            color: #6c757d;
            display: block;
            text-align: left;
            width: 100%;
            cursor: pointer;
        }
        .submenu-item:hover, .submenu-item.active { color: var(--primary); font-weight: 600; }

        .completion-bar {
            height: 4px;
            background: #f1f3f9;
            border-radius: 10px;
            overflow: hidden;
            width: 50px;
        }
        .completion-fill { height: 100%; transition: width 0.8s ease; }

        .chart-container-fixed { height: 250px; position: relative; }
        .chart-container-main { height: 320px; position: relative; }

        .search-result-item {
            padding: 8px 12px;
            cursor: pointer;
            border-bottom: 1px solid #f3f4f6;
            transition: background 0.2s;
        }
        .search-result-item:hover { background: #f9fafb; }
        
        .system-footer {
            border-top: 1px solid var(--border-color);
            padding: 12px 30px;
            background: #fff;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 9px;
            font-weight: 700;
            color: #94a3b8;
            letter-spacing: 0.5px;
        }

        .filters-bar {
            background: #fff;
            padding: 0.75rem 1.25rem;
            border-radius: 0.5rem;
            border: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .bulk-action-bar {
            background: #1F3BB3;
            color: white;
            padding: 8px 20px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 4px 12px rgba(31, 59, 179, 0.2);
            margin-bottom: 16px;
            animation: slideDown 0.3s ease;
        }

        .page-title-section {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #eef0f4;
        }
        .page-title-section h1 {
            font-size: 1.5rem;
            font-weight: 800;
            color: #111827;
            letter-spacing: -0.02em;
            line-height: 1;
        }
        .page-title-section p {
            font-size: 0.75rem;
            font-weight: 700;
            color: #9ca3af;
            letter-spacing: 0.1em;
            margin-top: 0.5rem;
        }

        /* Preview Slide Styles */
        .slide-preview-container {
            aspect-ratio: 16 / 9;
            background: #F4F5F7;
            border: 1px solid #ddd;
            position: relative;
            padding: 40px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            overflow: hidden;
            margin-bottom: 20px;
        }
        .slide-preview-container h2 { color: #1F3BB3; font-weight: 800; margin-bottom: 20px; }

        /* Estilos Novos para Preview Dinâmico */
        .preview-config-panel {
            background: white;
            border-right: 1px solid #e5e7eb;
            width: 300px;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }
        .config-checkbox-item {
            display: flex;
            align-items: center;
            padding: 10px 20px;
            border-bottom: 1px solid #f8fafc;
            cursor: pointer;
            transition: background 0.2s;
        }
        .config-checkbox-item:hover { background: #f1f5f9; }
        .config-checkbox-item input { margin-right: 12px; }
        .config-checkbox-item span { font-size: 11px; font-weight: 700; color: #475569; }
    </style>
</head>
<body class="flex flex-col md:flex-row overflow-hidden">

    <!-- Sidebar Menu -->
    <aside id="sidebar-menu" class="sidebar flex flex-col p-4 z-40 w-60 text-slate-800">
        <div class="flex items-center space-x-3 mb-8 px-2">
            <div class="w-7 h-7 bg-[#1F3BB3] rounded flex items-center justify-center shadow-sm">
                <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
            </div>
            <h1 class="text-lg font-bold text-[#1F3BB3] tracking-tight">Scrum<span class="font-normal text-gray-400">/Pro</span></h1>
        </div>

        <nav class="flex-1 overflow-y-auto text-xs">
            <p class="text-[9px] font-extrabold text-gray-400 tracking-widest mb-3 px-3">Principal</p>
            <button id="nav-dashboard" onclick="window.showView('dashboard')" class="nav-btn active flex items-center mb-1">
                <svg class="w-4 h-4 mr-3 opacity-60" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z"></path></svg>
                <span>Dashboard</span>
            </button>
            
            <button id="parent-registrar" onclick="window.toggleSubmenu('registrar')" class="nav-btn flex items-center justify-between mb-1">
                <span class="flex items-center">
                    <svg class="w-4 h-4 mr-3 opacity-60" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path></svg>
                    <span>Gerenciamento</span>
                </span>
                <svg id="arrow-registrar" class="w-3 h-3 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
            </button>
            <div id="submenu-registrar" class="hidden">
                <button id="nav-feature" onclick="window.showView('feature')" class="submenu-item">Features</button>
                <button id="nav-stories" onclick="window.showView('stories')" class="submenu-item">Histórias</button>
                <button id="nav-tasks_view" onclick="window.showView('tasks_view')" class="submenu-item">Tarefas</button>
            </div>
            
            <p class="text-[9px] font-extrabold text-gray-400 tracking-widest mb-3 px-3 mt-8">Configurações</p>
            <button id="parent-configs" onclick="window.toggleSubmenu('config-parent'); window.showView('configs')" class="nav-btn flex items-center justify-between mb-1">
                <span class="flex items-center">
                    <svg class="w-4 h-4 mr-3 opacity-60" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924-1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path></svg>
                    <span>Parâmetros</span>
                </span>
                <svg id="arrow-config-parent" class="w-3 h-3 transition-transform text-slate-800" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
            </button>
            <div id="submenu-config-parent" class="hidden">
                <button id="nav-configs" onclick="window.showView('configs')" class="submenu-item">Ajustes de Sistemas</button>
            </div>

            <button id="nav-import" onclick="window.showView('import')" class="nav-btn flex items-center group">
                <svg class="w-4 h-4 mr-3 opacity-60" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
                <span>Importação CSV</span>
            </button>
        </nav>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 main-content-wrapper flex flex-col h-screen overflow-y-auto relative text-slate-800">
        
        <!-- HEADER PADRONIZADO (75px) -->
        <header class="top-navbar px-8 flex justify-between items-center sticky top-0 z-30">
            <div class="flex items-center space-x-6">
                <!-- Filtros Globais do Header (Aparecem apenas no Dashboard) -->
                <div id="header-dashboard-filters" class="hidden flex items-center space-x-2">
                    <div class="flex items-center px-2 text-slate-400">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"></path></svg>
                        <span class="text-[9px] font-black ml-2 tracking-widest">Filtros Globais</span>
                    </div>
                    <select id="dashboard-global-filter-directorate" onchange="window.handleGlobalFilterChange()" class="filter-select !h-8 !text-[10px] min-w-[150px] border-slate-200 font-bold">
                        <option value="">Todas as Diretorias</option>
                    </select>
                    <select id="dashboard-global-filter-area" onchange="window.handleGlobalFilterChange()" class="filter-select !h-8 !text-[10px] min-w-[150px] border-slate-200 font-bold">
                        <option value="">Todas as Áreas</option>
                    </select>
                    <select id="dashboard-global-filter-po" onchange="window.handleGlobalFilterChange()" class="filter-select !h-8 !text-[10px] min-w-[150px] border-slate-200 font-bold">
                        <option value="">Todos os POs</option>
                    </select>
                    <button onclick="window.clearGlobalFilters()" class="text-[9px] font-black text-[#1F3BB3] hover:underline ml-2">Limpar</button>
                </div>
            </div>

            <!-- Lado Direito do Header -->
            <div class="flex items-center space-x-6">
                <div class="text-right">
                    <p id="current-date-display" class="text-[10px] font-black text-slate-700 tracking-tighter"></p>
                    <p class="text-[8px] text-[#1FDB84] font-bold tracking-widest">Sincronizado</p>
                </div>
            </div>
        </header>

        <div class="p-8 flex-1">
            <!-- Modal Mensagens -->
            <div id="message-modal" class="fixed inset-0 bg-slate-900/30 backdrop-blur-[2px] flex items-center justify-center z-[300] hidden">
                <div class="card p-8 w-full max-sm text-center border-t-4 border-[#1F3BB3]">
                    <h3 id="modal-title" class="text-base font-bold text-slate-800 mb-2"></h3>
                    <p id="modal-body" class="text-xs text-slate-500 mb-6 leading-relaxed whitespace-pre-line"></p>
                    <div id="modal-actions" class="flex justify-center space-x-3"></div>
                </div>
            </div>

            <!-- Modal Preview PPT -->
            <div id="ppt-preview-modal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-md flex items-center justify-center z-[400] hidden p-4 overflow-y-auto">
                <div class="card w-full max-w-6xl shadow-2xl flex flex-col bg-slate-100 overflow-hidden h-[90vh]">
                    <div class="p-6 bg-white border-b flex justify-between items-center shrink-0">
                        <div>
                            <h3 class="text-lg font-extrabold text-[#1F3BB3]">Configuração do Relatório Gerencial</h3>
                            <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Selecione os componentes e visualize o resultado</p>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="window.closePPTPreview()" class="btn-secondary">Cancelar</button>
                            <button onclick="window.generatePPTReport(); window.closePPTPreview();" class="btn-primary !bg-orange-600 shadow-lg shadow-orange-200">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a2 2 0 002 2h12a2 2 0 002-2v-1M7 10l5 5m0 0l5-5m-5 5V3"></path></svg>
                                Baixar PowerPoint (.pptx)
                            </button>
                        </div>
                    </div>
                    <div class="flex flex-1 overflow-hidden">
                        <div class="preview-config-panel shrink-0">
                            <div class="p-5 border-b bg-slate-50">
                                <h4 class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Componentes</h4>
                            </div>
                            <div class="flex-1 overflow-y-auto" id="ppt-component-selector-list"></div>
                        </div>
                        <div class="flex-1 p-10 space-y-12 overflow-y-auto bg-slate-200">
                            <div id="ppt-preview-dynamic-content" class="space-y-10"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- View Dashboard -->
            <div id="dashboard-view" class="view space-y-8 animate-fadeIn">
                <div class="page-title-section">
                    <div>
                        <h1>Dashboard</h1>
                        <p>Visão geral de performance</p>
                    </div>
                    <button onclick="window.openPPTPreview()" class="btn-primary !bg-orange-600">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l5 5 5-5M12 17V7"></path></svg>
                        Exportar Report Gerencial (PPT)
                    </button>
                </div>
                <div id="dashboard-summary" class="grid grid-cols-1 md:grid-cols-3 gap-6"></div>
                <div class="grid grid-cols-1 gap-6">
                    <div class="card p-6 shadow-sm">
                        <h3 class="text-xs font-black text-slate-400 tracking-widest mb-6 flex items-center">
                            <span class="w-1 h-3 bg-blue-600 rounded-full mr-2"></span>Distribuição por status
                        </h3>
                        <div class="chart-container-main"><canvas id="chart-status-groups"></canvas></div>
                    </div>
                </div>
                <div class="grid grid-cols-1 gap-6">
                    <div class="card p-6 overflow-hidden shadow-sm">
                        <h3 class="text-xs font-black text-slate-400 tracking-widest mb-6 flex items-center">
                            <span class="w-1 h-3 bg-indigo-500 rounded-full mr-2"></span>Iniciativas em destaque
                        </h3>
                        <div class="overflow-x-auto">
                            <table class="dense-table">
                                <thead><tr><th>Título</th><th>Diretoria</th><th>PO</th><th class="text-center">Prioridade</th><th class="text-center">Status</th><th class="text-center">Histórias</th></tr></thead>
                                <tbody id="featured-features-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="grid grid-cols-1 gap-6">
                    <div class="card p-6 overflow-hidden shadow-sm">
                        <h3 class="text-xs font-black text-slate-400 tracking-widest mb-6 flex items-center">
                            <span class="w-1 h-3 bg-amber-400 rounded-full mr-2"></span>Histórias em destaque
                        </h3>
                        <div class="overflow-x-auto">
                            <table class="dense-table">
                                <thead><tr><th>Título</th><th>Área</th><th>PO</th><th class="text-center">Prioridade</th><th class="text-center">Status</th><th class="text-center">Execução</th></tr></thead>
                                <tbody id="featured-stories-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="card p-6 flex flex-col h-[400px] shadow-sm">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-xs font-black text-slate-400 tracking-widest flex items-center"><span class="w-1 h-3 bg-green-500 rounded-full mr-2"></span>Entregas</h3>
                            <div class="flex gap-1.5">
                                <select id="initiatives-type" onchange="window.handleDeliveriesTypeChange(this.value)" class="filter-select !h-7 !text-[9px] !py-0">
                                    <option value="stories" selected>Histórias</option>
                                    <option value="tasks">Tarefas</option>
                                </select>
                                <select id="filter-done-month" onchange="window.renderCompletedInitiatives()" class="filter-select !h-7 !text-[9px] !py-0"></select>
                                <select id="filter-done-year" onchange="window.renderCompletedInitiatives()" class="filter-select !h-7 !text-[9px] !py-0"></select>
                            </div>
                        </div>
                        <div class="flex-1 overflow-y-auto border border-gray-50 rounded">
                            <div id="deliveries-back-button-container" class="hidden p-2 bg-gray-50 border-b">
                                <button onclick="window.clearDeliveriesDrillDown()" class="text-[9px] font-black text-blue-700 flex items-center">
                                    <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                                    Voltar para histórias
                                </button>
                            </div>
                            <table class="dense-table"><thead><tr id="initiatives-header"></tr></thead><tbody id="done-tasks-list-body"></tbody></table>
                        </div>
                    </div>
                    <div class="card p-6 shadow-sm flex flex-col h-[400px]">
                        <div class="flex justify-between items-start mb-4">
                            <h3 class="text-xs font-black text-slate-400 tracking-widest flex items-center"><span class="w-1 h-3 bg-indigo-600 rounded-full mr-2"></span>Status por área</h3>
                            <div class="relative w-40" id="area-dropdown-container">
                                <button onclick="window.toggleAreaDropdown()" class="filter-select !h-7 !text-[10px] w-full flex justify-between items-center bg-white">
                                    <span id="selected-areas-label" class="truncate">Áreas...</span>
                                    <svg class="w-3 h-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                                </button>
                                <div id="area-dropdown-list" class="hidden absolute right-0 mt-1 w-56 bg-white border border-gray-200 rounded shadow-xl z-50 max-h-52 overflow-y-auto py-1"></div>
                            </div>
                        </div>
                        <div id="dashboard-area-tags" class="flex flex-wrap gap-1.5 mb-3 min-h-[24px]"></div>
                        <div class="flex-1 chart-container-fixed"><canvas id="chart-status-area"></canvas></div>
                    </div>
                </div>
                <div class="grid grid-cols-1 gap-6">
                    <div class="card p-6 shadow-sm">
                        <h3 class="text-xs font-black text-slate-400 tracking-widest mb-6 flex items-center">
                            <span class="w-1 h-3 bg-orange-400 rounded-full mr-2"></span>QA negócio por área
                        </h3>
                        <div class="chart-container-fixed"><canvas id="chart-qa-area"></canvas></div>
                    </div>
                </div>
            </div>

            <!-- View Parâmetros -->
            <div id="configs-view" class="view hidden space-y-6 animate-fadeIn">
                <div class="page-title-section"><div><h1>Parâmetros</h1><p>Configurações de sistemas</p></div></div>
                 <div id="configs-content" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
            </div>

            <!-- View Features -->
            <div id="feature-view" class="view hidden space-y-4 animate-fadeIn">
                <div class="page-title-section"><div><h1>Features</h1><p>Grandes iniciativas</p></div><div class="flex gap-2"><button onclick="window.exportToCSV('features')" class="btn-secondary">Exportar CSV</button><button onclick="window.openFeatureForm()" class="btn-primary">+ Nova feature</button></div></div>
                <div class="filters-bar">
                    <span class="text-[9px] font-black text-slate-400">Filtrar tabela:</span>
                    <select id="filter-feature-po" onchange="window.handleViewFilterChange('features')" class="filter-select min-w-[150px]"></select>
                    <select id="filter-feature-status" onchange="window.handleViewFilterChange('features')" class="filter-select min-w-[150px]"></select>
                </div>
                <div id="bulk-features-actions" class="bulk-action-bar hidden"><span id="bulk-features-count" class="text-xs font-bold">0 Selecionado(s)</span><div class="flex space-x-2"><button onclick="window.bulkEdit('features')" class="bg-white/20 hover:bg-white/30 text-white px-4 py-1.5 rounded text-[10px] font-bold">Editar</button><button onclick="window.bulkDelete('features')" class="bg-red-500 hover:bg-red-600 text-white px-4 py-1.5 rounded text-[10px] font-bold">Excluir</button></div></div>
                <div class="card overflow-hidden">
                    <table class="dense-table">
                        <thead><tr><th class="w-12 text-center"><input type="checkbox" id="select-all-features" onchange="window.toggleSelectAll('features', this.checked)"></th><th class="w-24 text-center">ID Ext</th><th>Iniciativa</th><th class="text-center w-24">Prioridade</th><th>PO</th><th class="text-center">Situação</th></tr></thead>
                        <tbody id="features-table-body"></tbody>
                    </table>
                    <div id="features-pagination-container" class="px-6 py-4 bg-gray-50 border-t border-gray-100 flex justify-between items-center hidden"><span id="features-pagination-info" class="text-[10px] font-bold text-slate-400">Mostrando 0 de 0 features</span><div class="flex items-center space-x-2"><span class="text-[10px] font-bold text-slate-400">Ver mais:</span><select id="features-page-size-select" onchange="window.handlePageSizeFeaturesChange(this.value)" class="filter-select !h-7 !py-0 !text-[10px] font-bold"><option value="20">20 linhas</option><option value="50">50 linhas</option><option value="100">100 linhas</option><option value="500">500 linhas</option></select></div></div>
                </div>
            </div>

            <!-- View Histórias -->
            <div id="stories-view" class="view hidden space-y-4 animate-fadeIn">
                <div class="page-title-section"><div><h1>Histórias</h1><p>Histórias & backlog</p></div><div class="flex gap-2"><button onclick="window.exportToCSV('stories')" class="btn-secondary">Exportar CSV</button><button onclick="window.openStoryForm()" class="btn-primary">+ Nova história</button></div></div>
                <div class="filters-bar">
                    <span class="text-[9px] font-black text-slate-400">Filtrar tabela:</span>
                    <input type="text" id="filter-story-search" oninput="window.handleViewFilterChange('stories')" placeholder="Pesquisar id ou título..." class="filter-select flex-1">
                    <select id="filter-story-area" onchange="window.handleViewFilterChange('stories')" class="filter-select min-w-[150px]"></select>
                    <select id="filter-story-po" onchange="window.handleViewFilterChange('stories')" class="filter-select min-w-[150px]"></select>
                    <select id="filter-story-status" onchange="window.handleViewFilterChange('stories')" class="filter-select min-w-[150px]"></select>
                </div>
                <div id="bulk-stories-actions" class="bulk-action-bar hidden"><span id="bulk-stories-count" class="text-xs font-bold">0 Selecionado(s)</span><div class="flex space-x-2"><button onclick="window.bulkEdit('stories')" class="bg-white/20 hover:bg-white/30 text-white px-4 py-1.5 rounded text-[10px] font-bold">Editar</button><button onclick="window.bulkDelete('stories')" class="bg-red-500 hover:bg-red-600 text-white px-4 py-1.5 rounded text-[10px] font-bold">Excluir</button></div></div>
                <div class="card overflow-hidden">
                    <table class="dense-table">
                        <thead><tr><th class="w-12 text-center"><input type="checkbox" id="select-all-stories" onchange="window.toggleSelectAll('stories', this.checked)"></th><th class="w-24 text-center">ID Ext</th><th>Título</th><th class="text-center w-24">Prioridade</th><th>Área</th><th>PO</th><th class="text-center">Status</th><th class="w-32 text-center">Progresso</th></tr></thead>
                        <tbody id="stories-table-body"></tbody>
                    </table>
                    <div id="stories-pagination-container" class="px-6 py-4 bg-gray-50 border-t border-gray-100 flex justify-between items-center hidden"><span id="stories-pagination-info" class="text-[10px] font-bold text-slate-400">Mostrando 0 de 0 histórias</span><div class="flex items-center space-x-2"><span class="text-[10px] font-bold text-slate-400">Ver mais:</span><select id="stories-page-size-select" onchange="window.handlePageSizeStoriesChange(this.value)" class="filter-select !h-7 !py-0 !text-[10px] font-bold"><option value="20">20 linhas</option><option value="50">50 linhas</option><option value="100">100 linhas</option><option value="500">500 linhas</option></select></div></div>
                </div>
            </div>

            <!-- View Tarefas -->
            <div id="tasks_view-view" class="view hidden space-y-4 animate-fadeIn">
                <div class="page-title-section"><div><h1>Tarefas</h1><p>Gestão técnica</p></div><div class="flex gap-2"><button onclick="window.exportToCSV('tasks')" class="btn-secondary">Exportar CSV</button><button onclick="window.openTaskForm()" class="btn-primary">+ Nova tarefa</button></div></div>
                <div class="filters-bar">
                    <span class="text-[9px] font-black text-slate-400">Filtrar tabela:</span>
                    <input type="text" id="filter-tasks-search" oninput="window.handleViewFilterChange('tasks_view')" placeholder="Pesquisar id, gmud ou atividade..." class="filter-select flex-1">
                    <select id="filter-tasks-status" onchange="window.handleViewFilterChange('tasks_view')" class="filter-select min-w-[150px]"></select>
                    <select id="filter-tasks-system" onchange="window.handleViewFilterChange('tasks_view')" class="filter-select min-w-[150px]"></select>
                    <select id="filter-tasks-techlead" onchange="window.handleViewFilterChange('tasks_view')" class="filter-select min-w-[150px]"></select>
                </div>
                <div id="bulk-tasks_view-actions" class="bulk-action-bar hidden"><span id="bulk-tasks_view-count" class="text-xs font-bold">0 Selecionado(s)</span><div class="flex space-x-2"><button onclick="window.bulkEdit('tasks_view')" class="bg-white/20 hover:bg-white/30 text-white px-4 py-1.5 rounded text-[10px] font-bold">Editar</button><button onclick="window.bulkDelete('tasks_view')" class="bg-red-500 hover:bg-red-600 text-white px-4 py-1.5 rounded text-[10px] font-bold">Excluir</button></div></div>
                <div class="card overflow-hidden">
                    <table class="dense-table">
                        <thead><tr><th class="w-12 text-center"><input type="checkbox" id="select-all-tasks_view" onchange="window.toggleSelectAll('tasks_view', this.checked)"></th><th class="w-24 text-center">ID Ext</th><th class="w-24 text-center">GMUD</th><th>Atividade</th><th class="text-center">Status</th><th class="text-center">Sistema</th><th>Responsável</th></tr></thead>
                        <tbody id="tasks_view-table-body"></tbody>
                    </table>
                    <div id="tasks-pagination-container" class="px-6 py-4 bg-gray-50 border-t border-gray-100 flex justify-between items-center hidden"><span id="tasks-pagination-info" class="text-[10px] font-bold text-slate-400">Mostrando 0 de 0 tarefas</span><div class="flex items-center space-x-2"><span class="text-[10px] font-bold text-slate-400">Ver mais:</span><select id="tasks-page-size-select" onchange="window.handlePageSizeChange(this.value)" class="filter-select !h-7 !py-0 !text-[10px] font-bold"><option value="20">20 linhas</option><option value="50">50 linhas</option><option value="100">100 linhas</option><option value="500">500 linhas</option></select></div></div>
                </div>
            </div>

            <!-- View Importação -->
            <div id="import-view" class="view hidden space-y-6 animate-fadeIn"><div class="page-title-section"><div><h1>Importação</h1><p>Carga de dados CSV</p></div></div><div class="grid grid-cols-1 md:grid-cols-3 gap-6" id="import-cards-container"></div></div>
        </div>
        <footer class="system-footer"><div class="flex items-center"><span class="mr-1 opacity-60">Scrum PRO Dashboard</span><span id="system-version-display" class="ml-2">v1.0.9</span></div><div>© <span id="current-year"></span> Todos os direitos reservados</div></footer>

        <!-- Modals -->
        <div id="task-modal" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-[210] flex items-center justify-center hidden p-4 overflow-y-auto">
            <div class="card p-10 w-full max-w-2xl shadow-2xl my-auto">
                <form id="task-form" class="space-y-6">
                    <h3 class="text-xl font-bold border-b pb-4">Gestão de tarefa</h3>
                    <input type="hidden" id="task-id"><input type="hidden" id="task-doc-id">
                    <div class="space-y-1 relative" id="task-story-assoc-container"><label class="text-[10px] font-bold">História associada (Pesquisa)</label><div class="relative"><input type="text" id="task-story-search-input" class="form-input w-full pr-10" placeholder="Busque pelo título ou #ID..." autocomplete="off"><input type="hidden" id="task-story-assoc-id"><div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none"><svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg></div></div><div id="task-story-search-results" class="hidden absolute left-0 right-0 mt-1 bg-white border border-gray-200 rounded shadow-xl z-[250] max-h-56 overflow-y-auto py-1"></div></div>
                    <div class="grid grid-cols-2 gap-6"><div><label class="text-[10px] font-bold">ID Ext</label><input type="number" id="task-external-id" class="form-input w-full"></div><div><label class="text-[10px] font-bold">ID GMUD</label><input type="text" id="task-gmud-id" class="form-input w-full"></div></div>
                    <div class="space-y-1"><label class="text-[10px] font-bold">Atividade</label><input type="text" id="task-title" required class="form-input w-full"></div>
                    <div class="grid grid-cols-2 gap-6"><div><label class="text-[10px] font-bold">Status</label><select id="task-status" class="filter-select w-full" required></select></div><div><label class="text-[10px] font-bold">Sistema</label><select id="task-system" class="filter-select w-full" required></select></div></div>
                    <div class="grid grid-cols-3 gap-6"><div><label class="text-[10px] font-bold">Tech Lead</label><select id="task-techlead" class="filter-select w-full"></select></div><div><label class="text-[10px] font-bold">Dev Resp.</label><select id="task-developer" class="filter-select w-full"></select></div><div><label class="text-[10px] font-bold">Link</label><input type="url" id="task-external-link" class="form-input w-full"></div></div>
                    <div><label class="text-[10px] font-bold">Descrição</label><textarea id="task-description" class="form-input w-full h-24 resize-none"></textarea></div>
                    <div class="flex justify-end gap-3 pt-6 border-t"><button type="button" onclick="document.getElementById('task-modal').classList.add('hidden')" class="text-sm font-bold text-gray-400 px-4">Cancelar</button><button type="submit" class="btn-primary text-white">Gravar</button></div>
                </form>
            </div>
        </div>

        <div id="feature-stories-modal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[150] flex items-center justify-center hidden p-4 overflow-y-auto"><div class="card p-8 w-full max-w-4xl shadow-2xl my-auto"><div class="flex justify-between items-center mb-4 pb-2 border-b"><h3 class="text-lg font-bold text-slate-900">Histórias associadas</h3><button onclick="window.closeFeatureStoriesModal()" class="text-gray-400 font-bold">✕</button></div><div class="border border-gray-100 rounded-xl overflow-hidden shadow-sm"><table class="dense-table"><thead><tr><th class="w-24 text-center">ID Ext</th><th>Título</th><th>Área</th><th class="w-40 text-center">Status</th></tr></thead><tbody id="feature-stories-modal-table-body"></tbody></table></div></div></div>
        <div id="task-list-modal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[150] flex items-center justify-center hidden p-4 overflow-y-auto"><div class="card p-8 w-full max-w-4xl shadow-2xl my-auto"><div class="flex justify-between items-center mb-4 pb-2 border-b"><h3 class="text-lg font-bold text-slate-900">Tarefas da história</h3><div class="flex items-center space-x-2"><div id="bulk-tasks-actions" class="hidden bg-slate-100 p-2 rounded flex space-x-2"><button onclick="window.bulkEdit('tasks')" class="text-blue-700 font-bold text-[10px]">Editar</button><button onclick="window.bulkDelete('tasks')" class="text-red-500 font-bold text-[10px]">Apagar</button></div><button onclick="window.closeStoryTasksModal()" class="text-gray-400 font-bold">✕</button></div></div><div class="border border-gray-100 rounded overflow-hidden mb-8 shadow-sm"><table class="dense-table"><thead><tr><th class="w-12 text-center"><input type="checkbox" id="select-all-tasks" onchange="window.toggleSelectAll('tasks', this.checked)"></th><th class="w-20 text-center">ID</th><th>Atividade</th><th class="w-40 text-center">Status</th></tr></thead><tbody id="task-list-modal-table-body"></tbody></table></div><div class="flex justify-end"><button id="add-task-from-modal-btn" class="btn-primary text-white">Nova task</button></div></div></div>
        <div id="story-form-container" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-[200] flex items-center justify-center hidden p-4 overflow-y-auto"><div class="card p-10 w-full max-w-2xl shadow-2xl my-auto"><form id="story-form" class="space-y-6"><h3 class="text-xl font-bold border-b pb-4">Gestão de história</h3><input type="hidden" id="story-id"><input type="hidden" id="story-doc-id"><div class="grid grid-cols-4 gap-6"><div class="col-span-1"><label class="text-[10px] font-bold">ID Ext</label><input type="number" id="story-external-id" class="form-input w-full"></div><div class="col-span-3"><label class="text-[10px] font-bold">Título</label><input type="text" id="story-title" required class="form-input w-full"></div></div><div class="grid grid-cols-2 gap-6"><div><label class="text-[10px] font-bold">Área operacional</label><select id="story-area" class="filter-select w-full" required></select></div><div><label class="text-[10px] font-bold">PO</label><select id="story-po" class="filter-select w-full" required></select></div></div><div class="grid grid-cols-2 gap-6"><div><label class="text-[10px] font-bold">Link (URL)</label><input type="url" id="story-external-link" class="form-input w-full"></div><div><label class="text-[10px] font-bold">Status atual</label><select id="story-status" class="filter-select w-full" required></select></div></div><div class="grid grid-cols-2 gap-6"><div><label class="text-[10px] font-bold">Prioridade (por área)</label><select id="story-priority" class="filter-select w-full" required></select></div><div class="flex items-center pt-5"><input type="checkbox" id="story-is-featured" class="w-4 h-4 mr-3"><label for="story-is-featured" class="text-xs font-bold">Destaque</label></div></div><div class="space-y-1"><label class="text-[10px] font-bold">Feature associada</label><select id="story-feature" class="filter-select w-full"></select></div><div><label class="text-[10px] font-bold">Descrição</label><textarea id="story-description" class="form-input w-full h-24 resize-none"></textarea></div><div class="flex justify-end gap-3 pt-6 border-t"><button type="button" onclick="window.closeStoryForm()" class="text-sm font-bold text-gray-400 px-4">Cancelar</button><button type="submit" class="btn-primary text-white">Gravar</button></div></form></div></div>
        <div id="feature-form-container" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-[200] flex items-center justify-center hidden p-4 overflow-y-auto"><div class="card p-10 w-full max-w-2xl shadow-2xl my-auto"><form id="feature-form" class="space-y-6"><h3 class="text-xl font-bold border-b pb-4">Gestão de feature</h3><input type="hidden" id="feature-id"><input type="hidden" id="feature-doc-id"><div class="grid grid-cols-4 gap-6"><div class="col-span-1"><label class="text-[10px] font-bold">ID Ext</label><input type="number" id="feature-external-id" class="form-input w-full"></div><div class="col-span-3"><label class="text-[10px] font-bold">Iniciativa</label><input type="text" id="feature-title" required class="form-input w-full"></div></div><div class="grid grid-cols-2 gap-6"><div><label class="text-[10px] font-bold">Diretoria</label><select id="feature-directorate" class="filter-select w-full" required></select></div><div><label class="text-[10px] font-bold">PO</label><select id="feature-po" class="filter-select w-full" required></select></div></div><div class="grid grid-cols-2 gap-6"><div><label class="text-[10px] font-bold">Link externo</label><input type="url" id="feature-external-link" class="form-input w-full"></div><div><label class="text-[10px] font-bold">Status</label><select id="feature-status" class="filter-select w-full" required></select></div></div><div class="grid grid-cols-2 gap-6"><div><label class="text-[10px] font-bold">Prioridade (por diretoria)</label><select id="feature-priority" class="filter-select w-full" required></select></div><div class="flex items-center pt-5"><input type="checkbox" id="feature-is-featured" class="w-4 h-4 mr-3"><label for="feature-is-featured" class="text-xs font-bold">Destaque</label></div></div><div><label class="text-[10px] font-bold">Descrição</label><textarea id="feature-description" class="form-input w-full h-24 resize-none"></textarea></div><div class="flex justify-end gap-3 pt-6 border-t"><button type="button" onclick="document.getElementById('feature-form-container').classList.add('hidden')" class="text-sm font-bold text-gray-400 px-4">Cancelar</button><button type="submit" class="btn-primary text-white">Gravar</button></div></form></div></div>
    </main>

<script>
    window.SYSTEM_VERSION = "v1.0.9";
    window.features = []; window.stories = []; window.tasks = []; window.charts = { statusGroups: null, statusArea: null, "qaArea": null };
    window.configs = { directorate: [], area: [], po: [], system: [], techlead: [], developer: [], statusStory: [], statusTask: [], statusFeature: [], priorityFeature: [], priorityStory: [], year: [], fieldLimits: [], deliveryConfigs: [] };
    window.dashboardSelectedAreas = new Set();
    window.selectedIds = { features: new Set(), stories: new Set(), tasks: new Set(), tasks_view: new Set() };
    window.dashboardGlobalFilters = { directorate: '', area: '', po: '' };
    window.viewFilters = { features: { po: '', status: '' }, stories: { area: '', po: '', status: '', search: '' }, tasks_view: { status: '', system: '', techlead: '', search: '' } };

    window.pptSelectedComponents = { 'total-stories': true, 'delivery-rate': true, 'not-delivered': true, 'status-distribution': true, 'featured-initiatives': true, 'featured-stories': true, 'deliveries': true, 'status-by-area': true, 'qa-business': true };
    window.pageSizeTasks = 20; window.pageSizeStories = 20; window.pageSizeFeatures = 20;
    window.deliveriesFilterStoryId = null;

    window.statusColors = { 'A Fazer': 'bg-[#f95f53] text-white', 'Em desenvolvimento': 'bg-[#1f3bb3] text-white', 'Em andamento': 'bg-[#1f3bb3] text-white', 'QA TI': 'bg-[#1f3bb3] text-white', 'Em Teste': 'bg-orange-500 text-white', 'Concluído': 'bg-[#1fdb84] text-white', 'Concluída': 'bg-[#1fdb84] text-white', 'Backlog': 'bg-gray-400 text-white', 'Proposto': 'bg-gray-400 text-white', 'Aprovado': 'bg-amber-400 text-white', 'DOR': 'bg-amber-400 text-white', 'Definição de Pronto (DOR)': 'bg-amber-400 text-white', 'QA Negócio': 'bg-orange-500 text-white', 'Em refinamento': 'bg-gray-400 text-white', 'Impedimento': 'bg-red-600 text-white' };
    window.statusHexColors = { 'A Fazer': '#f95f53', 'Em desenvolvimento': '#1f3bb3', 'Em andamento': '#1f3bb3', 'QA TI': '#1f3bb3', 'Em Teste': '#f97316', 'Concluído': '#1fdb84', 'Concluída': '#1fdb84', 'Backlog': '#9ca3af', 'Proposto': '#9ca3af', 'Aprovado': '#fbbf24', 'DOR': '#fbbf24', 'Definição de Pronto (DOR)': '#fbbf24', 'QA Negócio': '#f97316', 'Em refinamento': '#9ca3af', 'Impedimento': '#dc2626' };

    window.openPPTPreview = function() { const modal = document.getElementById('ppt-preview-modal'); if (modal) { window.renderPPTConfigList(); window.updatePPTPreviewUI(); modal.classList.remove('hidden'); } };
    window.renderPPTConfigList = function() { const list = document.getElementById('ppt-component-selector-list'); if (!list) return; const options = [{ id: 'total-stories', label: 'Histórias totais' }, { id: 'delivery-rate', label: 'Taxa de entrega' }, { id: 'not-delivered', label: 'Não entregues' }, { id: 'status-distribution', label: 'Distribuição por status' }, { id: 'featured-initiatives', label: 'Iniciativas em destaque' }, { id: 'featured-stories', label: 'Histórias em destaque' }, { id: 'deliveries', label: 'Entregas' }, { id: 'status-by-area', label: 'Status por área' }, { id: 'qa-business', label: 'QA negócio por área' }]; list.innerHTML = options.map(opt => `<label class="config-checkbox-item"><input type="checkbox" ${window.pptSelectedComponents[opt.id] ? 'checked' : ''} onchange="window.togglePPTComponent('${opt.id}', this.checked)"><span>${opt.label}</span></label>`).join(''); };
    window.togglePPTComponent = function(id, checked) { window.pptSelectedComponents[id] = checked; window.updatePPTPreviewUI(); };

    window.updatePPTPreviewUI = function() {
        const container = document.getElementById('ppt-preview-dynamic-content'); if (!container) return;
        const filters = window.dashboardGlobalFilters; const dir = filters.directorate || 'Todas'; const area = filters.area || 'Todas'; const po = filters.po || 'Todos';
        const filtS = window.stories.filter(s => { const areaCfg = window.configs.area.find(a => a.name === s.area); return (!filters.directorate || (areaCfg && areaCfg.directorate === filters.directorate)) && (!filters.area || s.area === filters.area) && (!filters.po || s.po === filters.po); });
        const fT = window.tasks.filter(t => { const s = window.stories.find(x => parseInt(x.id) === parseInt(t.storyId)); if (!s) return false; const areaCfg = window.configs.area.find(a => a.name === s.area); return (!filters.directorate || (areaCfg && areaCfg.directorate === filters.directorate)) && (!filters.area || s.area === filters.area) && (!filters.po || s.po === filters.po); });
        const total = filtS.length; const delSetS = window.getDeliveredStatusSet('stories'); const done = filtS.filter(s => delSetS.includes(s.status)).length; const deliveryRate = total ? Math.round(done/total*100) + '%' : '0%'; const notDelivered = total - done;

        let slidesHtml = '';
        if (window.pptSelectedComponents['total-stories'] || window.pptSelectedComponents['delivery-rate'] || window.pptSelectedComponents['not-delivered']) {
            let kpiList = '';
            if(window.pptSelectedComponents['total-stories']) kpiList += `<div class="bg-white p-6 rounded-lg border border-slate-200 text-center"><p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">Histórias Totais</p><p class="text-4xl font-extrabold text-[#1F3BB3]">${total}</p></div>`;
            if(window.pptSelectedComponents['delivery-rate']) kpiList += `<div class="bg-white p-6 rounded-lg border border-slate-200 text-center"><p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">Taxa de Entrega</p><p class="text-4xl font-extrabold text-[#1FDB84]">${deliveryRate}</p></div>`;
            if(window.pptSelectedComponents['not-delivered']) kpiList += `<div class="bg-white p-6 rounded-lg border border-slate-200 text-center"><p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">Não Entregues</p><p class="text-4xl font-extrabold text-[#f95f53]">${notDelivered}</p></div>`;
            slidesHtml += `<div class="slide-preview-container"><div class="flex justify-between items-start mb-8"><div><h2 class="!m-0 text-3xl">Performance</h2><p class="text-slate-400 font-bold text-sm">${dir} | ${area} | ${po}</p></div><div class="bg-blue-50 px-4 py-2 rounded text-[#1F3BB3] font-bold text-xs uppercase">Slide KPI</div></div><div class="grid grid-cols-3 gap-6">${kpiList}</div></div>`;
        }
        if (window.pptSelectedComponents['status-distribution']) {
            const statusValues = [filtS.filter(s => ['Backlog', 'Em refinamento', 'DOR', 'A fazer', 'Proposto'].includes(s.status)).length, filtS.filter(s => ['Em desenvolvimento', 'Impedimento', 'Em Andamento', 'Aprovado'].includes(s.status)).length, fT.filter(t => t.status === 'QA Negócio' || t.status === 'Em Teste' || t.status === 'QA TI').length, filtS.filter(s => delSetS.includes(s.status)).length];
            const maxVal = Math.max(...statusValues, 1); const labels = ['Backlog', 'Andamento', 'QA', 'Concluído']; const colors = ['#9ca3af', '#1F3BB3', '#f97316', '#1FDB84'];
            slidesHtml += `<div class="slide-preview-container"><div class="flex justify-between items-start mb-8"><div><h2 class="!m-0 text-3xl">Status</h2><p class="text-slate-400 font-bold text-sm">Visão geral</p></div><div class="bg-blue-50 px-4 py-2 rounded text-[#1F3BB3] font-bold text-xs uppercase">Slide Gráfico</div></div><div class="h-64 bg-white rounded-lg border p-10 flex items-end gap-10">${statusValues.map((v, i) => `<div class="flex-1 flex flex-col items-center gap-2"><div class="w-full rounded-t" style="height: ${(v/maxVal)*100}%; background: ${colors[i]}; min-height: 4px;"></div><p class="text-[9px] font-black text-slate-400 uppercase">${labels[i]}</p><p class="text-sm font-black text-slate-700">${v}</p></div>`).join('')}</div></div>`;
        }
        if (window.pptSelectedComponents['featured-initiatives'] || window.pptSelectedComponents['featured-stories']) {
            let featuresCol = '', storiesCol = '';
            if(window.pptSelectedComponents['featured-initiatives']) { const feats = window.features.filter(f => f.isFeatured && (!filters.directorate || f.directorate === filters.directorate)).slice(0,5); featuresCol = `<div class="bg-white rounded-lg border p-6 flex flex-col"><h4 class="text-[10px] font-black uppercase mb-4 tracking-widest text-slate-400">Iniciativas</h4><div class="space-y-3">${feats.map(f => `<div class="flex justify-between items-center"><span class="text-xs font-bold text-slate-700 truncate mr-4">${f.title}</span><span class="status-badge ${window.statusColors[f.status]} scale-90">${f.status}</span></div>`).join('') || '<p class="text-[10px] text-slate-300 italic">Sem registros</p>'}</div></div>`; }
            if(window.pptSelectedComponents['featured-stories']) { const stories = filtS.filter(s => s.isFeatured).slice(0,5); storiesCol = `<div class="bg-white rounded-lg border p-6 flex flex-col"><h4 class="text-[10px] font-black uppercase mb-4 tracking-widest text-slate-400">Histórias</h4><div class="space-y-3">${stories.map(s => `<div class="flex justify-between items-center"><span class="text-xs font-bold text-slate-700 truncate mr-4">${s.title}</span><span class="status-badge ${window.statusColors[s.status]} scale-90">${s.status}</span></div>`).join('') || '<p class="text-[10px] text-slate-300 italic">Sem registros</p>'}</div></div>`; }
            slidesHtml += `<div class="slide-preview-container"><div class="flex justify-between items-start mb-8"><div><h2 class="!m-0 text-3xl">Destaques</h2></div></div><div class="grid grid-cols-2 gap-8">${featuresCol} ${storiesCol}</div></div>`;
        }
        if (window.pptSelectedComponents['status-by-area']) {
            const areaMap = {}; filtS.forEach(s => areaMap[s.area] = (areaMap[s.area] || 0) + 1);
            const areas = Object.entries(areaMap).sort((a,b) => b[1] - a[1]).slice(0, 5); const maxA = Math.max(...areas.map(a => a[1]), 1);
            slidesHtml += `<div class="slide-preview-container"><div class="flex justify-between items-start mb-8"><div><h2 class="!m-0 text-3xl">Volume por Área</h2></div></div><div class="space-y-4 bg-white p-10 rounded-lg border">${areas.map(a => `<div class="space-y-1"><div class="flex justify-between text-[10px] font-black uppercase text-slate-400"><span>${a[0]}</span><span>${a[1]} histórias</span></div><div class="h-4 bg-slate-50 rounded-full overflow-hidden"><div class="h-full bg-indigo-500 rounded-full" style="width: ${(a[1]/maxA)*100}%"></div></div></div>`).join('')}</div></div>`;
        }
        if (window.pptSelectedComponents['qa-business']) {
            const qaDataMap = {}; fT.filter(t => t.status === 'QA Negócio' || t.status === 'Em Teste' || t.status === 'QA TI').forEach(t => { const s = window.stories.find(x => parseInt(x.id) === parseInt(t.storyId)); if (s && s.area) qaDataMap[s.area] = (qaDataMap[s.area] || 0) + 1; });
            const qaAreas = Object.entries(qaDataMap).sort((a,b) => b[1] - a[1]).slice(0, 5); const maxQA = Math.max(...qaAreas.map(a => a[1]), 1);
            slidesHtml += `<div class="slide-preview-container"><div class="flex justify-between items-start mb-8"><div><h2 class="!m-0 text-3xl">QA por Área</h2></div></div><div class="space-y-4 bg-white p-10 rounded-lg border">${qaAreas.map(a => `<div class="space-y-1"><div class="flex justify-between text-[10px] font-black uppercase text-slate-400"><span>${a[0]}</span><span>${a[1]} em QA</span></div><div class="h-4 bg-slate-50 rounded-full overflow-hidden"><div class="h-full bg-orange-400 rounded-full" style="width: ${(a[1]/maxQA)*100}%"></div></div></div>`).join('')}</div></div>`;
        }
        container.innerHTML = slidesHtml || '<div class="p-20 text-center text-slate-400 font-bold bg-white rounded-xl border border-dashed border-slate-300">Selecione componentes...</div>';
    };

    window.closePPTPreview = () => document.getElementById('ppt-preview-modal')?.classList.add('hidden');

    window.generatePPTReport = function() {
        if (!window.PptxGenJS) return;
        const pptx = new PptxGenJS(); const filters = window.dashboardGlobalFilters; const date = new Date().toLocaleDateString('pt-BR');
        const slideCapa = pptx.addSlide(); slideCapa.background = { fill: "F4F5F7" };
        slideCapa.addText("Relatório Gerencial - Scrum Pro", { x: 1, y: 2, w: 8, fontSize: 44, bold: true, color: "1F3BB3", align: "center" });
        slideCapa.addText(`Gerado em: ${date}`, { x: 1, y: 6.5, w: 8, fontSize: 12, italic: true, color: "a3a4a5", align: "center" });

        const filtS = window.stories.filter(s => { const areaCfg = window.configs.area.find(a => a.name === s.area); return (!filters.directorate || (areaCfg && areaCfg.directorate === filters.directorate)) && (!filters.area || s.area === filters.area) && (!filters.po || s.po === filters.po); });
        const fT = window.tasks.filter(t => { const s = window.stories.find(x => parseInt(x.id) === parseInt(t.storyId)); if (!s) return false; const areaCfg = window.configs.area.find(a => a.name === s.area); return (!filters.directorate || (areaCfg && areaCfg.directorate === filters.directorate)) && (!filters.area || s.area === filters.area) && (!filters.po || s.po === filters.po); });

        if (window.pptSelectedComponents['total-stories'] || window.pptSelectedComponents['delivery-rate'] || window.pptSelectedComponents['not-delivered']) {
            const slideKPI = pptx.addSlide(); slideKPI.addText("Performance e KPIs", { x: 0.5, y: 0.5, fontSize: 24, bold: true, color: "1F3BB3" });
            let posX = 0.5;
            ['total-stories', 'delivery-rate', 'not-delivered'].forEach(compId => {
                if (window.pptSelectedComponents[compId]) {
                    let label = compId === 'total-stories' ? 'Histórias Totais' : (compId === 'delivery-rate' ? 'Taxa de Entrega' : 'Não Entregues');
                    let val = compId === 'total-stories' ? filtS.length.toString() : (compId === 'delivery-rate' ? (filtS.length ? Math.round(filtS.filter(s => window.getDeliveredStatusSet('stories').includes(s.status)).length/filtS.length*100)+'%' : '0%') : (filtS.length - filtS.filter(s => window.getDeliveredStatusSet('stories').includes(s.status)).length).toString());
                    let color = compId === 'total-stories' ? '1F3BB3' : (compId === 'delivery-rate' ? '1FDB84' : 'f95f53');
                    slideKPI.addShape(pptx.ShapeType.rect, { x: posX, y: 1.5, w: 2.8, h: 1.5, fill: { color: "FFFFFF" }, line: { color: "e5e7eb" } });
                    slideKPI.addText(label, { x: posX, y: 1.7, w: 2.8, fontSize: 14, align: "center", color: "6c757d" });
                    slideKPI.addText(val, { x: posX, y: 2.2, w: 2.8, fontSize: 32, bold: true, align: "center", color: color });
                    posX += 3.1;
                }
            });
        }

        // Gráfico de Distribuição por Status
        if (window.pptSelectedComponents['status-distribution']) {
            const slideDist = pptx.addSlide(); slideDist.addText("Distribuição por Status", { x: 0.5, y: 0.5, fontSize: 24, bold: true, color: "1F3BB3" });
            const ord = ["Backlog", "Andamento", "QA", "Concluído"];
            const vals = [filtS.filter(s => ['Backlog', 'Em refinamento', 'DOR', 'A fazer', 'Proposto'].includes(s.status)).length, filtS.filter(s => ['Em desenvolvimento', 'Impedimento', 'Em Andamento', 'Aprovado'].includes(s.status)).length, fT.filter(t => t.status === 'QA Negócio' || t.status === 'Em Teste' || t.status === 'QA TI').length, filtS.filter(s => window.getDeliveredStatusSet('stories').includes(s.status)).length];
            const dataChart = [{ name: 'Status', labels: ord, values: vals }];
            slideDist.addChart(pptx.ChartType.bar, dataChart, { x: 0.5, y: 1.2, w: 9, h: 5, barDir: 'col', chartColors: ['9ca3af', '1F3BB3', 'f97316', '1FDB84'], showValue: true });
        }

        if (window.pptSelectedComponents['featured-initiatives']) {
            const slideFeat = pptx.addSlide(); slideFeat.addText("Iniciativas em Destaque", { x: 0.5, y: 0.5, fontSize: 24, bold: true, color: "1F3BB3" });
            const feats = window.features.filter(f => f.isFeatured && (!filters.directorate || f.directorate === filters.directorate));
            if(feats.length) { const tData = [["Iniciativa", "Diretoria", "Status"]]; feats.slice(0, 10).forEach(f => tData.push([f.title, f.directorate, f.status])); slideFeat.addTable(tData, { x: 0.5, y: 1.2, w: 9, border: { type: "solid", color: "F1F3F9" }, fontSize: 10 }); }
        }

        if (window.pptSelectedComponents['featured-stories']) {
            const slideS = pptx.addSlide(); slideS.addText("Histórias em Destaque", { x: 0.5, y: 0.5, fontSize: 24, bold: true, color: "1F3BB3" });
            const stories = filtS.filter(s => s.isFeatured);
            if(stories.length) { const tData = [["História", "Área", "Status"]]; stories.slice(0, 10).forEach(s => tData.push([s.title, s.area, s.status])); slideS.addTable(tData, { x: 0.5, y: 1.2, w: 9, border: { type: "solid", color: "F1F3F9" }, fontSize: 10 }); }
        }

        // Gráfico Status por Área
        if (window.pptSelectedComponents['status-by-area']) {
            const slideArea = pptx.addSlide(); slideArea.addText("Volume por Área Operacional", { x: 0.5, y: 0.5, fontSize: 24, bold: true, color: "1F3BB3" });
            const map = {}; filtS.forEach(s => map[s.area] = (map[s.area] || 0) + 1);
            const dataChart = [{ name: 'Áreas', labels: Object.keys(map), values: Object.values(map) }];
            slideArea.addChart(pptx.ChartType.bar, dataChart, { x: 0.5, y: 1.2, w: 9, h: 5, barDir: 'bar', chartColors: ['1F3BB3'], showValue: true });
        }

        // Gráfico QA por Área
        if (window.pptSelectedComponents['qa-business']) {
            const slideQA = pptx.addSlide(); slideQA.addText("QA Negócio por Área", { x: 0.5, y: 0.5, fontSize: 24, bold: true, color: "1F3BB3" });
            const map = {}; fT.filter(t => t.status === 'QA Negócio' || t.status === 'Em Teste' || t.status === 'QA TI').forEach(t => { const s = window.stories.find(x => parseInt(x.id) === parseInt(t.storyId)); if (s && s.area) map[s.area] = (map[s.area] || 0) + 1; });
            const dataChart = [{ name: 'QA', labels: Object.keys(map), values: Object.values(map) }];
            slideQA.addChart(pptx.ChartType.bar, dataChart, { x: 0.5, y: 1.2, w: 9, h: 5, barDir: 'bar', chartColors: ['f97316'], showValue: true });
        }

        pptx.writeFile({ fileName: `Report_ScrumPro_${date.replace(/\//g, '-')}.pptx` });
    };

    Chart.register(ChartDataLabels);
    function getContrastColor(hex) { if (!hex || hex === 'transparent') return '#3e4b5b'; if (hex.indexOf('#') === 0) hex = hex.slice(1); if (hex.length === 3) hex = hex[0] + hex[0] + hex[1] + hex[1] + hex[2] + hex[2]; if (hex.length !== 6) return '#3e4b5b'; var r = parseInt(hex.slice(0, 2), 16), g = parseInt(hex.slice(2, 4), 16), b = parseInt(hex.slice(4, 6), 16); var yiq = ((r * 299) + (g * 587) + (b * 114)) / 1000; return (yiq >= 128) ? '#000000' : '#ffffff'; }
    window.generateId = () => Date.now() + Math.floor(Math.random() * 1000);
    window.showModal = (title, body, actions) => { const modal = document.getElementById('message-modal'); if (!modal) return; document.getElementById('modal-title').textContent = title; document.getElementById('modal-body').textContent = body; document.getElementById('modal-actions').innerHTML = actions; modal.classList.remove('hidden'); };
    window.closeModal = () => document.getElementById('message-modal')?.classList.add('hidden');

    window.showView = (v) => {
        window.selectedIds.features.clear(); window.selectedIds.stories.clear(); window.selectedIds.tasks.clear(); window.selectedIds.tasks_view.clear();
        document.querySelectorAll('.view').forEach(el => el.classList.add('hidden')); document.getElementById(`${v}-view`)?.classList.remove('hidden');
        document.querySelectorAll('.nav-btn, .submenu-item').forEach(b => b.classList.remove('active')); document.getElementById(`nav-${v}`)?.classList.add('active');
        if(['feature', 'stories', 'tasks_view'].includes(v)) document.getElementById('parent-registrar')?.classList.add('active');
        if(v === 'configs') document.getElementById('parent-configs')?.classList.add('active');
        const dashFilters = document.getElementById('header-dashboard-filters'); dashFilters.classList.add('hidden');
        if(v === 'dashboard') { dashFilters.classList.remove('hidden'); window.renderDashboard(); } else if(v === 'feature') { window.populateViewFilters('features'); window.renderFeatures(); } else if(v === 'stories') { window.populateViewFilters('stories'); window.renderStories(); } else if(v === 'tasks_view') { window.populateViewFilters('tasks_view'); window.renderTasksView(); } else if(v === 'configs') { window.renderConfigLists(); } else if(v === 'import') { window.renderConfigLists(); window.renderImportCards(); }
    };

    window.toggleSubmenu = (id) => { document.getElementById(`submenu-${id}`)?.classList.toggle('hidden'); document.getElementById(`arrow-${id}`)?.classList.toggle('rotate-180'); };
    window.openFeatureForm = (feat = null) => { const container = document.getElementById('feature-form-container'); if (!container) return; document.getElementById('feature-form').reset(); window.populateSelects(); if (feat) { document.getElementById('feature-id').value = feat.id; document.getElementById('feature-doc-id').value = feat._docId; document.getElementById('feature-external-id').value = feat.externalId || ''; document.getElementById('feature-title').value = feat.title || ''; document.getElementById('feature-directorate').value = feat.directorate || ''; document.getElementById('feature-po').value = feat.po || ''; document.getElementById('feature-status').value = feat.status || ''; document.getElementById('feature-external-link').value = feat.externalLink || ''; document.getElementById('feature-description').value = feat.description || ''; document.getElementById('feature-is-featured').checked = !!feat.isFeatured; document.getElementById('feature-priority').value = feat.priority || ''; } else { document.getElementById('feature-id').value = window.generateId(); document.getElementById('feature-doc-id').value = ''; } container.classList.remove('hidden'); };
    window.openStoryForm = (story = null) => { const container = document.getElementById('story-form-container'); if (!container) return; document.getElementById('story-form').reset(); window.populateSelects(); const featureSelect = document.getElementById('story-feature'); if (featureSelect) featureSelect.innerHTML = '<option value="">Nenhuma feature associada</option>' + window.features.map(f => `<option value="${f.id}">${f.title} (#${f.externalId || '?'})</option>`).join(''); if (story) { document.getElementById('story-id').value = story.id; document.getElementById('story-doc-id').value = story._docId; document.getElementById('story-external-id').value = story.externalId || ''; document.getElementById('story-title').value = story.title || ''; document.getElementById('story-area').value = story.area || ''; document.getElementById('story-po').value = story.po || ''; document.getElementById('story-status').value = story.status || ''; document.getElementById('story-external-link').value = story.externalLink || ''; document.getElementById('story-is-featured').checked = !!story.isFeatured; document.getElementById('story-description').value = story.description || ''; document.getElementById('story-priority').value = story.priority || ''; if (featureSelect) featureSelect.value = story.featureId || ''; } else { document.getElementById('story-id').value = window.generateId(); document.getElementById('story-doc-id').value = ''; } container.classList.remove('hidden'); };
    window.closeStoryForm = () => document.getElementById('story-form-container')?.classList.add('hidden');
    window.openStoryTasksModal = (id) => { window._lastTaskModalStoryId = id; const modal = document.getElementById('task-list-modal'); if (modal) { modal.classList.remove('hidden'); window.renderTasksInModal(id); } };
    window.closeStoryTasksModal = () => document.getElementById('task-list-modal')?.classList.add('hidden');
    window.openFeatureStoriesModal = (id) => { window._lastFeatureModalId = id; const modal = document.getElementById('feature-stories-modal'); if (modal) { modal.classList.remove('hidden'); window.renderStoriesInModal(id); } };
    window.closeFeatureStoriesModal = () => document.getElementById('feature-stories-modal')?.classList.add('hidden');

    window.renderStoriesInModal = (featId) => { const b = document.getElementById('feature-stories-modal-table-body'); if (!b) return; const filtered = window.stories.filter(s => parseInt(s.featureId) === parseInt(featId)); b.innerHTML = filtered.length ? filtered.map(s => `<tr><td class="table-id text-center">#${s.externalId || '-'}</td><td class="table-title font-normal text-xs text-slate-600">${s.title}</td><td class="font-bold text-[10px] text-slate-500">${s.area || '-'}</td><td class="text-center"><span class="status-badge ${window.statusColors[s.status] || 'bg-gray-100'} shadow-sm">${s.status}</span></td></tr>`).join('') : '<tr><td colspan="4" class="p-10 text-center text-gray-400 text-xs font-bold">Sem histórias vinculadas</td></tr>'; };
    window.openTaskForm = (targetStoryId = null) => { const container = document.getElementById('task-modal'); if (!container) return; document.getElementById('task-form').reset(); window.populateSelects(); document.getElementById('task-id').value = window.generateId(); document.getElementById('task-doc-id').value = ''; const searchInput = document.getElementById('task-story-search-input'); const hiddenId = document.getElementById('task-story-assoc-id'); if (targetStoryId) { const s = window.stories.find(x => parseInt(x.id) === parseInt(targetStoryId)); if (s) { searchInput.value = s.title + " (#" + (s.externalId || '?') + ")"; hiddenId.value = s.id; } } else { searchInput.value = ""; hiddenId.value = ""; } container.classList.remove('hidden'); };
    window.editTask = (taskId) => { const task = window.tasks.find(t => parseInt(t.id) === parseInt(taskId)); if (!task) return; const container = document.getElementById('task-modal'); if (!container) return; document.getElementById('task-form').reset(); window.populateSelects(); document.getElementById('task-id').value = task.id; document.getElementById('task-doc-id').value = task._docId; const s = window.stories.find(x => parseInt(x.id) === parseInt(task.storyId)); const searchInput = document.getElementById('task-story-search-input'); const hiddenId = document.getElementById('task-story-assoc-id'); if (s) { searchInput.value = s.title + " (#" + (s.externalId || '?') + ")"; hiddenId.value = s.id; } document.getElementById('task-external-id').value = task.externalId || ''; document.getElementById('task-gmud-id').value = task.gmudId || ''; document.getElementById('task-title').value = task.title || ''; document.getElementById('task-status').value = task.status || ''; document.getElementById('task-system').value = task.system || ''; document.getElementById('task-techlead').value = task.techlead || ''; document.getElementById('task-developer').value = task.developer || ''; document.getElementById('task-external-link').value = task.externalLink || ''; document.getElementById('task-description').value = task.description || ''; container.classList.remove('hidden'); };
    window.renderStorySearchResults = (filter = "") => { const resultsDiv = document.getElementById('task-story-search-results'); if(!resultsDiv) return; const lowerFilter = filter.toLowerCase().trim(); const filtered = window.stories.filter(s => s.title.toLowerCase().includes(lowerFilter) || (s.externalId && s.externalId.toString().includes(lowerFilter))); resultsDiv.innerHTML = filtered.length ? filtered.map(s => `<div class="search-result-item" onclick="window.selectStoryInSearch('${s.id}', '${s.title.replace(/'/g, "\\'")}', '${s.externalId || '?'}')"><div class="text-[11px] font-bold text-slate-800">${s.title}</div><div class="flex items-center gap-2 mt-0.5"><span class="text-[9px] font-mono text-indigo-600 bg-indigo-50 px-1.5 rounded">#${s.externalId || '-'}</span><span class="text-[9px] text-gray-400 font-black tracking-widest">${s.area || 'Sem área'}</span></div></div>`).join('') : '<div class="p-4 text-center text-xs text-gray-400 italic">Nenhuma história encontrada</div>'; resultsDiv.classList.remove('hidden'); };
    window.selectStoryInSearch = (id, title, extId) => { document.getElementById('task-story-search-input').value = `${title} (#${extId})`; document.getElementById('task-story-assoc-id').value = id; document.getElementById('task-story-search-results').classList.add('hidden'); };
    window.populateSelects = () => { const selects = { 'story-area': 'area', 'story-po': 'po', 'story-status': 'statusStory', 'feature-directorate': 'directorate', 'feature-po': 'po', 'feature-status': 'statusFeature', 'feature-priority': 'priorityFeature', 'story-priority': 'priorityStory', 'task-status': 'statusTask', 'task-system': 'system', 'task-techlead': 'techlead', 'task-developer': 'developer' }; Object.entries(selects).forEach(([id, configKey]) => { const el = document.getElementById(id); if (!el) return; const options = (window.configs[configKey] || []).filter(c => c.isActive); el.innerHTML = '<option value="">Selecionar...</option>' + options.map(o => `<option value="${o.name}">${o.name}</option>`).join(''); }); };
    window.handleGlobalFilterChange = () => { const prevDir = window.dashboardGlobalFilters.directorate; window.dashboardGlobalFilters.directorate = document.getElementById('dashboard-global-filter-directorate')?.value || ''; window.dashboardGlobalFilters.area = document.getElementById('dashboard-global-filter-area')?.value || ''; window.dashboardGlobalFilters.po = document.getElementById('dashboard-global-filter-po')?.value || ''; if (prevDir !== window.dashboardGlobalFilters.directorate) { window.dashboardGlobalFilters.area = ''; document.getElementById('dashboard-global-filter-area').value = ''; window.populateGlobalAreaOptions(); } window.renderDashboard(); };
    window.populateGlobalAreaOptions = () => { const areaSelect = document.getElementById('dashboard-global-filter-area'); if (!areaSelect) return; const dir = window.dashboardGlobalFilters.directorate; const areas = (window.configs.area || []).filter(a => a.isActive && (!dir || a.directorate === dir)); areaSelect.innerHTML = '<option value="">Todas as Áreas</option>' + areas.map(c => `<option value="${c.name}">${c.name}</option>`).join(''); };
    window.handleViewFilterChange = (ty) => { if (ty === 'features') { window.viewFilters.features.po = document.getElementById('filter-feature-po')?.value || ''; window.viewFilters.features.status = document.getElementById('filter-feature-status')?.value || ''; window.renderFeatures(); } else if (ty === 'stories') { window.viewFilters.stories.area = document.getElementById('filter-story-area')?.value || ''; window.viewFilters.stories.po = document.getElementById('filter-story-po')?.value || ''; window.viewFilters.stories.status = document.getElementById('filter-story-status')?.value || ''; window.viewFilters.stories.search = document.getElementById('filter-story-search')?.value || ''; window.renderStories(); } else if (ty === 'tasks_view') { window.viewFilters.tasks_view.status = document.getElementById('filter-tasks-status')?.value || ''; window.viewFilters.tasks_view.system = document.getElementById('filter-tasks-system')?.value || ''; window.viewFilters.tasks_view.techlead = document.getElementById('filter-tasks-techlead')?.value || ''; window.viewFilters.tasks_view.search = document.getElementById('filter-tasks-search')?.value || ''; window.renderTasksView(); } };
    window.handlePageSizeChange = (size) => { window.pageSizeTasks = parseInt(size); window.renderTasksView(); };
    window.handlePageSizeStoriesChange = (size) => { window.pageSizeStories = parseInt(size); window.renderStories(); };
    window.handlePageSizeFeaturesChange = (size) => { window.pageSizeFeatures = parseInt(size); window.renderFeatures(); };
    window.populateViewFilters = (view) => { const curA = window.configs.area || []; const curP = window.configs.po || []; if (view === 'features') { document.getElementById('filter-feature-po').innerHTML = '<option value="">Filtrar PO...</option>' + curP.filter(c => c.isActive).map(c => `<option value="${c.name}">${c.name}</option>`).join(''); document.getElementById('filter-feature-status').innerHTML = '<option value="">Filtrar status...</option>' + (window.configs.statusFeature || []).filter(c => c.isActive).map(c => `<option value="${c.name}">${c.name}</option>`).join(''); } else if (view === 'stories') { document.getElementById('filter-story-area').innerHTML = '<option value="">Filtrar área...</option>' + curA.filter(c => c.isActive).map(c => `<option value="${c.name}">${c.name}</option>`).join(''); document.getElementById('filter-story-po').innerHTML = '<option value="">Filtrar PO...</option>' + curP.filter(c => c.isActive).map(c => `<option value="${c.name}">${c.name}</option>`).join(''); document.getElementById('filter-story-status').innerHTML = '<option value="">Filtrar status...</option>' + (window.configs.statusStory || []).filter(c => c.isActive).map(c => `<option value="${c.name}">${c.name}</option>`).join(''); } else if (view === 'tasks_view') { document.getElementById('filter-tasks-status').innerHTML = '<option value="">Filtrar status...</option>' + (window.configs.statusTask || []).filter(c => c.isActive).map(c => `<option value="${c.name}">${c.name}</option>`).join(''); document.getElementById('filter-tasks-system').innerHTML = '<option value="">Filtrar sistema...</option>' + (window.configs.system || []).filter(c => c.isActive).map(c => `<option value="${c.name}">${c.name}</option>`).join(''); document.getElementById('filter-tasks-techlead').innerHTML = '<option value="">Filtrar tech lead...</option>' + (window.configs.techlead || []).filter(c => c.isActive).map(c => `<option value="${c.name}">${c.name}</option>`).join(''); } };
    window.clearGlobalFilters = () => { window.dashboardGlobalFilters = { directorate: '', area: '', po: '' }; document.getElementById('dashboard-global-filter-directorate').value = ''; document.getElementById('dashboard-global-filter-area').value = ''; document.getElementById('dashboard-global-filter-po').value = ''; window.populateGlobalAreaOptions(); window.renderDashboard(); };
    window.toggleAreaDropdown = () => document.getElementById('area-dropdown-list')?.classList.toggle('hidden');
    window.getDeliveredStatusSet = (t) => { const dc = (window.configs.deliveryConfigs && window.configs.deliveryConfigs[0]) || { storyStatuses: ["Concluído", "Concluída"], taskStatuses: ["Concluído", "Concluída"] }; const baseSet = t === 'stories' ? dc.storyStatuses : dc.taskStatuses; const resultSet = [...baseSet]; if (resultSet.includes("Concluído") && !resultSet.includes("Concluída")) resultSet.push("Concluída"); if (resultSet.includes("Concluída") && !resultSet.includes("Concluído")) resultSet.push("Concluído"); return resultSet; };
    window.getStoryProg = (id) => { const ts = window.tasks.filter(t => parseInt(t.storyId) === parseInt(id)); const dSet = window.getDeliveredStatusSet('tasks'); return { total: ts.length, done: ts.filter(t => dSet.includes(t.status)).length }; };
    window.getFeatureProg = (featId) => { const associatedStories = window.stories.filter(s => parseInt(s.featureId) === parseInt(featId)); const dSet = window.getDeliveredStatusSet('stories'); return { total: associatedStories.length, done: associatedStories.filter(s => dSet.includes(s.status)).length }; };
    window.handleDeliveriesTypeChange = (val) => { window.deliveriesFilterStoryId = null; window.renderCompletedInitiatives(); };
    window.drillDownToStoryTasks = (storyId) => { window.deliveriesFilterStoryId = parseInt(storyId); const select = document.getElementById('initiatives-type'); if (select) select.value = 'tasks'; window.renderCompletedInitiatives(); };
    window.clearDeliveriesDrillDown = () => { window.deliveriesFilterStoryId = null; const select = document.getElementById('initiatives-type'); if (select) select.value = 'stories'; window.renderCompletedInitiatives(); };

    window.renderDashboard = () => {
        const sum = document.getElementById('dashboard-summary'); if(!sum) return; window.populateGlobalFilters(); window.populateDateFilters(); const dir = window.dashboardGlobalFilters.directorate; const area = window.dashboardGlobalFilters.area; const po = window.dashboardGlobalFilters.po;
        const filtS = window.stories.filter(s => { const areaCfg = window.configs.area.find(a => a.name === s.area); return (!dir || (areaCfg && areaCfg.directorate === dir)) && (!area || s.area === area) && (!po || s.po === po); });
        const total = filtS.length; const delSetS = window.getDeliveredStatusSet('stories'); const done = filtS.filter(s => delSetS.includes(s.status)).length;
        sum.innerHTML = [{ label: 'Histórias totais', val: total, color: 'text-[#1F3BB3]', bg: 'bg-blue-50' }, { label: 'Taxa de entrega', val: total ? Math.round(done/total*100) + '%' : '0%', color: 'text-[#1FDB84]', bg: 'bg-green-50' }, { label: 'Não entregues', val: total ? (Math.round(((total - done) / total) * 100)) + '%' : '0%', color: 'text-[#f95f53]', bg: 'bg-red-50' }].map(m => `<div class="card p-5 border-0 shadow-sm"><p class="text-[9px] font-black text-slate-400 mb-1 tracking-widest">${m.label}</p><div class="flex items-center justify-between"><p class="text-xl font-bold ${m.color}">${m.val}</p><div class="w-8 h-8 rounded ${m.bg} flex items-center justify-center"><span class="w-1.5 h-1.5 rounded-full ${m.color.replace('text-', 'bg-')}"></span></div></div></div>`).join('');
        window.renderAreaSelector(); window.updateCharts(); window.renderFeaturedFeatures(); window.renderFeaturedStories(); window.renderCompletedInitiatives();
    };

    window.populateDateFilters = () => { const monS = document.getElementById('filter-done-month'), yrS = document.getElementById('filter-done-year'); if(!monS || !yrS) return; const curM = monS.value !== "" ? monS.value : new Date().getMonth(), curY = yrS.value !== "" ? yrS.value : new Date().getFullYear(); if (monS.options.length === 0) monS.innerHTML = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"].map((m, i) => `<option value="${i}" ${parseInt(curM) === i ? 'selected' : ''}>${m}</option>`).join(''); const configuredYears = (window.configs.year || []).filter(y => y.isActive).map(y => parseInt(y.name)).sort((a,b) => b-a); if(configuredYears.length === 0) configuredYears.push(new Date().getFullYear()); yrS.innerHTML = configuredYears.map(y => `<option value="${y}" ${parseInt(curY) === y ? 'selected' : ''}>${y}</option>`).join(''); };
    window.updateCharts = () => {
        const dir = window.dashboardGlobalFilters.directorate, area = window.dashboardGlobalFilters.area, po = window.dashboardGlobalFilters.po;
        const fS = window.stories.filter(s => { const areaCfg = window.configs.area.find(a => a.name === s.area); return (!dir || (areaCfg && areaCfg.directorate === dir)) && (!area || s.area === area) && (!po || s.po === po); });
        const fT = window.tasks.filter(t => { const s = window.stories.find(x => parseInt(x.id) === parseInt(t.storyId)); if (!s) return false; const areaCfg = window.configs.area.find(a => a.name === s.area); return (!dir || (areaCfg && areaCfg.directorate === dir)) && (!area || s.area === area) && (!po || s.po === po); });
        const ctxG = document.getElementById('chart-status-groups')?.getContext('2d'); if(ctxG) { if(window.charts.statusGroups) window.charts.statusGroups.destroy(); const statusValues = [fS.filter(s => ['Backlog', 'Em refinamento', 'DOR', 'A fazer', 'Proposto'].includes(s.status)).length, fS.filter(s => ['Em desenvolvimento', 'Impedimento', 'Em Andamento', 'Aprovado'].includes(s.status)).length, fT.filter(t => t.status === 'QA Negócio' || t.status === 'Em Teste' || t.status === 'QA TI').length, fS.filter(s => window.getDeliveredStatusSet('stories').includes(s.status)).length]; window.charts.statusGroups = new Chart(ctxG, { type: 'bar', data: { labels: ['Backlog', 'Em andamento', 'QA teste', 'Concluídos'], datasets: [{ data: statusValues, backgroundColor: ['#9ca3af', '#1F3BB3', '#f97316', '#1FDB84'], borderRadius: 3, barThickness: 35 }] }, options: { maintainAspectRatio: false, plugins: { legend: { display: false }, datalabels: { color: context => getContrastColor(context.dataset.backgroundColor[context.dataIndex]), anchor: 'center', align: 'center', formatter: Math.round, font: { weight: 'bold', size: 10 }, display: context => context.dataset.data[context.dataIndex] > 0 } }, scales: { y: { beginAtZero: true } } } }); }
        const ctxA = document.getElementById('chart-status-area')?.getContext('2d'); if(ctxA) { if(window.charts.statusArea) window.charts.statusArea.destroy(); const activeAreas = (window.configs.area || []).filter(a => a.isActive && (!dir || a.directorate === dir)).map(a => a.name); const aGraf = window.dashboardSelectedAreas.size > 0 ? Array.from(window.dashboardSelectedAreas) : activeAreas; const filtA = fS.filter(s => aGraf.includes(s.area)); const ord = ["Backlog", "Em refinamento", "Definição de Pronto (DOR)", "A Fazer", "Em desenvolvimento", "Impedimento", "Concluído"]; window.charts.statusArea = new Chart(ctxA, { type: 'bar', data: { labels: ord, datasets: [{ data: ord.map(st => filtA.filter(s => (s.status||'').toLowerCase() === st.toLowerCase()).length), backgroundColor: ord.map(s => window.statusHexColors[s] || '#1F3BB3'), borderRadius: 3, barThickness: 12 }] }, options: { maintainAspectRatio: false, indexAxis: 'y', plugins: { legend: { display: false }, datalabels: { color: context => getContrastColor(context.dataset.backgroundColor[context.dataIndex]), anchor: 'center', align: 'center', formatter: Math.round, font: { weight: 'bold', size: 9 }, display: context => context.dataset.data[context.dataIndex] > 0 } } } }); }
        const ctxQ = document.getElementById('chart-qa-area')?.getContext('2d'); if(ctxQ) { if(window.charts.qaArea) window.charts.qaArea.destroy(); const activeAreas = (window.configs.area || []).filter(a => a.isActive && (!dir || a.directorate === dir)).map(a => a.name); const rawData = activeAreas.map(a => ({ name: a, count: fT.filter(t => (t.status === 'QA Negócio' || t.status === 'Em Teste' || t.status === 'QA TI') && window.stories.find(s => parseInt(s.id) === parseInt(t.storyId) && s.area === a)).length })); const filteredData = rawData.filter(d => d.count > 0); window.charts.qaArea = new Chart(ctxQ, { type: 'doughnut', data: { labels: filteredData.map(d => d.name), datasets: [{ data: filteredData.map(d => d.count), backgroundColor: ['#1F3BB3', '#1FDB84', '#ffaf00', '#f95f53', '#05C283', '#818cf8', '#f472b6', '#fb923c'], borderWeight: 0 }] }, options: { maintainAspectRatio: false, cutout: '70%', plugins: { legend: { position: 'right', labels: { boxWidth: 10, font: { size: 10 } } }, datalabels: { color: context => getContrastColor(context.dataset.backgroundColor[context.dataIndex]), font: { weight: 'bold', size: 10 }, formatter: val => val, display: true } } } }); }
    };

    window.renderAreaSelector = () => { const list = document.getElementById('area-dropdown-list'); if(!list) return; const dir = window.dashboardGlobalFilters.directorate; const activeAreas = (window.configs.area || []).filter(a => a.isActive && (!dir || a.directorate === dir)).map(a => a.name); const allSel = activeAreas.length > 0 && activeAreas.every(a => window.dashboardSelectedAreas.has(a)); let h = `<label class="area-dropdown-item flex items-center p-2 border-b border-gray-50 text-[9px] font-black"><input type="checkbox" ${allSel ? 'checked' : ''} onchange="window.toggleAllDashboardAreas(this.checked)"><span class="ml-2">Tudo</span></label>`; h += activeAreas.map(a => `<label class="area-dropdown-item flex items-center p-2 text-[11px] hover:bg-gray-50 cursor-pointer"><input type="checkbox" value="${a}" ${window.dashboardSelectedAreas.has(a) ? 'checked' : ''} onchange="window.toggleDashboardArea('${a}', this.checked); event.stopPropagation();"><span class="ml-2">${a}</span></label>`).join(''); list.innerHTML = h; window.updateDashboardAreaTags(); document.getElementById('selected-areas-label').textContent = window.dashboardSelectedAreas.size === 0 ? "Filtrar áreas..." : (allSel ? "Todas áreas" : `${window.dashboardSelectedAreas.size} sel.`); };
    window.toggleAllDashboardAreas = (chk) => { const dir = window.dashboardGlobalFilters.directorate, act = (window.configs.area || []).filter(a => a.isActive && (!dir || a.directorate === dir)).map(a => a.name); if(chk) act.forEach(a => window.dashboardSelectedAreas.add(a)); else window.dashboardSelectedAreas.clear(); window.renderAreaSelector(); window.updateCharts(); };
    window.toggleDashboardArea = (a, chk) => { if(chk) window.dashboardSelectedAreas.add(a); else window.dashboardSelectedAreas.delete(a); window.renderAreaSelector(); window.updateCharts(); };
    window.updateDashboardAreaTags = () => { const cont = document.getElementById('dashboard-area-tags'); if(!cont) return; const dir = window.dashboardGlobalFilters.directorate, act = (window.configs.area || []).filter(a => a.isActive && (!dir || a.directorate === dir)).map(a => a.name); cont.innerHTML = Array.from(window.dashboardSelectedAreas).filter(a => act.includes(a)).map(a => `<div class="area-tag !bg-white !border-slate-200 !text-slate-500 shadow-sm">${a}<button onclick="window.toggleDashboardArea('${a}', false)" class="ml-1">✕</button></div>`).join(''); };
    window.renderFeaturedFeatures = () => { const b = document.getElementById('featured-features-body'); if(!b) return; const dir = window.dashboardGlobalFilters.directorate, po = window.dashboardGlobalFilters.po; let filtered = window.features.filter(f => f.isFeatured && (!dir || f.directorate === dir) && (!po || f.po === po)); b.innerHTML = filtered.length ? filtered.map(f => { const p = window.getFeatureProg(f.id); return `<tr><td>${f.title}</td><td class="font-bold text-[9px] text-slate-400">${f.directorate || '-'}</td><td class="font-bold text-slate-600">${f.po || '-'}</td><td class="text-center font-bold text-slate-700">${f.priority || '-'}</td><td class="text-center"><span class="status-badge ${window.statusColors[f.status] || 'bg-gray-100'}">${f.status}</span></td><td class="text-center"><div class="flex items-center justify-center gap-2"><div class="completion-bar"><div class="completion-fill bg-indigo-600" style="width: ${p.total ? (p.done/p.total*100) : 0}%"></div></div><span class="text-[9px] font-black text-indigo-700 cursor-pointer" onclick="window.openFeatureStoriesModal(${f.id})">${p.done}/${p.total}</span></div></td></tr>`; }).join('') : '<tr><td colspan="6" class="p-10 text-center text-gray-400 text-xs font-bold">Sem iniciativas...</td></tr>'; };
    window.renderFeaturedStories = () => { const b = document.getElementById('featured-stories-body'); if(!b) return; const dir = window.dashboardGlobalFilters.directorate, area = window.dashboardGlobalFilters.area, po = window.dashboardGlobalFilters.po; const fS = window.stories.filter(s => { const areaCfg = window.configs.area.find(a => a.name === s.area); return s.isFeatured && (!dir || (areaCfg && areaCfg.directorate === dir)) && (!area || s.area === area) && (!po || s.po === po); }); b.innerHTML = fS.length ? fS.map(s => { const p = window.getStoryProg(s.id); return `<tr><td>${s.title}</td><td class="font-bold text-[9px] text-slate-400">${s.area}</td><td class="font-bold text-slate-600">${s.po || '-'}</td><td class="text-center font-bold text-slate-700">${s.priority || '-'}</td><td class="text-center"><span class="status-badge ${window.statusColors[s.status] || 'bg-gray-100'}">${s.status}</span></td><td class="text-center"><div class="flex items-center justify-center gap-2"><div class="completion-bar"><div class="completion-fill bg-blue-600" style="width: ${p.total ? (p.done/p.total*100) : 0}%"></div></div><span class="text-[9px] font-black text-blue-700 cursor-pointer" onclick="window.openStoryTasksModal(${s.id})">${p.done}/${p.total}</span></div></td></tr>`; }).join('') : '<tr><td colspan="6" class="p-10 text-center text-gray-400 text-xs font-bold">Sem histórias...</td></tr>'; };
    window.renderCompletedInitiatives = () => { const tyE = document.getElementById('initiatives-type'); if(!tyE) return; const ty = tyE.value, mon = parseInt(document.getElementById('filter-done-month')?.value || new Date().getMonth()), yr = parseInt(document.getElementById('filter-done-year')?.value || new Date().getFullYear()), b = document.getElementById('done-tasks-list-body'), h = document.getElementById('initiatives-header'), backBtn = document.getElementById('deliveries-back-button-container'), dSet = window.getDeliveredStatusSet(ty), dir = window.dashboardGlobalFilters.directorate, area = window.dashboardGlobalFilters.area, po = window.dashboardGlobalFilters.po; if (ty === 'tasks') { h.innerHTML = '<th>Data</th><th>Tarefa</th><th>Sistema</th>'; if (window.deliveriesFilterStoryId) backBtn.classList.remove('hidden'); else backBtn.classList.add('hidden'); const f = window.tasks.filter(t => { const s = window.stories.find(x => parseInt(x.id) === parseInt(t.storyId)); if (!s) return false; const areaCfg = window.configs.area.find(a => a.name === s.area); return (!dir || (areaCfg && areaCfg.directorate === dir)) && (!area || s.area === area) && (!po || s.po === po) && (!window.deliveriesFilterStoryId || parseInt(t.storyId) === window.deliveriesFilterStoryId) && dSet.includes(t.status) && t.updatedAt && new Date(t.updatedAt).getMonth() === mon && new Date(t.updatedAt).getFullYear() === yr; }); b.innerHTML = f.length ? f.map(t => `<tr><td>${new Date(t.updatedAt).toLocaleDateString('pt-BR')}</td><td>${t.title}</td><td class="font-bold text-[9px] text-[#1FDB84]">${t.system || '-'}</td></tr>`).join('') : '<tr><td colspan="3" class="p-8 text-center text-gray-300 text-xs italic">Nenhuma entrega...</td></tr>'; } else { h.innerHTML = '<th>Data</th><th>História</th><th>Área</th>'; backBtn.classList.add('hidden'); const f = window.stories.filter(s => { const areaCfg = window.configs.area.find(a => a.name === s.area); return (!dir || (areaCfg && areaCfg.directorate === dir)) && (!area || s.area === area) && (!po || s.po === po) && dSet.includes(s.status) && s.updatedAt && new Date(s.updatedAt).getMonth() === mon && new Date(s.updatedAt).getFullYear() === yr; }); b.innerHTML = f.length ? f.map(s => `<tr onclick="window.drillDownToStoryTasks('${s.id}')" class="cursor-pointer hover:bg-blue-50 transition-colors"><td>${new Date(s.updatedAt).toLocaleDateString('pt-BR')}</td><td>${s.title}</td><td class="font-bold text-[#1F3BB3]">${s.area || '-'}</td></tr>`).join('') : '<tr><td colspan="3" class="p-8 text-center text-gray-300 text-xs italic">Nenhuma entrega...</td></tr>'; } };

    window.renderStories = () => { const b = document.getElementById('stories-table-body'); if(!b) return; const pagContainer = document.getElementById('stories-pagination-container'), pagInfo = document.getElementById('stories-pagination-info'), searchTerm = (window.viewFilters.stories.search || '').toLowerCase(); const allFiltered = window.stories.filter(s => { const mArea = !window.viewFilters.stories.area || s.area === window.viewFilters.stories.area; const mPo = !window.viewFilters.stories.po || s.po === window.viewFilters.stories.po; const mStatus = !window.viewFilters.stories.status || s.status === window.viewFilters.stories.status; const mSearch = !searchTerm || (s.title && s.title.toLowerCase().includes(searchTerm)) || (s.externalId && s.externalId.toString().includes(searchTerm)); return mArea && mPo && mStatus && mSearch; }); const totalStories = allFiltered.length, displayedStories = allFiltered.slice(0, window.pageSizeStories); b.innerHTML = displayedStories.map(s => { const p = window.getStoryProg(s.id); const isS = window.selectedIds.stories.has(s._docId); const idDisplay = s.externalLink ? `<a href="${s.externalLink}" target="_blank" class="table-id-link">#${s.externalId}</a>` : `#${s.externalId || '-'}`; return `<tr class="${isS ? 'selected' : ''}"><td class="text-center"><input type="checkbox" data-doc-id="${s._docId}" ${isS ? 'checked' : ''} onchange="window.toggleItemSelection('stories', '${s._docId}', this.checked)"></td><td class="table-id text-center">${idDisplay}</td><td><span class="table-title cursor-pointer font-bold" onclick="window.openStoryFormById(${s.id})">${s.title}</span></td><td class="text-center"><span class="font-bold text-slate-600">${s.priority || '-'}</span></td><td class="table-meta font-black text-[9px] text-slate-400">${s.area || '-'}</td><td class="table-meta">${s.po || '-'}</td><td class="text-center"><span class="status-badge ${window.statusColors[s.status] || 'bg-gray-100'} shadow-sm">${s.status}</span></td><td class="text-center"><div class="flex items-center justify-center gap-2"><div class="completion-bar"><div class="completion-fill bg-blue-600" style="width: ${p.total ? (p.done/p.total*100) : 0}%"></div></div><span class="text-[9px] font-black text-blue-700 cursor-pointer" onclick="window.openStoryTasksModal(${s.id})">${p.done}/${p.total}</span></div></td></tr>`; }).join(''); if (totalStories > window.pageSizeStories || window.pageSizeStories > 20) { pagContainer.classList.remove('hidden'); pagInfo.textContent = `Mostrando ${displayedStories.length} de ${totalStories}`; } else pagContainer.classList.add('hidden'); window.updateBulkActionBar('stories'); };
    window.renderFeatures = () => { const b = document.getElementById('features-table-body'); if(!b) return; const pagContainer = document.getElementById('features-pagination-container'), pagInfo = document.getElementById('features-pagination-info'), filteredTotal = window.features.filter(f => (!window.viewFilters.features.po || f.po === window.viewFilters.features.po) && (!window.viewFilters.features.status || f.status === window.viewFilters.features.status)); const totalFeatures = filteredTotal.length, displayedFeatures = filteredTotal.slice(0, window.pageSizeFeatures); b.innerHTML = displayedFeatures.map(f => { const isS = window.selectedIds.features.has(f._docId); const idDisplay = f.externalLink ? `<a href="${f.externalLink}" target="_blank" class="table-id-link">#${f.externalId}</a>` : `#${f.externalId || '-'}`; return `<tr class="${isS ? 'selected' : ''}"><td class="text-center"><input type="checkbox" data-doc-id="${f._docId}" ${isS ? 'checked' : ''} onchange="window.toggleItemSelection('features', '${f._docId}', this.checked)"></td><td class="table-id text-center">${idDisplay}</td><td><span class="table-title cursor-pointer font-bold" onclick="window.openFeatureFormById(${f.id})">${f.title}</span></td><td class="text-center"><span class="font-bold text-slate-600">${f.priority || '-'}</span></td><td class="table-meta">${f.po || '-'}</td><td class="text-center"><span class="status-badge ${window.statusColors[f.status] || 'bg-gray-100'} shadow-sm">${f.status}</span></td></tr>`; }).join(''); if (totalFeatures > window.pageSizeFeatures || window.pageSizeFeatures > 20) { pagContainer.classList.remove('hidden'); pagInfo.textContent = `Mostrando ${displayedFeatures.length} de ${totalFeatures}`; } else pagContainer.classList.add('hidden'); window.updateBulkActionBar('features'); };
    window.renderTasksView = () => { const b = document.getElementById('tasks_view-table-body'); if(!b) return; const pagContainer = document.getElementById('tasks-pagination-container'), pagInfo = document.getElementById('tasks-pagination-info'), searchTerm = (window.viewFilters.tasks_view.search || '').toLowerCase(); const allFiltered = window.tasks.filter(t => { const mStatus = !window.viewFilters.tasks_view.status || t.status === window.viewFilters.tasks_view.status; const mSystem = !window.viewFilters.tasks_view.system || t.system === window.viewFilters.tasks_view.system; const mTech = !window.viewFilters.tasks_view.techlead || t.techlead === window.viewFilters.tasks_view.techlead; const mSearch = !searchTerm || (t.title && t.title.toLowerCase().includes(searchTerm)) || (t.externalId && t.externalId.toString().includes(searchTerm)) || (t.gmudId && t.gmudId.toLowerCase().includes(searchTerm)); return mStatus && mSystem && mTech && mSearch; }); const totalTasks = allFiltered.length, displayedTasks = allFiltered.slice(0, window.pageSizeTasks); b.innerHTML = displayedTasks.map(t => { const isS = window.selectedIds.tasks_view.has(t._docId); const idDisplay = t.externalLink ? `<a href="${t.externalLink}" target="_blank" class="table-id-link">#${t.externalId}</a>` : `#${t.externalId || '-'}`; return `<tr class="${isS ? 'selected' : ''}"><td class="text-center"><input type="checkbox" data-doc-id="${t._docId}" ${isS ? 'checked' : ''} onchange="window.toggleItemSelection('tasks_view', '${t._docId}', this.checked)"></td><td class="table-id text-center">${idDisplay}</td><td class="table-id text-center">${t.gmudId || '-'}</td><td><span class="table-title cursor-pointer font-bold" onclick="window.editTask(${t.id})">${t.title}</span></td><td class="text-center"><span class="status-badge ${window.statusColors[t.status] || 'bg-gray-100'} shadow-sm">${t.status}</span></td><td class="text-center font-black text-[9px] text-slate-400">${t.system || '-'}</td><td class="table-meta">${t.developer || t.techlead || '-'}</td></tr>`; }).join(''); if (totalTasks > window.pageSizeTasks || window.pageSizeTasks > 20) { pagContainer.classList.remove('hidden'); pagInfo.textContent = `Mostrando ${displayedTasks.length} de ${totalTasks}`; } else pagContainer.classList.add('hidden'); window.updateBulkActionBar('tasks_view'); };

    window.renderTasksInModal = (id) => { const b = document.getElementById('task-list-modal-table-body'); if(!b) return; const ts = window.tasks.filter(t => parseInt(t.storyId) === parseInt(id)); b.innerHTML = ts.length ? ts.map(t => `<tr class="${window.selectedIds.tasks.has(t._docId) ? 'selected' : ''}"><td class="text-center"><input type="checkbox" data-doc-id="${t._docId}" onchange="window.toggleItemSelection('tasks', '${t._docId}', this.checked)"></td><td class="table-id text-center">#${t.externalId || '-'}</td><td class="table-title font-bold text-xs text-slate-600 cursor-pointer" onclick="window.editTask(${t.id})">${t.title}</td><td class="text-center"><span class="status-badge ${window.statusColors[t.status] || 'bg-gray-100'} shadow-sm">${t.status}</span></td></tr>`).join('') : '<tr><td colspan="4" class="p-10 text-center text-gray-300 text-xs font-bold">Sem tarefas...</td></tr>'; window.updateBulkActionBar('tasks'); document.getElementById('add-task-from-modal-btn').onclick = () => window.openTaskForm(id); };
    window.renderConfigLists = () => { const cont = document.getElementById('configs-content'); if(!cont) return; cont.innerHTML = ''; const dc = window.configs.deliveryConfigs[0] || { storyStatuses: ["Concluído", "Concluída"], taskStatuses: ["Concluído", "Concluída"] }; const fl = window.configs.fieldLimits[0] || { storyTitle: 100, storyDesc: 1000, featureTitle: 100, featureDesc: 1000, taskTitle: 100, taskDesc: 1000 }; let h = `<div class="card p-6 border-t-4 border-green-500 shadow-sm col-span-full mb-6"><h4 class="text-[10px] font-black mb-4 tracking-widest text-slate-400">Status de conclusão</h4><div class="grid grid-cols-1 md:grid-cols-2 gap-8 text-slate-800"><div><label class="text-[10px] font-bold mb-3 block text-slate-500">Histórias entregues</label><div class="space-y-1 max-h-40 overflow-y-auto">${(window.configs.statusStory || []).map(s => `<label class="flex items-center text-[11px] p-2 bg-gray-50 rounded hover:bg-gray-100 cursor-pointer"><input type="checkbox" name="deliv-story" value="${s.name}" ${dc.storyStatuses.includes(s.name) ? 'checked' : ''} class="mr-3"><span>${s.name}</span></label>`).join('')}</div></div><div><label class="text-[10px] font-bold mb-3 block text-slate-500">Tarefas entregues</label><div class="space-y-1 max-h-40 overflow-y-auto">${(window.configs.statusTask || []).map(s => `<label class="flex items-center text-[11px] p-2 bg-gray-50 rounded hover:bg-gray-100 cursor-pointer"><input type="checkbox" name="deliv-task" value="${s.name}" ${dc.taskStatuses.includes(s.name) ? 'checked' : ''} class="mr-3"><span>${s.name}</span></label>`).join('')}</div></div></div><div class="mt-6 flex justify-end"><button onclick="window.saveDeliveryConfigs()" class="btn-primary">Salvar status</button></div></div>`; h += `<div class="card p-6 border-t-4 border-amber-500 shadow-sm col-span-full mb-6"><h4 class="text-[10px] font-black mb-4 tracking-widest text-slate-400">Limites de caracteres</h4><div class="grid grid-cols-1 md:grid-cols-3 gap-6"><div><label class="text-[9px] font-bold block mb-1">História</label><input type="number" id="limit-story-title" value="${fl.storyTitle}" class="form-input w-full mb-2"><input type="number" id="limit-story-desc" value="${fl.storyDesc}" class="form-input w-full"></div><div><label class="text-[9px] font-bold block mb-1">Feature</label><input type="number" id="limit-feature-title" value="${fl.featureTitle}" class="form-input w-full mb-2"><input type="number" id="limit-feature-desc" value="${fl.featureDesc}" class="form-input w-full"></div><div><label class="text-[9px] font-bold block mb-1">Tarefa</label><input type="number" id="limit-task-title" value="${fl.taskTitle}" class="form-input w-full mb-2"><input type="number" id="limit-task-desc" value="${fl.taskDesc}" class="form-input w-full"></div></div><div class="mt-6 flex justify-end"><button onclick="window.saveFieldLimits()" class="btn-primary">Salvar limites</button></div></div>`; cont.innerHTML = h; const typs = { 'year': 'Anos', 'directorate': 'Diretoria', 'area': 'Áreas', 'po': 'POs', 'system': 'Sistemas', 'techlead': 'Tech Leads', 'developer': 'Desenvolvedores', 'statusStory': 'Status Histórias', 'statusFeature': 'Status Features', 'priorityFeature': 'Prioridades Features', 'priorityStory': 'Prioridades Histórias', 'statusTask': 'Status Tasks' }; Object.entries(typs).forEach(([ty, lab]) => { const c = document.createElement('div'); c.className = "card p-5 border-0 shadow-sm"; if (ty === 'area') { const dOpts = (window.configs.directorate || []).filter(d => d.isActive).map(d => `<option value="${d.name}">${d.name}</option>`).join(''); c.innerHTML = `<h4 class="text-[9px] font-black mb-4 text-slate-400 tracking-widest">${lab}</h4><div id="list-${ty}" class="space-y-1 mb-4 max-h-40 overflow-y-auto pr-1 text-xs"></div><div class="space-y-2"><input type="text" id="input-${ty}" placeholder="Nome..." class="form-input text-[11px] w-full !h-8"><div class="flex space-x-2"><select id="input-${ty}-directorate" class="filter-select text-[11px] flex-1 !h-8"><option value="">Diretoria...</option>${dOpts}</select><button onclick="window.addConfigItem('${ty}')" class="bg-[#1F3BB3] text-white px-4 rounded font-bold shadow-sm">+</button></div></div>`; } else { c.innerHTML = `<h4 class="text-[9px] font-black mb-4 text-slate-400 tracking-widest">${lab}</h4><div id="list-${ty}" class="space-y-1 mb-4 max-h-40 overflow-y-auto pr-1 text-xs"></div><div class="flex space-x-2"><input type="text" id="input-${ty}" placeholder="Adicionar..." class="form-input text-[11px] flex-1 !h-8"><button onclick="window.addConfigItem('${ty}')" class="bg-[#1F3BB3] text-white px-3 rounded font-bold shadow-sm">+</button></div>`; } cont.appendChild(c); window.renderConfigItems(ty, c.querySelector(`#list-${ty}`)); }); };
    window.renderConfigItems = (ty, lE) => { if(!lE) return; lE.innerHTML = (window.configs[ty] || []).map(i => `<div class="flex justify-between items-center bg-gray-50 p-2 rounded text-[10px] font-bold group"><span class="${i.isActive ? 'text-slate-600' : 'line-through text-slate-300'}">${i.name} ${ty === 'area' && i.directorate ? `<span class="text-[8px] text-slate-400 ml-1">(${i.directorate})</span>` : ''}</span><div class="flex items-center space-x-2"><button onclick="window.deleteConfigItem('${ty}', '${i._docId}', '${i.name}')" class="opacity-0 group-hover:opacity-100 text-red-400 hover:text-red-600"><svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button><button onclick="window.toggleConfigActive('${ty}', '${i._docId}')" class="w-1.5 h-1.5 rounded-full ${i.isActive ? 'bg-[#1FDB84]' : 'bg-gray-200'} shadow-sm"></button></div></div>`).join(''); };
    window.deleteConfigItem = (ty, dId, name) => { window.showModal("Excluir", `Apagar "${name}"?`, `<button onclick="window.closeModal()" class="text-xs font-bold text-gray-400 mr-4">CANCELAR</button><button onclick="window.executeDeleteConfig('${dId}')" class="text-red-500 font-bold text-xs">EXCLUIR</button>`); };
    window.executeDeleteConfig = async dId => { if(!window.firestone) return; await window.firestone.deleteDoc('app_configs', dId); window.closeModal(); };
    window.addConfigItem = async ty => { const inp = document.getElementById(`input-${ty}`); if(!inp.value.trim() || !window.firestone) return; const data = { type: ty, name: inp.value.trim(), isActive: true }; if (ty === 'area') { const dirSel = document.getElementById(`input-${ty}-directorate`); if (dirSel && dirSel.value) data.directorate = dirSel.value; } await window.firestone.saveConfig(data); inp.value = ''; if (ty === 'area') document.getElementById(`input-${ty}-directorate`).value = ''; };
    window.toggleConfigActive = async (ty, dId) => { const it = window.configs[ty].find(x => x._docId === dId); if(it) await window.firestone.saveConfig({ ...it, isActive: !it.isActive }); };
    window.saveDeliveryConfigs = async () => { const data = { type: 'deliveryConfigs', storyStatuses: Array.from(document.querySelectorAll('input[name="deliv-story"]:checked')).map(i => i.value), taskStatuses: Array.from(document.querySelectorAll('input[name="deliv-task"]:checked')).map(i => i.value) }; if(window.configs.deliveryConfigs[0]?._docId) data._docId = window.configs.deliveryConfigs[0]._docId; await window.firestone.saveConfig(data); window.renderDashboard(); window.showModal("Sucesso", "Status atualizados.", `<button onclick="window.closeModal()" class="btn-primary">OK</button>`); };
    window.saveFieldLimits = async () => { const data = { type: 'fieldLimits', storyTitle: parseInt(document.getElementById('limit-story-title').value), storyDesc: parseInt(document.getElementById('limit-story-desc').value), featureTitle: parseInt(document.getElementById('limit-feature-title').value), featureDesc: parseInt(document.getElementById('limit-feature-desc').value), taskTitle: parseInt(document.getElementById('limit-task-title').value), taskDesc: parseInt(document.getElementById('limit-task-desc').value) }; if (window.configs.fieldLimits[0]?._docId) data._docId = window.configs.fieldLimits[0]._docId; await window.firestone.saveConfig(data); window.renderDashboard(); window.showModal("Sucesso", "Limites atualizados.", `<button onclick="window.closeModal()" class="btn-primary">OK</button>`); };

    window.updateBulkActionBar = ty => { const cnt = window.selectedIds[ty].size, aB = document.getElementById(`bulk-${ty}-actions`); if(!aB) return; if(cnt > 0) aB.classList.remove('hidden'); else aB.classList.add('hidden'); const bId = (ty === 'tasks') ? 'task-list-modal-table-body' : (ty === 'tasks_view' ? 'tasks_view-table-body' : `${ty}-table-body`); document.querySelectorAll(`#${bId} tr`).forEach(tr => { const cb = tr.querySelector('input[type="checkbox"]'); if(cb && cb.checked) tr.classList.add('selected'); else tr.classList.remove('selected'); }); };
    window.toggleItemSelection = (ty, dId, chk) => { if(chk) window.selectedIds[ty].add(dId); else window.selectedIds[ty].delete(dId); window.updateBulkActionBar(ty); };
    window.toggleSelectAll = (ty, chk) => { const bId = (ty === 'tasks') ? 'task-list-modal-table-body' : (ty === 'tasks_view' ? 'tasks_view-table-body' : `${ty}-table-body`); document.querySelectorAll(`#${bId} input[type="checkbox"]`).forEach(cb => { cb.checked = chk; const dId = cb.getAttribute('data-doc-id'); if(chk) window.selectedIds[ty].add(dId); else window.selectedIds[ty].delete(dId); }); window.updateBulkActionBar(ty); };
    window.bulkDelete = ty => { const cnt = window.selectedIds[ty].size; window.showModal(`Excluir em massa`, `Deseja apagar os ${cnt} itens?`, `<button onclick="window.closeModal()" class="text-xs font-bold text-gray-400 mr-4">CANCELAR</button><button onclick="window.executeBulkDelete('${ty}')" class="text-red-500 font-bold text-xs">APAGAR</button>`); };
    window.executeBulkDelete = async ty => { const ids = Array.from(window.selectedIds[ty]); for (const dId of ids) { await window.firestone.deleteDoc(ty === 'tasks_view' ? 'tasks' : ty, dId); } window.selectedIds[ty].clear(); window.updateBulkActionBar(ty); window.closeModal(); };
    window.bulkEdit = ty => { const dId = Array.from(window.selectedIds[ty])[0]; if(!dId) return; if(ty === 'features') { const f = window.features.find(i => i._docId === dId); if(f) window.openFeatureForm(f); } else if(ty === 'stories') { const s = window.stories.find(i => i._docId === dId); if(s) window.openStoryForm(s); } else if(ty === 'tasks' || ty === 'tasks_view') { window.editTask(window.tasks.find(t => t._docId === dId).id); } };

    window.renderImportCards = () => { const c = document.getElementById('import-cards-container'); if(!c) return; const d = [{ type: 'features', title: 'Features', color: '#1FDB84' }, { type: 'stories', title: 'Histórias', color: '#1F3BB3' }, { type: 'tasks', title: 'Tasks', color: '#05C283' }]; c.innerHTML = d.map(x => `<div class="card p-6 border-t-4 shadow-sm" style="border-top-color: ${x.color};"><h4 class="text-[10px] font-black mb-4 tracking-widest text-slate-400">${x.title}</h4><button onclick="window.downloadTemplate('${x.type}')" class="w-full py-2 bg-gray-50 text-[10px] font-bold border rounded mb-2">Modelo CSV</button><input type="file" id="file-import-${x.type}" class="hidden" onchange="window.handleFileImport('${x.type}', this)"><button onclick="document.getElementById('file-import-${x.type}').click()" class="btn-primary w-full text-[10px]">Upload CSV</button></div>`).join(''); };
    window.downloadTemplate = ty => { let h = ty === 'features' ? ["ID Externo", "Titulo", "Diretoria", "PO", "Status", "Link", "Descricao", "Prioridade"] : (ty === 'stories' ? ["ID Externo", "Titulo", "Area", "PO", "Status", "Descricao", "Link", "Prioridade"] : ["ID Externo", "Titulo", "HistoriaID", "Status", "Dev", "Descricao", "Link", "Gmud"]); const blob = new Blob(["\ufeff" + h.join(";")], { type: 'text/csv;charset=utf-8;' }); const link = document.createElement("a"); link.href = URL.createObjectURL(blob); link.download = `modelo_${ty}.csv`; link.click(); };
    window.exportToCSV = ty => { let data = [], headers = [], filename = ""; if (ty === 'features') { data = window.features; headers = ["ID Externo", "Titulo", "Diretoria", "PO", "Status", "Link", "Descricao", "Prioridade"]; filename = "features.csv"; } else if (ty === 'stories') { data = window.stories; headers = ["ID Externo", "Titulo", "Area", "PO", "Status", "Descricao", "Link", "Prioridade"]; filename = "historias.csv"; } else if (ty === 'tasks') { data = window.tasks; headers = ["ID Externo", "Titulo", "HistoriaID", "Status", "Dev", "Descricao", "Link", "Gmud"]; filename = "tarefas.csv"; } const rows = data.map(item => ty === 'features' ? [item.externalId || "", item.title || "", item.directorate || "", item.po || "", item.status || "", item.externalLink || "", (item.description || "").replace(/(\r\n|\n|\r|;)/gm, " "), item.priority || ""] : (ty === 'stories' ? [item.externalId || "", item.title || "", item.area || "", item.po || "", item.status || "", (item.description || "").replace(/(\r\n|\n|\r|;)/gm, " "), item.externalLink || "", item.priority || ""] : [item.externalId || "", item.title || "", item.storyId || "", item.status || "", item.developer || "", (item.description || "").replace(/(\r\n|\n|\r|;)/gm, " "), item.externalLink || "", item.gmudId || ""])); const csvContent = "\ufeff" + [headers.join(";"), ...rows.map(r => r.join(";"))].join("\n"); const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' }); const link = document.createElement("a"); link.href = URL.createObjectURL(blob); link.download = filename; link.click(); };

    window.handleFileImport = async (ty, inp) => { 
        const file = inp.files[0]; if (!file) return; window.showModal("Processando", `Carga...`, ""); const reader = new FileReader(); reader.onload = async e => { 
            try { const ab = e.target.result; const utf8 = new TextDecoder("utf-8"); let txt = utf8.decode(ab); if (txt.includes('\ufffd')) txt = new TextDecoder("iso-8859-1").decode(ab); const line1 = txt.split(/\r?\n/)[0], sep = (line1.match(/;/g) || []).length >= (line1.match(/,/g) || []).length ? ';' : ','; const rows = parseCSVContent(txt, sep); if (rows.length < 2) return window.showModal("Erro", "Sem dados.", `<button onclick="window.closeModal()" class="btn-primary">Fechar</button>`); const headers = rows[0].map(normalizeHeader); let count = 0; for (let i = 1; i < rows.length; i++) { const vals = rows[i], f = n => { const t = normalizeHeader(n); let idx = headers.indexOf(t); if (idx === -1) idx = headers.findIndex(h => h.includes(t) || t.includes(h)); return (idx !== -1 && idx < vals.length) ? vals[idx] : ""; }; const tit = f("titulo"); if (!tit) continue; try { const base = { id: window.generateId(), externalId: f("externo") || f("id"), title: tit, description: f("descricao") || "", po: f("po"), externalLink: f("link") || f("url"), updatedAt: new Date().toISOString() }; if (ty === 'features') await window.firestone.saveFeature({ ...base, directorate: f("diretoria") || "", status: f("status") || "Proposto", priority: f("prioridade") || "", isFeatured: false }); else if (ty === 'stories') await window.firestone.saveStory({ ...base, area: f("area") || "", status: f("status") || "A Fazer", priority: f("prioridade") || "", isFeatured: false }); else if (ty === 'tasks') { const sId = parseInt(f("historiaid") || f("storyid")); if (!isNaN(sId)) await window.firestone.saveTask({ ...base, storyId: sId, status: f("status") || "A Fazer", developer: f("dev"), gmudId: f("gmud") }); } count++; } catch (e) {} } window.showModal("Sucesso", `Carga: ${count} registros.`, `<button onclick="window.closeModal()" class="btn-primary">OK</button>`); inp.value = ""; } catch (e) { window.showModal("Erro", `Falha: ${e.message}`, `<button onclick="window.closeModal()" class="btn-primary">Fechar</button>`); }
        }; reader.readAsArrayBuffer(file); 
    };

    window.populateGlobalFilters = () => { const dS = document.getElementById('dashboard-global-filter-directorate'), pS = document.getElementById('dashboard-global-filter-po'); if(!dS || !pS) return; if (dS.options.length <= 1) dS.innerHTML = '<option value="">Diretorias</option>' + (window.configs.directorate || []).filter(c => c.isActive).map(c => `<option value="${c.name}">${c.name}</option>`).join(''); window.populateGlobalAreaOptions(); if (pS.options.length <= 1) pS.innerHTML = '<option value="">POs</option>' + (window.configs.po || []).filter(c => c.isActive).map(c => `<option value="${c.name}">${c.name}</option>`).join(''); };
    window.openStoryFormById = id => { const s = window.stories.find(x => parseInt(x.id) === parseInt(id)); if(s) window.openStoryForm(s); };
    window.openFeatureFormById = id => { const f = window.features.find(x => parseInt(x.id) === parseInt(id)); if(f) window.openFeatureForm(f); };

    window.onload = function() { const dD = document.getElementById('current-date-display'); if(dD) dD.textContent = new Date().toLocaleDateString('pt-BR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }); const yD = document.getElementById('current-year'); if(yD) yD.textContent = new Date().getFullYear(); const sI = document.getElementById('task-story-search-input'); if(sI) { sI.onfocus = e => window.renderStorySearchResults(e.target.value); sI.oninput = e => window.renderStorySearchResults(e.target.value); } document.addEventListener('click', e => { if (!document.getElementById('task-story-assoc-container')?.contains(e.target)) document.getElementById('task-story-search-results')?.classList.add('hidden'); }); window.showView('dashboard'); };
</script>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
  import { getFirestore, collection, addDoc, doc, updateDoc, deleteDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
  const firebaseConfig = { apiKey: "AIzaSyDU3nmuB6kOiVAxuqTdpzOUjtzhVtj1sBg", authDomain: "managerscrum-dc813.firebaseapp.com", projectId: "managerscrum-dc813", storageBucket: "managerscrum-dc813.firebasestorage.app", messagingSenderId: "840047163274", appId: "1:840047163274:web:f86a11927e2751a4f4fa73" };
  const app = initializeApp(firebaseConfig), db = getFirestore(app);
  function docToObj(snap) { return { _docId: snap.id, ...snap.data() }; }
  onSnapshot(collection(db, 'features'), s => { window.features = s.docs.map(docToObj); window.renderDashboard(); if (!document.getElementById('feature-view').classList.contains('hidden')) window.renderFeatures(); });
  onSnapshot(collection(db, 'stories'), s => { window.stories = s.docs.map(docToObj); window.renderDashboard(); if (!document.getElementById('stories-view').classList.contains('hidden')) window.renderStories(); if(window._lastFeatureModalId) window.renderStoriesInModal(window._lastFeatureModalId); });
  onSnapshot(collection(db, 'tasks'), s => { window.tasks = s.docs.map(docToObj); window.renderDashboard(); if (!document.getElementById('tasks_view-view').classList.contains('hidden')) window.renderTasksView(); if(window._lastTaskModalStoryId) window.renderTasksInModal(window._lastTaskModalStoryId); });
  onSnapshot(collection(db, 'app_configs'), s => { Object.keys(window.configs).forEach(k => window.configs[k] = []); s.docs.forEach(d => { const it = docToObj(d); if(window.configs[it.type]) window.configs[it.type].push(it); }); window.renderDashboard(); if (!document.getElementById('configs-view').classList.contains('hidden')) window.renderConfigLists(); });
  window.firestone = { saveConfig: async c => { const { _docId, ...p } = c; if(_docId) await updateDoc(doc(db, 'app_configs', _docId), p); else await addDoc(collection(db, 'app_configs'), p); }, saveStory: async s => { const { _docId, ...p } = s; if(_docId) await updateDoc(doc(db, 'stories', _docId), p); else await addDoc(collection(db, 'stories'), p); }, saveFeature: async f => { const { _docId, ...p } = f; if(_docId) await updateDoc(doc(db, 'features', _docId), p); else await addDoc(collection(db, 'features'), p); }, saveTask: async t => { const { _docId, ...p } = t; if(_docId) await updateDoc(doc(db, 'tasks', _docId), p); else await addDoc(collection(db, 'tasks'), p); }, deleteDoc: async (coll, docId) => { await deleteDoc(doc(db, coll, docId)); } };
  document.getElementById('story-form').onsubmit = async e => { e.preventDefault(); const data = { id: parseInt(document.getElementById('story-id').value), externalId: document.getElementById('story-external-id').value, title: document.getElementById('story-title').value, description: document.getElementById('story-description').value, area: document.getElementById('story-area').value, po: document.getElementById('story-po').value, status: document.getElementById('story-status').value, priority: document.getElementById('story-priority').value, externalLink: document.getElementById('story-external-link').value, isFeatured: document.getElementById('story-is-featured').checked, featureId: parseInt(document.getElementById('story-feature').value) || null, updatedAt: new Date().toISOString() }; const docId = document.getElementById('story-doc-id').value; if(docId) data._docId = docId; await window.firestone.saveStory(data); window.closeStoryForm(); };
  document.getElementById('feature-form').onsubmit = async e => { e.preventDefault(); const data = { id: parseInt(document.getElementById('feature-id').value), externalId: document.getElementById('feature-external-id').value, title: document.getElementById('feature-title').value, directorate: document.getElementById('feature-directorate').value, po: document.getElementById('feature-po').value, status: document.getElementById('feature-status').value, priority: document.getElementById('feature-priority').value, externalLink: document.getElementById('feature-external-link').value, description: document.getElementById('feature-description').value, isFeatured: document.getElementById('feature-is-featured').checked, updatedAt: new Date().toISOString() }; const docId = document.getElementById('feature-doc-id').value; if(docId) data._docId = docId; await window.firestone.saveFeature(data); document.getElementById('feature-form-container').classList.add('hidden'); };
  document.getElementById('task-form').onsubmit = async e => { e.preventDefault(); const sId = parseInt(document.getElementById('task-story-assoc-id').value); if (isNaN(sId)) return window.showModal("Atenção", "Selecione uma história.", `<button onclick="window.closeModal()" class=\"btn-primary\">OK</button>`); const data = { id: parseInt(document.getElementById('task-id').value), storyId: sId, externalId: document.getElementById('task-external-id').value, gmudId: document.getElementById('task-gmud-id').value, title: document.getElementById('task-title').value, status: document.getElementById('task-status').value, system: document.getElementById('task-system').value, techlead: document.getElementById('task-techlead').value, developer: document.getElementById('task-developer').value, description: document.getElementById('task-description').value, externalLink: document.getElementById('task-external-link').value, updatedAt: new Date().toISOString() }; const dId = document.getElementById('task-doc-id').value; if(dId) data._docId = dId; await window.firestone.saveTask(data); document.getElementById('task-modal').classList.add('hidden'); };
</script>
</body>
</html>
