<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scrum Manager (Low-Code/Local)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        
        :root {
            --bg-main: #f8fafc;
            --sidebar-bg: #0f172a;
        }

        body { 
            font-family: 'Inter', sans-serif; 
            background-color: var(--bg-main); 
            color: #1e293b;
        }

        /* Scrollbar customizada */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        .chart-container {
            position: relative;
            height: 280px; 
            width: 100%;
        }

        .view {
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .completion-bar {
            width: 100%;
            height: 8px; 
            background-color: #e2e8f0; 
            border-radius: 9999px; 
            overflow: hidden;
        }

        .completion-fill {
            height: 100%;
            transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .main-content-wrapper {
            height: 100vh;
            overflow-y: auto;
            scroll-behavior: smooth;
        }
        
        /* Sidebar Styles */
        .mobile-nav-overlay {
            position: fixed;
            top: 0;
            left: 0;
            z-index: 50; 
            transform: translateX(-100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            width: 280px;
            height: 100vh;
        }
        
        .mobile-nav-overlay.open { transform: translateX(0); }
        
        /* Desktop Sidebar Reset */
        @media (min-width: 768px) {
            .mobile-nav-overlay {
                position: static;
                transform: translateX(0);
                width: 280px;
            }
            .mobile-header { display: none; }
        }
        
        .nav-btn {
            border-radius: 0.5rem;
            transition: all 0.2s ease;
            font-weight: 500;
        }

        .status-badge {
            padding: 0.25rem 0.75rem;
            font-weight: 600;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.025em;
            border-radius: 9999px;
            display: inline-flex;
            align-items: center;
        }

        .priority-badge { 
            border: 1px solid currentColor; 
            padding: 0.15rem 0.5rem;
            border-radius: 0.5rem;
            font-size: 0.7rem;
            font-weight: 700;
        }

        .card {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            border: 1px solid #f1f5f9;
        }

        .dense-table th {
            background-color: #f8fafc;
            color: #64748b;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.05em;
            padding: 1rem;
        }

        .dense-table td {
            padding: 1rem;
            font-size: 0.875rem;
            vertical-align: middle;
        }

        input, select, textarea {
            transition: all 0.2s ease;
            outline: none !important;
        }

        input:focus, select:focus, textarea:focus {
            border-color: #6366f1 !important;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1) !important;
        }
    </style>
</head>
<body class="flex flex-col md:flex-row overflow-hidden">

    <!-- Mobile Header -->
    <header class="mobile-header bg-[#0f172a] text-white p-4 flex justify-between items-center z-50 shadow-md md:hidden">
        <div class="flex items-center space-x-2">
            <div class="w-8 h-8 bg-indigo-600 rounded-lg flex items-center justify-center">
                <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path></svg>
            </div>
            <span class="font-bold tracking-tight">SCRUM PRO</span>
        </div>
        <button onclick="toggleMobileMenu()" class="p-2 hover:bg-white/10 rounded-lg transition">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
        </button>
    </header>

    <!-- Sidebar Menu -->
    <aside id="sidebar-menu" class="mobile-nav-overlay md:flex md:w-72 bg-[#0f172a] flex-col p-6 shadow-2xl z-40">
        <div class="hidden md:flex items-center space-x-3 mb-10 px-2">
            <div class="w-10 h-10 bg-indigo-600 rounded-xl flex items-center justify-center shadow-lg shadow-indigo-500/20">
                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path></svg>
            </div>
            <h1 class="text-xl font-black text-white tracking-tight">SCRUM PRO</h1>
        </div>

        <nav class="flex-1 space-y-1 overflow-y-auto">
            <button id="nav-dashboard" onclick="showView('dashboard'); toggleMobileMenu(true);"
                class="nav-btn flex items-center w-full px-4 py-3 text-gray-400 hover:bg-white/5 hover:text-white group">
                <svg class="w-5 h-5 mr-3 group-hover:scale-110 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path></svg>
                <span>Dashboard</span>
            </button>

            <div class="pt-4 pb-2 px-4">
                <span class="text-[10px] font-bold text-gray-500 uppercase tracking-widest">Gerenciamento</span>
            </div>

            <button id="nav-registrar" onclick="toggleSubmenu('registrar')"
                class="nav-btn flex items-center justify-between w-full px-4 py-3 text-gray-400 hover:bg-white/5 hover:text-white">
                <span class="flex items-center">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                    <span>Registrar</span>
                </span>
                <svg id="arrow-registrar" class="w-4 h-4 transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
            </button>
            
            <div id="submenu-registrar" class="space-y-1 pl-12 hidden">
                <button id="nav-feature" onclick="showView('feature'); toggleMobileMenu(true);"
                    class="submenu-btn flex items-center w-full py-2 text-sm text-gray-500 hover:text-white transition">Features</button>
                <button id="nav-stories" onclick="showView('stories'); toggleMobileMenu(true);"
                    class="submenu-btn flex items-center w-full py-2 text-sm text-gray-500 hover:text-white transition">Histórias/Tasks</button>
            </div>

            <button id="nav-config-parent" onclick="toggleSubmenu('config-parent')"
                class="nav-btn flex items-center justify-between w-full px-4 py-3 text-gray-400 hover:bg-white/5 hover:text-white">
                <span class="flex items-center">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path></svg>
                    <span>Configurações</span>
                </span>
                <svg id="arrow-config-parent" class="w-4 h-4 transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
            </button>
            
            <div id="submenu-config-parent" class="space-y-1 pl-12 hidden">
                <button id="nav-configs" onclick="showView('configs'); toggleMobileMenu(true);"
                    class="submenu-btn flex items-center w-full py-2 text-sm text-gray-500 hover:text-white transition">Sistema</button>
            </div>
        </nav>

        <div class="mt-auto pt-6 border-t border-white/10">
            <div class="flex items-center space-x-3 px-2">
                <div class="w-8 h-8 rounded-full bg-gradient-to-tr from-indigo-500 to-purple-500 flex items-center justify-center text-[10px] font-bold text-white">LC</div>
                <div>
                    <p class="text-xs font-bold text-white">Low Code User</p>
                    <p class="text-[10px] text-gray-500">Admin Account</p>
                </div>
            </div>
        </div>
    </aside>

    <div id="mobile-overlay" class="fixed inset-0 bg-black/50 z-40 hidden" onclick="toggleMobileMenu(true)"></div>

    <!-- Main Content -->
    <main class="flex-1 main-content-wrapper bg-[#f8fafc]">

        <!-- Generic Feedback Modal -->
        <div id="message-modal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm flex items-center justify-center z-[100] hidden">
            <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-sm text-center">
                <div id="modal-icon" class="w-16 h-16 bg-indigo-50 text-indigo-600 rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                </div>
                <h3 id="modal-title" class="text-xl font-bold text-slate-800 mb-2"></h3>
                <p id="modal-body" class="text-slate-500 mb-8 leading-relaxed"></p>
                <div id="modal-actions" class="flex justify-center space-x-3"></div>
            </div>
        </div>

        <!-- Dashboard View -->
        <div id="dashboard-view" class="view p-6 md:p-10 max-w-7xl mx-auto">
            <header class="mb-10">
                <h2 class="text-4xl font-black text-slate-900 tracking-tight">Dashboard</h2>
                <p class="text-slate-500 mt-1 font-medium">Visão geral da saúde e progresso do projeto.</p>
            </header>
            
            <div id="dashboard-summary" class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10">
                <!-- Injected via JS -->
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="card p-8">
                    <h3 class="text-lg font-bold text-slate-800 mb-6 flex items-center">
                        <span class="w-2 h-6 bg-indigo-500 rounded-full mr-3"></span>
                        Status por Product Owner
                    </h3>
                    <div class="chart-container"><canvas id="chart-po-status"></canvas></div>
                </div>
                <div class="card p-8">
                    <h3 class="text-lg font-bold text-slate-800 mb-6 flex items-center">
                        <span class="w-2 h-6 bg-emerald-500 rounded-full mr-3"></span>
                        Histórias Concluídas
                    </h3>
                    <div class="chart-container"><canvas id="chart-done-pending"></canvas></div>
                </div>
            </div>
        </div>

        <!-- Features View -->
        <div id="feature-view" class="view hidden p-6 md:p-10 max-w-7xl mx-auto">
            <header class="flex flex-col md:flex-row justify-between items-start md:items-end mb-10 gap-4">
                <div>
                    <h2 class="text-4xl font-black text-slate-900 tracking-tight">Features</h2>
                    <p class="text-slate-500 mt-1 font-medium">Grandes entregas e iniciativas estratégicas.</p>
                </div>
                <button onclick="openFeatureForm()" class="bg-indigo-600 text-white px-6 py-3 rounded-xl font-bold shadow-lg shadow-indigo-200 hover:bg-indigo-700 hover:-translate-y-0.5 transition flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M12 4v16m8-8H4"></path></svg>
                    Nova Feature
                </button>
            </header>

            <div id="feature-form-container" class="card p-8 mb-10 hidden border-t-4 border-indigo-600">
                <form id="feature-form" class="space-y-6">
                    <input type="hidden" id="feature-id"><input type="hidden" id="feature-doc-id">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                        <div class="space-y-2">
                            <label class="text-xs font-bold text-slate-500 uppercase">ID Externo</label>
                            <input type="number" id="feature-external-id" class="w-full border-2 border-slate-100 p-3 rounded-xl focus:border-indigo-500 bg-slate-50">
                        </div>
                        <div class="md:col-span-3 space-y-2">
                            <label class="text-xs font-bold text-slate-500 uppercase">Título da Feature</label>
                            <input type="text" id="feature-title" required class="w-full border-2 border-slate-100 p-3 rounded-xl focus:border-indigo-500 bg-slate-50">
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="space-y-2">
                            <label class="text-xs font-bold text-slate-500 uppercase">Diretoria</label>
                            <select id="feature-directorate" required class="w-full border-2 border-slate-100 p-3 rounded-xl bg-slate-50"></select>
                        </div>
                        <div class="space-y-2">
                            <label class="text-xs font-bold text-slate-500 uppercase">Product Owner</label>
                            <select id="feature-po" required class="w-full border-2 border-slate-100 p-3 rounded-xl bg-slate-50"></select>
                        </div>
                        <div class="space-y-2">
                            <label class="text-xs font-bold text-slate-500 uppercase">Status</label>
                            <select id="feature-status" required class="w-full border-2 border-slate-100 p-3 rounded-xl bg-slate-50"></select>
                        </div>
                    </div>
                    <div class="flex justify-end space-x-3 pt-4">
                        <button type="button" onclick="closeFeatureForm()" class="px-6 py-3 font-bold text-slate-400 hover:text-slate-600 transition">Cancelar</button>
                        <button type="submit" class="px-8 py-3 bg-indigo-600 text-white rounded-xl font-bold shadow-lg shadow-indigo-100 hover:bg-indigo-700 transition">Salvar Feature</button>
                    </div>
                </form>
            </div>

            <div class="card overflow-hidden">
                <table class="w-full dense-table">
                    <thead>
                        <tr>
                            <th class="w-16"></th>
                            <th class="text-left">ID Ext</th>
                            <th class="text-left">Título da Iniciativa</th>
                            <th class="text-left">PO Responsável</th>
                            <th class="text-left">Status</th>
                            <th class="w-20"></th>
                        </tr>
                    </thead>
                    <tbody id="features-table-body" class="divide-y divide-slate-100"></tbody>
                </table>
            </div>
        </div>

        <!-- Stories View -->
        <div id="stories-view" class="view hidden p-6 md:p-10 max-w-7xl mx-auto">
            <header class="flex flex-col md:flex-row justify-between items-start md:items-end mb-10 gap-4">
                <div>
                    <h2 class="text-4xl font-black text-slate-900 tracking-tight">Histórias</h2>
                    <p class="text-slate-500 mt-1 font-medium">Requisitos detalhados e backlog operacional.</p>
                </div>
                <button onclick="openStoryForm()" class="bg-indigo-600 text-white px-6 py-3 rounded-xl font-bold shadow-lg shadow-indigo-200 hover:bg-indigo-700 transition flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M12 4v16m8-8H4"></path></svg>
                    Nova História
                </button>
            </header>
            
            <div id="story-form-container" class="card p-8 mb-10 hidden border-t-4 border-indigo-600">
                <form id="story-form" class="space-y-6">
                    <input type="hidden" id="story-id"><input type="hidden" id="story-doc-id">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                        <div class="space-y-2">
                            <label class="text-xs font-bold text-slate-500 uppercase">ID Externo</label>
                            <input type="number" id="story-external-id" class="w-full border-2 border-slate-100 p-3 rounded-xl bg-slate-50">
                        </div>
                        <div class="md:col-span-3 space-y-2">
                            <label class="text-xs font-bold text-slate-500 uppercase">Título da História</label>
                            <input type="text" id="story-title" required class="w-full border-2 border-slate-100 p-3 rounded-xl bg-slate-50">
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="space-y-2">
                            <label class="text-xs font-bold text-slate-500 uppercase">Link (Jira/Azure)</label>
                            <input type="url" id="story-external-link" class="w-full border-2 border-slate-100 p-3 rounded-xl bg-slate-50">
                        </div>
                        <div class="space-y-2">
                            <label class="text-xs font-bold text-slate-500 uppercase">Feature Associada</label>
                            <select id="story-feature-id" class="w-full border-2 border-slate-100 p-3 rounded-xl bg-slate-50"></select>
                        </div>
                    </div>
                    <div class="space-y-2">
                        <label class="text-xs font-bold text-slate-500 uppercase">Descrição</label>
                        <textarea id="story-description" class="w-full border-2 border-slate-100 p-3 rounded-xl bg-slate-50" rows="3"></textarea>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-6">
                        <div class="space-y-2">
                            <label class="text-xs font-bold text-slate-500 uppercase">Inclusão</label>
                            <input type="date" id="story-requested-date" class="w-full border-2 border-slate-100 p-3 rounded-xl bg-slate-50 text-xs">
                        </div>
                        <div class="space-y-2">
                            <label class="text-xs font-bold text-slate-500 uppercase">Solicitante</label>
                            <input type="text" id="story-requester-name" class="w-full border-2 border-slate-100 p-3 rounded-xl bg-slate-50">
                        </div>
                        <div class="space-y-2">
                            <label class="text-xs font-bold text-slate-500 uppercase">Área</label>
                            <select id="story-area" class="w-full border-2 border-slate-100 p-3 rounded-xl bg-slate-50"></select>
                        </div>
                        <div class="space-y-2">
                            <label class="text-xs font-bold text-slate-500 uppercase">PO</label>
                            <select id="story-po" class="w-full border-2 border-slate-100 p-3 rounded-xl bg-slate-50"></select>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="space-y-2">
                            <label class="text-xs font-bold text-slate-500 uppercase">Status</label>
                            <select id="story-status" class="w-full border-2 border-slate-100 p-3 rounded-xl bg-slate-50"></select>
                        </div>
                        <div class="space-y-2">
                            <label class="text-xs font-bold text-slate-500 uppercase">Prioridade</label>
                            <select id="story-priority" class="w-full border-2 border-slate-100 p-3 rounded-xl bg-slate-50">
                                <option value="Alta">Alta</option><option value="Média">Média</option><option value="Baixa">Baixa</option>
                            </select>
                        </div>
                    </div>
                    <div class="flex flex-col sm:flex-row justify-between items-center pt-6 border-t border-slate-100 gap-4">
                        <button type="button" id="insert-task-btn" onclick="handleInsertTask()" class="bg-indigo-100 text-indigo-700 px-6 py-3 rounded-xl font-bold hover:bg-indigo-200 transition">Gerenciar Tarefas</button>
                        <div class="flex space-x-3">
                            <button type="button" onclick="closeStoryForm()" class="px-6 py-3 font-bold text-slate-400 transition">Cancelar</button>
                            <button type="submit" class="bg-indigo-600 text-white px-8 py-3 rounded-xl font-bold shadow-lg shadow-indigo-100 hover:bg-indigo-700 transition">Salvar Alterações</button>
                        </div>
                    </div>
                </form>
            </div>

            <div id="table-action-controls" class="card p-4 mb-6 hidden bg-indigo-600 border-none flex items-center justify-between text-white animate-fadeIn">
                <div class="flex items-center space-x-4">
                    <span id="selected-count-message" class="text-sm font-bold opacity-90 tracking-wide"></span>
                </div>
                <div class="flex space-x-2">
                    <button onclick="editSelectedStory()" id="edit-selected-btn" class="bg-white/20 hover:bg-white/30 px-4 py-2 rounded-lg text-xs font-bold transition">Editar</button>
                    <button onclick="confirmDeleteSelected()" id="delete-selected-btn" class="bg-red-500 hover:bg-red-600 px-4 py-2 rounded-lg text-xs font-bold transition">Remover</button>
                </div>
            </div>

            <div class="card overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full dense-table">
                        <thead>
                            <tr>
                                <th class="w-12 text-center"><input type="checkbox" id="header-select-all" onchange="toggleSelectAll(this.checked)" class="w-4 h-4 accent-indigo-600"></th>
                                <th class="text-left">ID</th>
                                <th class="text-left">Descrição da História</th>
                                <th class="text-left">Área</th>
                                <th class="text-left">Status</th>
                                <th class="text-left">Progresso</th>
                            </tr>
                        </thead>
                        <tbody id="stories-table-body" class="divide-y divide-slate-100"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Configs View -->
        <div id="configs-view" class="view hidden p-6 md:p-10 max-w-7xl mx-auto">
            <header class="mb-10">
                <h2 class="text-4xl font-black text-slate-900 tracking-tight">Sistema</h2>
                <p class="text-slate-500 mt-1 font-medium">Gestão de catálogos e parâmetros globais do Scrum.</p>
            </header>
            <div id="configs-content" class="flex flex-col gap-10"></div>
        </div>

        <!-- Task Modals -->
        <div id="task-list-modal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm flex items-center justify-center z-[80] hidden p-4">
             <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-4xl max-h-[85vh] overflow-y-auto">
                <h3 id="task-modal-list-title" class="text-2xl font-bold text-slate-900 mb-6 border-b pb-4">Backlog de Tarefas</h3>
                <div class="overflow-hidden border rounded-2xl mb-8">
                    <table class="w-full">
                        <thead class="bg-slate-50 border-b">
                            <tr>
                                <th class="px-6 py-4 text-left text-xs font-bold text-slate-500 uppercase">Identificador</th>
                                <th class="px-6 py-4 text-left text-xs font-bold text-slate-500 uppercase">Título da Tarefa</th>
                                <th class="px-6 py-4 text-left text-xs font-bold text-slate-500 uppercase">Situação</th>
                                <th class="px-6 py-4 text-center text-xs font-bold text-slate-500 uppercase">Ações</th>
                            </tr>
                        </thead>
                        <tbody id="task-list-modal-table-body" class="divide-y divide-slate-100 bg-white"></tbody>
                    </table>
                </div>
                <div class="flex flex-col sm:flex-row justify-between gap-4">
                     <button id="add-task-from-modal-btn" class="bg-indigo-600 text-white px-6 py-3 rounded-xl font-bold shadow-lg shadow-indigo-100 hover:bg-indigo-700 transition">Adicionar Tarefa</button>
                     <button onclick="closeStoryTasksModal()" class="bg-slate-100 text-slate-600 px-6 py-3 rounded-xl font-bold hover:bg-slate-200 transition">Fechar</button>
                </div>
             </div>
        </div>

        <!-- Task Create Modal -->
        <div id="task-modal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm flex items-center justify-center z-[90] hidden p-4">
            <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-lg"> 
                <h3 id="task-modal-title" class="text-2xl font-bold text-slate-900 mb-6 border-b pb-4">Detalhes da Tarefa</h3>
                <form id="task-form" class="space-y-5">
                    <input type="hidden" id="task-story-id"><input type="hidden" id="task-id"><input type="hidden" id="task-doc-id"> 
                    <div class="grid grid-cols-2 gap-4">
                        <div class="space-y-1">
                            <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest">ID Externo</label>
                            <input type="number" id="task-external-id" required class="w-full border-2 border-slate-50 p-3 rounded-xl bg-slate-50">
                        </div>
                        <div class="space-y-1">
                            <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest">ID GMUD</label>
                            <input type="text" id="task-gmud-id" class="w-full border-2 border-slate-50 p-3 rounded-xl bg-slate-50">
                        </div>
                    </div>
                    <div class="space-y-1">
                        <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Nome da Tarefa</label>
                        <input type="text" id="task-title" required class="w-full border-2 border-slate-50 p-3 rounded-xl bg-slate-50">
                    </div>
                    <div class="space-y-1">
                        <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Link de PR / Documento</label>
                        <input type="url" id="task-external-link" class="w-full border-2 border-slate-50 p-3 rounded-xl bg-slate-50">
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="space-y-1">
                            <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Sistema</label>
                            <select id="task-system" required class="w-full border-2 border-slate-50 p-2 rounded-xl bg-slate-50 text-xs"></select>
                        </div>
                        <div class="space-y-1">
                            <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Lead</label>
                            <select id="task-techlead" required class="w-full border-2 border-slate-50 p-2 rounded-xl bg-slate-50 text-xs"></select>
                        </div>
                        <div class="space-y-1">
                            <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Status</label>
                            <select id="task-status" required class="w-full border-2 border-slate-50 p-2 rounded-xl bg-slate-50 text-xs"></select>
                        </div>
                    </div>
                    <div class="flex justify-end space-x-3 pt-6">
                        <button type="button" onclick="closeTaskModal()" class="font-bold text-slate-400 px-4">Voltar</button>
                        <button type="submit" class="bg-indigo-600 text-white px-8 py-3 rounded-xl font-bold shadow-lg shadow-indigo-100">Gravar Tarefa</button>
                    </div>
                </form>
            </div>
        </div>

    </main>

<script>
    // === ESTADO GLOBAL ===
    var features = [];
    var stories = [];
    var tasks = [];
    var configs = {
        directorate: [], area: [], po: [], 
        statusStory: [], statusTask: [], statusFeature: [], 
        system: [], techlead: []
    };
    
    window.firestone = window.firestone || null;
    window._lastTaskModalStoryId = null;
    const STATUS_CONCLUIDO_NAME = 'Concluído';
    const generateId = () => Date.now() + Math.floor(Math.random() * 1000);

    const statusColors = {
        'A Fazer': 'bg-rose-500 text-white',
        'Em Desenvolvimento': 'bg-indigo-500 text-white',
        'Em Teste': 'bg-amber-400 text-white',
        'Concluído': 'bg-emerald-500 text-white',
        'Pendente': 'bg-slate-400 text-white',
        'Iniciado': 'bg-violet-400 text-white',
        'Proposto': 'bg-slate-200 text-slate-600',
        'Aprovado': 'bg-blue-400 text-white',
        'Em Andamento': 'bg-amber-400 text-white',
    };

    const priorityColors = {
        'Alta': 'bg-rose-50 text-rose-600 border-rose-200',
        'Média': 'bg-amber-50 text-amber-600 border-amber-200',
        'Baixa': 'bg-emerald-50 text-emerald-600 border-emerald-200',
    };

    // === UI CONTROLS ===
    function toggleMobileMenu(close = false) {
        const sidebar = document.getElementById('sidebar-menu');
        const overlay = document.getElementById('mobile-overlay');
        if(close || sidebar.classList.contains('open')) { 
            sidebar.classList.remove('open'); 
            overlay.classList.add('hidden'); 
        } else { 
            sidebar.classList.add('open'); 
            overlay.classList.remove('hidden'); 
        }
    }

    function toggleSubmenu(id) {
        const sub = document.getElementById(`submenu-${id}`);
        const arrow = document.getElementById(`arrow-${id}`);
        const current = sub.classList.contains('hidden');
        document.querySelectorAll('[id^="submenu-"]').forEach(s => s.classList.add('hidden'));
        document.querySelectorAll('[id^="arrow-"]').forEach(a => a.classList.remove('rotate-180'));
        if(current) { sub.classList.remove('hidden'); arrow?.classList.add('rotate-180'); }
    }

    function showView(viewId) {
        document.querySelectorAll('.view').forEach(v => v.classList.add('hidden'));
        document.getElementById(`${viewId}-view`)?.classList.remove('hidden');
        
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('bg-white/10', 'text-white'));
        document.getElementById(`nav-${viewId}`)?.classList.add('bg-white/10', 'text-white');

        if(viewId === 'configs') renderConfigLists();
        if(viewId === 'stories') { renderStories(); populateSelects(); populateStoryFeatureSelect(); }
        if(viewId === 'feature') { renderFeatures(); populateFeatureSelects(); }
        if(viewId === 'dashboard') renderDashboard();
    }

    function showModal(title, body, actions) {
        document.getElementById('modal-title').textContent = title;
        document.getElementById('modal-body').textContent = body;
        document.getElementById('modal-actions').innerHTML = actions;
        document.getElementById('message-modal').classList.remove('hidden');
    }
    function closeModal() { document.getElementById('message-modal').classList.add('hidden'); }

    // === CONFIGURATIONS ===
    function renderConfigLists() {
        const container = document.getElementById('configs-content');
        container.innerHTML = '';
        
        // Mapeamento de nomes amigáveis para as configurações individuais
        const configLabels = {
            'directorate': 'Diretoria',
            'statusFeature': 'Status de Features',
            'area': 'Áreas',
            'po': 'Product Owners',
            'statusStory': 'Status de Histórias',
            'system': 'Sistema',
            'techlead': 'Tech Lead',
            'statusTask': 'Status de Tasks'
        };

        const groups = {
            'Configurações de Features': ['directorate', 'statusFeature'],
            'Configurações de Histórias': ['area', 'po', 'statusStory', 'system'],
            'Configurações de Tasks': ['techlead', 'statusTask']
        };

        for (const [groupName, types] of Object.entries(groups)) {
            // Criar Seção do Grupo
            const groupSection = document.createElement('div');
            groupSection.className = "space-y-6";
            
            const groupHeader = document.createElement('h3');
            groupHeader.className = "text-xl font-black text-slate-800 border-b-2 border-slate-200 pb-2";
            groupHeader.innerText = groupName;
            groupSection.appendChild(groupHeader);
            
            const grid = document.createElement('div');
            grid.className = "grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8";
            
            types.forEach(type => {
                const card = document.createElement('div');
                card.className = "card p-6 border-t-4 border-indigo-600";
                
                const title = configLabels[type] || type;

                card.innerHTML = `
                    <h4 class="text-xs font-black mb-4 text-indigo-700 uppercase tracking-widest">${title}</h4>
                    <div id="list-${type}" class="space-y-2 mb-6 max-h-48 overflow-y-auto pr-2"></div>
                    <div class="flex space-x-2">
                        <input type="text" id="input-${type}" placeholder="Novo item..." class="border-2 border-slate-50 bg-slate-50 p-2 text-sm rounded-xl flex-1 focus:bg-white focus:border-indigo-200 transition-all">
                        <button onclick="addConfigItem('${type}')" class="bg-indigo-600 text-white px-4 py-2 rounded-xl font-bold shadow-md shadow-indigo-100 hover:bg-indigo-700 transition">+</button>
                    </div>
                `;
                grid.appendChild(card);
                container.appendChild(groupSection);
                groupSection.appendChild(grid);
                renderConfigItems(type);
            });
        }
    }

    function renderConfigItems(type) {
        const list = document.getElementById(`list-${type}`);
        if(!list) return;
        list.innerHTML = '';
        configs[type].forEach(item => {
            const row = document.createElement('div');
            row.className = "flex justify-between items-center bg-slate-50 p-3 rounded-xl text-xs border border-transparent hover:border-indigo-100 transition";
            row.innerHTML = `
                <span class="${item.isActive ? 'font-bold text-slate-700' : 'line-through text-slate-400'}">${item.name}</span>
                <div class="flex space-x-3">
                    <button onclick="toggleConfigActive('${type}', '${item._docId}')" class="hover:scale-125 transition" title="Ativar/Desativar">
                        <span class="w-2 h-2 rounded-full inline-block ${item.isActive ? 'bg-emerald-500' : 'bg-slate-300'}"></span>
                    </button>
                    <button onclick="deleteConfigItem('${type}', '${item._docId}')" class="text-slate-300 hover:text-rose-500 transition">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                    </button>
                </div>
            `;
            list.appendChild(row);
        });
    }

    async function addConfigItem(type) {
        const input = document.getElementById(`input-${type}`);
        const name = input.value.trim();
        if(!name || !window.firestone) return;
        await window.firestone.saveConfig({ type, name, isActive: true });
        input.value = '';
    }

    async function toggleConfigActive(type, docId) {
        const item = configs[type].find(i => i._docId === docId);
        if(!item || !window.firestone) return;
        await window.firestone.saveConfig({ ...item, isActive: !item.isActive });
    }

    async function deleteConfigItem(type, docId) {
        if(!window.firestone) return;
        showModal("Excluir Configuração", "Esta ação pode afetar itens já cadastrados. Deseja continuar?", 
            `<button onclick="closeModal()" class="px-6 py-2 bg-slate-100 rounded-xl font-bold">Cancelar</button>
             <button onclick="window.firestone.deleteConfig('${docId}'); closeModal();" class="px-6 py-2 bg-rose-600 text-white rounded-xl font-bold shadow-lg shadow-rose-100">Excluir</button>`);
    }

    function populateSelects() {
        const mappings = { 'story-area': 'area', 'story-po': 'po', 'story-status': 'statusStory' };
        for (const [id, type] of Object.entries(mappings)) {
            const el = document.getElementById(id); if(!el) continue;
            el.innerHTML = `<option value="">Selecionar...</option>`;
            configs[type].filter(c => c.isActive).forEach(c => { el.innerHTML += `<option value="${c.name}">${c.name}</option>`; });
        }
    }

    function populateFeatureSelects() {
        const mappings = { 'feature-directorate': 'directorate', 'feature-po': 'po', 'feature-status': 'statusFeature' };
        for (const [id, type] of Object.entries(mappings)) {
            const el = document.getElementById(id); if(!el) continue;
            el.innerHTML = `<option value="">Selecionar...</option>`;
            configs[type].filter(c => c.isActive).forEach(c => { el.innerHTML += `<option value="${c.name}">${c.name}</option>`; });
        }
    }

    function populateTaskSelects() {
        const mappings = { 'task-system': 'system', 'task-techlead': 'techlead', 'task-status': 'statusTask' };
        for (const [id, type] of Object.entries(mappings)) {
            const el = document.getElementById(id); if(!el) continue;
            el.innerHTML = `<option value="">Selecione...</option>`;
            configs[type].filter(c => c.isActive).forEach(c => { el.innerHTML += `<option value="${c.name}">${c.name}</option>`; });
        }
    }

    function populateStoryFeatureSelect() {
        const el = document.getElementById('story-feature-id');
        if(!el) return;
        el.innerHTML = `<option value="">-- Sem Feature Associada --</option>`;
        features.forEach(f => { el.innerHTML += `<option value="${f.id}">${f.title}</option>`; });
    }

    function renderStories() {
        const body = document.getElementById('stories-table-body');
        if(!body) return; body.innerHTML = '';
        stories.forEach(s => {
            const prog = getStoryProg(s.id);
            const statusClass = statusColors[s.status] || 'bg-slate-100 text-slate-600';
            const isSelected = selectedStoryIds.has(s.id);

            body.innerHTML += `
                <tr class="hover:bg-slate-50 transition group ${isSelected ? 'bg-indigo-50/50' : ''}">
                    <td class="p-3 text-center"><input type="checkbox" onchange="toggleStorySel(${s.id}, this.checked)" ${isSelected ? 'checked' : ''} class="w-4 h-4 accent-indigo-600" data-id="${s.id}"></td>
                    <td class="px-4 py-5 font-bold text-slate-400 text-xs">${s.externalId || '-'}</td>
                    <td class="px-6 py-5" onclick="openStoryFormById(${s.id})">
                        <div class="flex flex-col">
                            <span class="text-sm font-bold text-slate-800">${s.title}</span>
                            <span class="text-[10px] font-bold text-indigo-400 uppercase mt-1 tracking-wider">${s.po || 'Sem PO'}</span>
                        </div>
                    </td>
                    <td class="px-6 py-5 text-xs font-bold text-slate-500">${s.area}</td>
                    <td class="px-6 py-5"><span class="status-badge ${statusClass}">${s.status}</span></td>
                    <td class="px-4 py-5">
                        <div class="flex items-center space-x-3">
                            <div class="flex-1 completion-bar h-2 w-24">
                                <div class="completion-fill bg-indigo-600" style="width: ${prog.total ? (prog.done/prog.total*100) : 0}%"></div>
                            </div>
                            <button onclick="openStoryTasksModal(${s.id})" class="text-[10px] font-black text-indigo-600 bg-indigo-50 px-2 py-1 rounded hover:bg-indigo-100 transition">
                                ${prog.done}/${prog.total}
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        });
        updateActionControls();
    }

    function getStoryProg(id) {
        const ts = tasks.filter(t => t.storyId === id);
        const done = ts.filter(t => t.status === STATUS_CONCLUIDO_NAME).length;
        return { total: ts.length, done };
    }

    function openStoryForm(s = null) {
        document.getElementById('story-form-container').classList.remove('hidden');
        document.getElementById('story-form-container').scrollIntoView({ behavior: 'smooth' });
        if(s) {
            document.getElementById('story-doc-id').value = s._docId;
            document.getElementById('story-id').value = s.id;
            document.getElementById('story-external-id').value = s.externalId;
            document.getElementById('story-title').value = s.title;
            document.getElementById('story-area').value = s.area;
            document.getElementById('story-po').value = s.po;
            document.getElementById('story-status').value = s.status;
            document.getElementById('story-priority').value = s.priority;
            document.getElementById('story-description').value = s.description;
            document.getElementById('story-requested-date').value = s.requestedDate;
            document.getElementById('story-requester-name').value = s.requesterName;
            document.getElementById('story-feature-id').value = s.featureId || '';
            document.getElementById('insert-task-btn').classList.remove('opacity-50', 'pointer-events-none');
        } else {
            document.getElementById('story-form').reset();
            document.getElementById('story-id').value = generateId();
            document.getElementById('story-doc-id').value = '';
            document.getElementById('insert-task-btn').classList.add('opacity-50', 'pointer-events-none');
        }
    }
    function closeStoryForm() { document.getElementById('story-form-container').classList.add('hidden'); }
    function openStoryFormById(id) { const s = stories.find(st => st.id === id); if(s) openStoryForm(s); }

    document.getElementById('story-form').onsubmit = async function(e) {
        e.preventDefault();
        const data = {
            id: parseInt(document.getElementById('story-id').value),
            _docId: document.getElementById('story-doc-id').value || null,
            externalId: document.getElementById('story-external-id').value,
            title: document.getElementById('story-title').value,
            area: document.getElementById('story-area').value,
            po: document.getElementById('story-po').value,
            status: document.getElementById('story-status').value,
            priority: document.getElementById('story-priority').value,
            description: document.getElementById('story-description').value,
            requestedDate: document.getElementById('story-requested-date').value,
            requesterName: document.getElementById('story-requester-name').value,
            featureId: document.getElementById('story-feature-id').value ? parseInt(document.getElementById('story-feature-id').value) : null,
            updatedAt: new Date().toISOString()
        };
        await window.firestone.saveStory(data);
        if(!data._docId) { 
             setTimeout(() => {
                 const updated = stories.find(s => s.id === data.id);
                 if(updated) openStoryForm(updated);
             }, 500);
        } else {
            closeStoryForm();
        }
    };

    function renderFeatures() {
        const body = document.getElementById('features-table-body');
        if(!body) return; body.innerHTML = '';
        features.forEach(f => {
            const statusClass = statusColors[f.status] || 'bg-slate-100 text-slate-600';
            body.innerHTML += `
                <tr class="hover:bg-slate-50 transition cursor-pointer group" onclick="openFeatureFormById(${f.id})">
                    <td class="p-3 text-center"><div class="w-2 h-2 rounded-full bg-indigo-400 opacity-0 group-hover:opacity-100 transition mx-auto"></div></td>
                    <td class="px-4 py-5 font-bold text-slate-400 text-xs">${f.externalId || f.id}</td>
                    <td class="px-6 py-5 text-sm font-bold text-slate-800">${f.title}</td>
                    <td class="px-6 py-5 text-sm font-medium text-slate-500">${f.po}</td>
                    <td class="px-6 py-5"><span class="status-badge ${statusClass}">${f.status}</span></td>
                    <td class="px-4 py-5 text-right">
                         <button class="text-slate-300 group-hover:text-indigo-600 transition">
                             <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                         </button>
                    </td>
                </tr>`;
        });
    }

    function openFeatureForm(f = null) {
        document.getElementById('feature-form-container').classList.remove('hidden');
        document.getElementById('feature-form-container').scrollIntoView({ behavior: 'smooth' });
        populateFeatureSelects();
        if(f) {
            document.getElementById('feature-doc-id').value = f._docId;
            document.getElementById('feature-id').value = f.id;
            document.getElementById('feature-external-id').value = f.externalId;
            document.getElementById('feature-title').value = f.title;
            document.getElementById('feature-directorate').value = f.directorate;
            document.getElementById('feature-po').value = f.po;
            document.getElementById('feature-status').value = f.status;
        } else {
            document.getElementById('feature-form').reset();
            document.getElementById('feature-id').value = generateId();
            document.getElementById('feature-doc-id').value = '';
        }
    }
    function closeFeatureForm() { document.getElementById('feature-form-container').classList.add('hidden'); }
    function openFeatureFormById(id) { const f = features.find(feat => feat.id === id); if(f) openFeatureForm(f); }

    document.getElementById('feature-form').onsubmit = async function(e) {
        e.preventDefault();
        const data = {
            id: parseInt(document.getElementById('feature-id').value),
            _docId: document.getElementById('feature-doc-id').value || null,
            externalId: document.getElementById('feature-external-id').value,
            title: document.getElementById('feature-title').value,
            directorate: document.getElementById('feature-directorate').value,
            po: document.getElementById('feature-po').value,
            status: document.getElementById('feature-status').value,
            updatedAt: new Date().toISOString()
        };
        await window.firestone.saveFeature(data);
        closeFeatureForm();
    };

    function openStoryTasksModal(id) {
        window._lastTaskModalStoryId = id;
        document.getElementById('task-list-modal').classList.remove('hidden');
        renderTasksInModal(id);
    }
    function closeStoryTasksModal() { 
        document.getElementById('task-list-modal').classList.add('hidden'); 
        window._lastTaskModalStoryId = null;
    }

    function renderTasksInModal(id) {
        const body = document.getElementById('task-list-modal-table-body');
        body.innerHTML = '';
        const ts = tasks.filter(t => t.storyId === id);
        if(ts.length === 0) {
            body.innerHTML = '<tr><td colspan="4" class="p-10 text-center text-slate-400 font-medium">Nenhuma tarefa registrada.</td></tr>';
        }
        ts.forEach(t => {
            const statusClass = statusColors[t.status] || 'bg-slate-100';
            body.innerHTML += `
                <tr class="hover:bg-slate-50 transition">
                    <td class="px-6 py-4 text-xs font-bold text-slate-400">${t.externalId || '-'}</td>
                    <td class="px-6 py-4 text-sm font-bold text-slate-700">${t.title}</td>
                    <td class="px-6 py-4"><span class="status-badge !text-[9px] ${statusClass}">${t.status}</span></td>
                    <td class="px-6 py-4 text-center">
                        <button onclick="editTask(${t.id})" class="text-indigo-600 font-bold mr-3">Editar</button>
                        <button onclick="confirmDelTask(${t.id})" class="text-rose-500 font-bold">X</button>
                    </td>
                </tr>`;
        });
        document.getElementById('add-task-from-modal-btn').onclick = () => {
             const s = stories.find(st => st.id === id);
             openTaskModal(id, s.title);
        };
    }

    function openTaskModal(sid, stitle, t = null) {
        document.getElementById('task-modal').classList.remove('hidden');
        populateTaskSelects();
        document.getElementById('task-story-id').value = sid;
        if(t) {
            document.getElementById('task-doc-id').value = t._docId;
            document.getElementById('task-id').value = t.id;
            document.getElementById('task-external-id').value = t.externalId;
            document.getElementById('task-gmud-id').value = t.gmudId;
            document.getElementById('task-title').value = t.title;
            document.getElementById('task-external-link').value = t.externalLink;
            document.getElementById('task-system').value = t.system;
            document.getElementById('task-techlead').value = t.techlead;
            document.getElementById('task-status').value = t.status;
        } else { 
            document.getElementById('task-form').reset(); 
            document.getElementById('task-id').value = generateId();
            document.getElementById('task-doc-id').value = '';
        }
    }
    function closeTaskModal() { document.getElementById('task-modal').classList.add('hidden'); }

    document.getElementById('task-form').onsubmit = async function(e) {
        e.preventDefault();
        const data = {
            id: parseInt(document.getElementById('task-id').value),
            _docId: document.getElementById('task-doc-id').value || null,
            storyId: parseInt(document.getElementById('task-story-id').value),
            externalId: document.getElementById('task-external-id').value,
            gmudId: document.getElementById('task-gmud-id').value,
            title: document.getElementById('task-title').value,
            externalLink: document.getElementById('task-external-link').value,
            system: document.getElementById('task-system').value,
            techlead: document.getElementById('task-techlead').value,
            status: document.getElementById('task-status').value,
            updatedAt: new Date().toISOString()
        };
        await window.firestone.saveTask(data);
        closeTaskModal();
    };

    function editTask(id) { 
        const t = tasks.find(tk => tk.id === id); 
        if(t) { const s = stories.find(st => st.id === t.storyId); openTaskModal(t.storyId, s.title, t); } 
    }
    
    function confirmDelTask(id) {
         showModal("Excluir", "Remover esta tarefa?", 
            `<button onclick="closeModal()" class="px-6 py-2">Voltar</button>
             <button onclick="window.firestone.deleteTask('${tasks.find(tk=>tk.id===id)._docId}'); closeModal();" class="px-6 py-2 bg-rose-600 text-white rounded-xl font-bold shadow-lg">Confirmar</button>`);
    }

    function renderDashboard() {
        const done = stories.filter(s => s.status === STATUS_CONCLUIDO_NAME).length;
        const summary = document.getElementById('dashboard-summary');
        if(!summary) return;
        
        summary.innerHTML = `
            <div class="card p-8 border-l-8 border-indigo-500">
                <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Iniciativas Totais</p>
                <p class="text-4xl font-black text-slate-800 mt-2">${stories.length}</p>
            </div>
            <div class="card p-8 border-l-8 border-emerald-500">
                <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Taxa de Conclusão</p>
                <p class="text-4xl font-black text-slate-800 mt-2">${done} <span class="text-lg text-slate-300">(${stories.length ? Math.round(done/stories.length*100) : 0}%)</span></p>
            </div>
            <div class="card p-8 border-l-8 border-rose-500">
                <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Críticos</p>
                <p class="text-4xl font-black text-slate-800 mt-2">${stories.filter(s => s.priority === 'Alta').length}</p>
            </div>`;
        updateCharts();
    }

    let charts = { po: null, done: null };
    function updateCharts() {
        const ctxPo = document.getElementById('chart-po-status')?.getContext('2d');
        if(ctxPo) {
            if(charts.po) charts.po.destroy();
            const pos = Array.from(new Set(stories.map(s => s.po))).filter(p => p);
            const data = pos.map(p => stories.filter(s => s.po === p).length);
            charts.po = new Chart(ctxPo, {
                type: 'bar',
                data: { labels: pos, datasets: [{ data, backgroundColor: '#6366f1', borderRadius: 10 }] },
                options: { indexAxis: 'y', maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });
        }
        const ctxDone = document.getElementById('chart-done-pending')?.getContext('2d');
        if(ctxDone) {
            if(charts.done) charts.done.destroy();
            const dc = stories.filter(s => s.status === STATUS_CONCLUIDO_NAME).length;
            charts.done = new Chart(ctxDone, {
                type: 'doughnut',
                data: { labels: ['Concluído', 'Pendente'], datasets: [{ data: [dc, stories.length-dc], backgroundColor: ['#10b981', '#f1f5f9'] }] },
                options: { cutout: '80%', maintainAspectRatio: false }
            });
        }
    }

    var selectedStoryIds = new Set();
    function toggleStorySel(id, chk) { if(chk) selectedStoryIds.add(id); else selectedStoryIds.delete(id); updateActionControls(); }
    function toggleSelectAll(chk) {
        document.querySelectorAll('#stories-table-body input[type="checkbox"]').forEach(c => {
            c.checked = chk; const id = parseInt(c.getAttribute('data-id'));
            if(chk) selectedStoryIds.add(id); else selectedStoryIds.delete(id);
        });
        updateActionControls();
    }
    function updateActionControls() {
        const ctrl = document.getElementById('table-action-controls');
        if(selectedStoryIds.size > 0) ctrl.classList.remove('hidden'); else ctrl.classList.add('hidden');
        document.getElementById('selected-count-message').textContent = `${selectedStoryIds.size} selecionado(s)`;
    }
    function editSelectedStory() { const id = Array.from(selectedStoryIds)[0]; const s = stories.find(st => st.id === id); if(s) openStoryForm(s); }
    function confirmDeleteSelected() {
        showModal("Remover", `Excluir estas ${selectedStoryIds.size} histórias?`, 
            `<button onclick="closeModal()" class="px-6 py-2">Cancelar</button>
             <button onclick="deleteMass(); closeModal();" class="px-6 py-2 bg-rose-600 text-white rounded-xl font-bold shadow-lg">Confirmar</button>`);
    }
    async function deleteMass() {
        for(const id of Array.from(selectedStoryIds)) {
            const s = stories.find(st => st.id === id);
            if(s && s._docId) await window.firestone.deleteStoryByDocId(s._docId);
        }
        selectedStoryIds.clear(); updateActionControls();
    }

    function handleInsertTask() {
        const id = parseInt(document.getElementById('story-id').value);
        const s = stories.find(st => st.id === id);
        if(s) openTaskModal(id, s.title);
    }

    window.onload = () => showView('dashboard');
</script>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
  import { getFirestore, collection, addDoc, doc, updateDoc, deleteDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDU3nmuB6kOiVAxuqTdpzOUjtzhVtj1sBg",
    authDomain: "managerscrum-dc813.firebaseapp.com",
    projectId: "managerscrum-dc813",
    storageBucket: "managerscrum-dc813.firebasestorage.app",
    messagingSenderId: "840047163274",
    appId: "1:840047163274:web:f86a11927e2751a4f4fa73",
    measurementId: "G-NM19SWTFHG"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  function docToObj(snap) { return { _docId: snap.id, ...snap.data() }; }

  onSnapshot(collection(db, 'features'), (s) => {
    window.features = s.docs.map(docToObj);
    if(typeof window.renderFeatures === 'function') window.renderFeatures();
    if(typeof window.populateStoryFeatureSelect === 'function') window.populateStoryFeatureSelect();
  });

  onSnapshot(collection(db, 'stories'), (s) => {
    window.stories = s.docs.map(docToObj);
    if(typeof window.renderStories === 'function') window.renderStories();
    if(typeof window.renderDashboard === 'function') window.renderDashboard();
  });

  onSnapshot(collection(db, 'tasks'), (s) => {
    window.tasks = s.docs.map(docToObj);
    if(window._lastTaskModalStoryId && typeof window.renderTasksInModal === 'function') window.renderTasksInModal(window._lastTaskModalStoryId);
    if(typeof window.renderStories === 'function') window.renderStories();
  });

  onSnapshot(collection(db, 'app_configs'), (s) => {
    Object.keys(window.configs).forEach(k => window.configs[k] = []);
    s.docs.forEach(d => {
        const item = docToObj(d);
        if(window.configs[item.type]) window.configs[item.type].push(item);
    });
    if(!document.getElementById('configs-view').classList.contains('hidden')) window.renderConfigLists();
  });

  async function saveConfig(c) {
    const { _docId, ...payload } = c;
    if(_docId) await updateDoc(doc(db, 'app_configs', _docId), payload);
    else await addDoc(collection(db, 'app_configs'), payload);
  }
  async function deleteConfig(id) { await deleteDoc(doc(db, 'app_configs', id)); }
  async function saveFeature(f) {
    const { _docId, ...payload } = f;
    if(_docId) await updateDoc(doc(db, 'features', _docId), payload);
    else await addDoc(collection(db, 'features'), payload);
  }
  async function saveStory(s) {
    const { _docId, ...payload } = s;
    if(_docId) await updateDoc(doc(db, 'stories', _docId), payload);
    else { const ref = await addDoc(collection(db, 'stories'), payload); return ref.id; }
  }
  async function saveTask(t) {
    const { _docId, ...payload } = t;
    if(_docId) await updateDoc(doc(db, 'tasks', _docId), payload);
    else await addDoc(collection(db, 'tasks'), payload);
  }
  async function deleteStoryByDocId(id) { await deleteDoc(doc(db, 'stories', id)); }
  async function deleteTask(id) { await deleteDoc(doc(db, 'tasks', id)); }

  window.firestone = { saveFeature, saveStory, saveTask, deleteStoryByDocId, deleteTask, saveConfig, deleteConfig };
</script>
</body>
</html>
