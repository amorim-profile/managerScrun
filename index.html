<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scrum Manager - Star Admin Style</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Manrope:wght@200..800&display=swap');
        
        :root {
            --bg-main: #F4F5F7;
            --primary: #1F3BB3;
            --secondary: #BECAD6;
            --success: #05C283;
            --info: #48A3D7;
            --warning: #F7941D;
            --danger: #F95F53;
            --text-main: #3E4B5B;
        }

        body { 
            font-family: 'Manrope', sans-serif; 
            background-color: var(--bg-main); 
            color: var(--text-main);
        }

        /* Star Admin Card Style */
        .card {
            background: white;
            border-radius: 20px;
            border: none;
            box-shadow: 0px 5px 20px rgba(0, 0, 0, 0.03);
            transition: transform 0.2s ease;
        }

        .sidebar {
            background: #FFFFFF;
            border-right: 1px solid #e5e7eb;
            height: 100vh;
        }

        .nav-btn {
            border-radius: 10px;
            font-weight: 500;
            margin: 4px 0;
            transition: all 0.3s ease;
            color: #484848;
        }

        .nav-btn:hover {
            background: #F4F5F7;
        }

        .nav-btn.active {
            background: var(--primary);
            color: white !important;
            box-shadow: 0 4px 10px rgba(31, 59, 179, 0.2);
        }

        .nav-btn.active svg {
            color: white;
        }

        .status-badge {
            padding: 0.4rem 0.8rem;
            font-weight: 700;
            font-size: 0.65rem;
            text-transform: uppercase;
            border-radius: 8px;
            display: inline-flex;
            align-items: center;
        }

        .btn-primary {
            background-color: var(--primary);
            color: white;
            border-radius: 10px;
            padding: 12px 24px;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(31, 59, 179, 0.15);
        }

        .btn-primary:hover {
            background-color: #162a82;
        }

        .main-content-wrapper {
            height: 100vh;
            overflow-y: auto;
        }

        .dense-table thead th {
            background: #fdfdfd;
            border-bottom: 1px solid #f1f1f1;
            color: #8D8D8D;
            font-size: 11px;
            font-weight: 700;
            padding: 15px;
        }

        .dense-table tbody td {
            padding: 18px 15px;
            border-bottom: 1px solid #f8f8f8;
            font-size: 13px;
        }

        .completion-bar {
            height: 6px;
            background: #EEEEEE;
            border-radius: 10px;
            overflow: hidden;
        }

        .completion-fill {
            height: 100%;
            transition: width 0.8s ease;
        }

        /* Mobile Sidebar Toggle */
        .mobile-nav-overlay {
            position: fixed;
            top: 0;
            left: 0;
            z-index: 50; 
            transform: translateX(-100%);
            transition: transform 0.3s ease;
            width: 260px;
            height: 100vh;
        }
        
        .mobile-nav-overlay.open { transform: translateX(0); }
        
        @media (min-width: 768px) {
            .mobile-nav-overlay {
                position: static;
                transform: translateX(0);
                width: 260px;
            }
        }

        .top-navbar {
            background: #FFFFFF;
            border-bottom: 1px solid #F3F3F3;
        }

        .submenu-item {
            display: flex;
            align-items: center;
            width: 100%;
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            color: #6B7280;
            transition: color 0.2s, background-color 0.2s;
            border-radius: 0.5rem;
        }
        
        .submenu-item:hover {
            color: var(--primary);
            background-color: #F3F4F6;
        }
        
        .submenu-item.active {
            color: var(--primary);
            font-weight: 700;
            background-color: #EFF6FF;
        }
    </style>
</head>
<body class="flex flex-col md:flex-row overflow-hidden">

    <!-- Sidebar Menu -->
    <aside id="sidebar-menu" class="mobile-nav-overlay sidebar flex flex-col p-5 shadow-sm z-40">
        <div class="flex items-center space-x-3 mb-8 px-2">
            <div class="w-8 h-8 bg-blue-700 rounded-lg flex items-center justify-center">
                <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
            </div>
            <h1 class="text-lg font-extrabold text-[#1F3BB3] tracking-tight">SCRUM<span class="text-gray-400">PRO</span></h1>
        </div>

        <nav class="flex-1 space-y-1">
            <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-3 px-2">Menu Principal</p>
            
            <button id="nav-dashboard" onclick="showView('dashboard'); toggleMobileMenu(true);"
                class="nav-btn active flex items-center w-full px-4 py-3 group">
                <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z"></path></svg>
                <span>Dashboard</span>
            </button>

            <div class="pt-6 pb-2 px-2">
                <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">Atividades</p>
            </div>

            <button id="parent-registrar" onclick="toggleSubmenu('registrar')" class="nav-btn flex items-center justify-between w-full px-4 py-3">
                <span class="flex items-center">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path></svg>
                    <span>Gerenciamento</span>
                </span>
                <svg id="arrow-registrar" class="w-4 h-4 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
            </button>
            
            <div id="submenu-registrar" class="space-y-1 pl-8 hidden animate-fadeIn">
                <button id="nav-feature" onclick="showView('feature'); toggleMobileMenu(true);" class="submenu-item">Features</button>
                <button id="nav-stories" onclick="showView('stories'); toggleMobileMenu(true);" class="submenu-item">Histórias & Tasks</button>
            </div>

            <div class="pt-6 pb-2 px-2">
                <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">Sistema</p>
            </div>

            <!-- Grupo de Configurações -->
            <button id="parent-configs" onclick="toggleSubmenu('config-parent')" class="nav-btn flex items-center justify-between w-full px-4 py-3">
                <span class="flex items-center">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path></svg>
                    <span>Configurações</span>
                </span>
                <svg id="arrow-config-parent" class="w-4 h-4 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
            </button>
            <div id="submenu-config-parent" class="space-y-1 pl-8 hidden">
                <button id="nav-configs" onclick="showView('configs'); toggleMobileMenu(true);" class="submenu-item">Parâmetros</button>
            </div>

            <!-- Grupo de Importação (Separado) -->
            <button id="parent-import" onclick="toggleSubmenu('import-parent')" class="nav-btn flex items-center justify-between w-full px-4 py-3">
                <span class="flex items-center">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
                    <span>Importação</span>
                </span>
                <svg id="arrow-import-parent" class="w-4 h-4 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
            </button>
            <div id="submenu-import-parent" class="space-y-1 pl-8 hidden">
                <button id="nav-import" onclick="showView('import'); toggleMobileMenu(true);" class="submenu-item">Importar Arquivos</button>
            </div>
        </nav>

        <div class="mt-auto p-4 bg-[#F4F5F7] rounded-2xl">
            <div class="flex items-center space-x-3">
                <div class="w-10 h-10 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-700 font-bold">JD</div>
                <div>
                    <p class="text-xs font-bold text-gray-800">Admin Scrum</p>
                    <p class="text-[10px] text-gray-500">Master Manager</p>
                </div>
            </div>
        </div>
    </aside>

    <div id="mobile-overlay" class="fixed inset-0 bg-black/30 z-40 hidden" onclick="toggleMobileMenu(true)"></div>

    <!-- Main Content -->
    <main class="flex-1 main-content-wrapper flex flex-col">
        
        <!-- Top Navbar -->
        <div class="top-navbar px-8 py-4 flex justify-between items-center">
            <button onclick="toggleMobileMenu()" class="md:hidden p-2 text-gray-500">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
            </button>
            
            <div></div>

            <div class="flex items-center space-x-6">
                <div class="relative">
                    <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v1m6 0H9"></path></svg>
                    <span class="absolute top-0 right-0 w-2 h-2 bg-red-500 rounded-full border-2 border-white"></span>
                </div>
                <p id="current-date-display" class="text-xs font-bold text-gray-400 uppercase tracking-tighter"></p>
            </div>
        </div>

        <div class="p-8">
            <!-- Generic Feedback Modal -->
            <div id="message-modal" class="fixed inset-0 bg-slate-900/40 backdrop-blur-sm flex items-center justify-center z-[100] hidden">
                <div class="card p-8 w-full max-w-sm text-center border-t-4 border-[#1F3BB3]">
                    <div id="modal-icon" class="w-16 h-16 bg-blue-50 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-4">
                        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    </div>
                    <h3 id="modal-title" class="text-lg font-extrabold text-slate-800 mb-2"></h3>
                    <p id="modal-body" class="text-sm text-slate-500 mb-8 leading-relaxed"></p>
                    <div id="modal-actions" class="flex justify-center space-x-3"></div>
                </div>
            </div>

            <!-- Dashboard View -->
            <div id="dashboard-view" class="view space-y-8 animate-fadeIn">
                <header>
                    <h2 class="text-2xl font-extrabold text-[#1F3BB3]">Visão Geral</h2>
                    <p class="text-sm text-gray-500">Monitoramento em tempo real do progresso das squads.</p>
                </header>
                
                <div id="dashboard-summary" class="grid grid-cols-1 md:grid-cols-4 gap-6">
                    <!-- Injected via JS -->
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="card p-6 lg:col-span-2">
                        <h3 class="text-md font-bold text-slate-800 mb-6 flex items-center">
                            Desempenho por PO
                        </h3>
                        <div class="chart-container"><canvas id="chart-po-status"></canvas></div>
                    </div>
                    <div class="card p-6">
                        <h3 class="text-md font-bold text-slate-800 mb-6">Entrega Global</h3>
                        <div class="chart-container flex items-center justify-center"><canvas id="chart-done-pending"></canvas></div>
                        <div id="chart-legend-container" class="mt-6 space-y-3"></div>
                    </div>
                </div>
            </div>

            <!-- Features View -->
            <div id="feature-view" class="view hidden space-y-6">
                <header class="flex justify-between items-center">
                    <div>
                        <h2 class="text-2xl font-extrabold text-[#1F3BB3]">Iniciativas Estratégicas</h2>
                        <p class="text-sm text-gray-500">Mapeamento de Features e entregas macro.</p>
                    </div>
                    <div class="flex gap-3">
                        <button onclick="exportData('features')" class="px-4 py-2 border border-gray-200 text-gray-600 rounded-xl text-xs font-bold hover:bg-white transition flex items-center">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                            Exportar CSV
                        </button>
                        <button onclick="openFeatureForm()" class="btn-primary flex items-center text-xs">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M12 4v16m8-8H4"></path></svg>
                            Adicionar Feature
                        </button>
                    </div>
                </header>

                <div id="feature-form-container" class="card p-8 hidden animate-fadeIn border-t-4 border-[#1F3BB3]">
                    <form id="feature-form" class="space-y-6">
                        <input type="hidden" id="feature-id"><input type="hidden" id="feature-doc-id">
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                            <div class="space-y-1">
                                <label class="text-[10px] font-bold text-gray-400 uppercase">ID Externo</label>
                                <input type="number" id="feature-external-id" class="w-full border border-gray-200 p-3 rounded-xl focus:ring-2 focus:ring-blue-100 outline-none">
                            </div>
                            <div class="md:col-span-3 space-y-1">
                                <label class="text-[10px] font-bold text-gray-400 uppercase">Título da Iniciativa</label>
                                <input type="text" id="feature-title" required class="w-full border border-gray-200 p-3 rounded-xl focus:ring-2 focus:ring-blue-100 outline-none">
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div class="space-y-1">
                                <label class="text-[10px] font-bold text-gray-400 uppercase">Diretoria</label>
                                <select id="feature-directorate" required class="w-full border border-gray-200 p-3 rounded-xl outline-none"></select>
                            </div>
                            <div class="space-y-1">
                                <label class="text-[10px] font-bold text-gray-400 uppercase">Product Owner</label>
                                <select id="feature-po" required class="w-full border border-gray-200 p-3 rounded-xl outline-none"></select>
                            </div>
                            <div class="space-y-1">
                                <label class="text-[10px] font-bold text-gray-400 uppercase">Status</label>
                                <select id="feature-status" required class="w-full border border-gray-200 p-3 rounded-xl outline-none"></select>
                            </div>
                        </div>
                        <div class="flex justify-end space-x-4">
                            <button type="button" onclick="closeFeatureForm()" class="text-xs font-bold text-gray-400">Cancelar</button>
                            <button type="submit" class="btn-primary text-xs">Salvar Feature</button>
                        </div>
                    </form>
                </div>

                <!-- Bulk Action Bar for Features -->
                <div id="feature-table-action-controls" class="card p-4 hidden bg-[#1F3BB3] border-none flex items-center justify-between text-white animate-fadeIn shadow-lg">
                    <div class="flex items-center space-x-4">
                        <span id="feature-selected-count-message" class="text-xs font-bold opacity-90 tracking-wide px-2 border-r border-white/20"></span>
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="editSelectedFeature()" id="feature-edit-selected-btn" class="bg-white/20 hover:bg-white/30 px-4 py-2 rounded-lg text-[10px] font-bold transition uppercase">Editar</button>
                        <button onclick="confirmDeleteSelectedFeatures()" id="feature-delete-selected-btn" class="bg-red-500/80 hover:bg-red-600 px-4 py-2 rounded-lg text-[10px] font-bold transition uppercase">Excluir</button>
                    </div>
                </div>

                <div class="card overflow-hidden">
                    <table class="w-full dense-table">
                        <thead>
                            <tr>
                                <th class="w-12 text-center"><input type="checkbox" id="header-select-all-features" onchange="toggleSelectAllFeatures(this.checked)" class="w-4 h-4 rounded text-[#1F3BB3] border-gray-300"></th>
                                <th class="text-left">ID Ext</th>
                                <th class="text-left">Iniciativa</th>
                                <th class="text-left">Responsável</th>
                                <th class="text-left text-center">Situação</th>
                                <th class="w-20"></th>
                            </tr>
                        </thead>
                        <tbody id="features-table-body"></tbody>
                    </table>
                </div>
            </div>

            <!-- Stories View -->
            <div id="stories-view" class="view hidden space-y-6">
                <header class="flex justify-between items-center">
                    <div>
                        <h2 class="text-2xl font-extrabold text-[#1F3BB3]">Histórias & Backlog</h2>
                        <p class="text-sm text-gray-500">Operação detalhada e progresso de desenvolvimento.</p>
                    </div>
                    <div class="flex items-center gap-3">
                        <div class="flex bg-white p-1 rounded-xl shadow-sm border border-gray-100">
                            <button onclick="exportData('stories')" class="px-3 py-2 text-[10px] font-bold text-emerald-600 hover:bg-emerald-50 rounded-lg">Histórias (CSV)</button>
                            <button onclick="exportData('tasks')" class="px-3 py-2 text-[10px] font-bold text-indigo-600 hover:bg-indigo-50 rounded-lg">Tasks (CSV)</button>
                        </div>
                        <button onclick="openStoryForm()" class="btn-primary flex items-center text-xs">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M12 4v16m8-8H4"></path></svg>
                            Nova História
                        </button>
                    </div>
                </header>
                
                <div id="story-form-container" class="card p-8 hidden animate-fadeIn border-t-4 border-[#1F3BB3]">
                    <form id="story-form" class="space-y-6">
                        <input type="hidden" id="story-id"><input type="hidden" id="story-doc-id">
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                            <div class="space-y-1">
                                <label class="text-[10px] font-bold text-gray-400 uppercase">ID Externo</label>
                                <input type="number" id="story-external-id" class="w-full border border-gray-200 p-3 rounded-xl outline-none">
                            </div>
                            <div class="md:col-span-3 space-y-1">
                                <label class="text-[10px] font-bold text-gray-400 uppercase">Título da História</label>
                                <input type="text" id="story-title" required class="w-full border border-gray-200 p-3 rounded-xl outline-none">
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="space-y-1">
                                <label class="text-[10px] font-bold text-gray-400 uppercase">Link de Referência</label>
                                <input type="url" id="story-external-link" class="w-full border border-gray-200 p-3 rounded-xl outline-none">
                            </div>
                            <div class="space-y-1">
                                <label class="text-[10px] font-bold text-gray-400 uppercase">Iniciativa Relacionada</label>
                                <select id="story-feature-id" class="w-full border border-gray-200 p-3 rounded-xl outline-none"></select>
                            </div>
                        </div>
                        <div class="space-y-1">
                            <label class="text-[10px] font-bold text-gray-400 uppercase">Descrição Detalhada</label>
                            <textarea id="story-description" class="w-full border border-gray-200 p-3 rounded-xl outline-none" rows="3"></textarea>
                        </div>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-6">
                            <div class="space-y-1">
                                <label class="text-[10px] font-bold text-gray-400 uppercase">Data de Entrada</label>
                                <input type="date" id="story-requested-date" class="w-full border border-gray-200 p-3 rounded-xl text-xs outline-none">
                            </div>
                            <div class="space-y-1">
                                <label class="text-[10px] font-bold text-gray-400 uppercase">Solicitante</label>
                                <input type="text" id="story-requester-name" class="w-full border border-gray-200 p-3 rounded-xl outline-none">
                            </div>
                            <div class="space-y-1">
                                <label class="text-[10px] font-bold text-gray-400 uppercase">Área Operacional</label>
                                <select id="story-area" class="w-full border border-gray-200 p-3 rounded-xl outline-none"></select>
                            </div>
                            <div class="space-y-1">
                                <label class="text-[10px] font-bold text-gray-400 uppercase">PO Responsável</label>
                                <select id="story-po" class="w-full border border-gray-200 p-3 rounded-xl outline-none"></select>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="space-y-1">
                                <label class="text-[10px] font-bold text-gray-400 uppercase">Status Atual</label>
                                <select id="story-status" class="w-full border border-gray-200 p-3 rounded-xl outline-none"></select>
                            </div>
                            <div class="space-y-1">
                                <label class="text-[10px] font-bold text-gray-400 uppercase">Nível de Prioridade</label>
                                <select id="story-priority" class="w-full border border-gray-200 p-3 rounded-xl outline-none">
                                    <option value="Alta">Alta</option><option value="Média">Média</option><option value="Baixa">Baixa</option>
                                </select>
                            </div>
                        </div>
                        <div class="flex justify-between items-center pt-6 border-t border-gray-100">
                            <button type="button" id="insert-task-btn" onclick="handleInsertTask()" class="text-xs font-bold text-[#1F3BB3] bg-blue-50 px-5 py-3 rounded-xl hover:bg-blue-100 transition">Configurar Tarefas (Tasks)</button>
                            <div class="flex space-x-4">
                                <button type="button" onclick="closeStoryForm()" class="text-xs font-bold text-gray-400">Descartar</button>
                                <button type="submit" class="btn-primary text-xs">Salvar Alterações</button>
                            </div>
                        </div>
                    </form>
                </div>

                <!-- Bulk Action Bar -->
                <div id="table-action-controls" class="card p-4 hidden bg-[#1F3BB3] border-none flex items-center justify-between text-white animate-fadeIn shadow-lg">
                    <div class="flex items-center space-x-4">
                        <span id="selected-count-message" class="text-xs font-bold opacity-90 tracking-wide px-2 border-r border-white/20"></span>
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="editSelectedStory()" id="edit-selected-btn" class="bg-white/20 hover:bg-white/30 px-4 py-2 rounded-lg text-[10px] font-bold transition uppercase">Editar</button>
                        <button onclick="confirmDeleteSelected()" id="delete-selected-btn" class="bg-red-500/80 hover:bg-red-600 px-4 py-2 rounded-lg text-[10px] font-bold transition uppercase">Excluir</button>
                    </div>
                </div>

                <div class="card overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full dense-table">
                            <thead>
                                <tr>
                                    <th class="w-12 text-center"><input type="checkbox" id="header-select-all" onchange="toggleSelectAll(this.checked)" class="w-4 h-4 rounded text-[#1F3BB3] border-gray-300"></th>
                                    <th class="text-left">Identificador</th>
                                    <th class="text-left">Título da História</th>
                                    <th class="text-left">Área</th>
                                    <th class="text-left">Situação</th>
                                    <th class="text-left">Execução</th>
                                </tr>
                            </thead>
                            <tbody id="stories-table-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Configs View -->
            <div id="configs-view" class="view hidden space-y-8 animate-fadeIn">
                <header>
                    <h2 class="text-2xl font-extrabold text-[#1F3BB3]">Gerenciamento de Parâmetros</h2>
                    <p class="text-sm text-gray-500">Configurações globais de catálogos e taxonomias do sistema.</p>
                </header>
                <div id="configs-content" class="flex flex-col gap-10"></div>
            </div>

            <!-- Import View -->
            <div id="import-view" class="view hidden space-y-8 animate-fadeIn">
                <header>
                    <h2 class="text-2xl font-extrabold text-[#1F3BB3]">Importação de Dados</h2>
                    <p class="text-sm text-gray-500">Carregue registos em massa utilizando ficheiros CSV formatados.</p>
                </header>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- Import Feature -->
                    <div class="card p-8 border-t-4 border-emerald-500 flex flex-col h-full">
                        <h4 class="text-[10px] font-extrabold mb-4 text-emerald-600 uppercase tracking-widest">Importar Features</h4>
                        <p class="text-xs text-gray-400 mb-6 leading-relaxed flex-grow">Carregue iniciativas estratégicas. O arquivo deve conter cabeçalhos exatos.</p>
                        <div class="space-y-3">
                            <button onclick="downloadTemplate('features')" class="w-full py-3 bg-slate-50 text-slate-600 rounded-xl text-[10px] font-bold uppercase hover:bg-slate-100 transition border border-slate-200">Baixar Modelo CSV</button>
                            <input type="file" id="file-import-features" class="hidden" accept=".csv" onchange="handleFileImport('features', this)">
                            <button onclick="document.getElementById('file-import-features').click()" class="w-full flex items-center justify-center gap-2 border-2 border-dashed border-emerald-100 rounded-xl py-5 text-emerald-600 font-bold text-xs hover:bg-emerald-50 transition group">
                                <svg class="w-5 h-5 group-hover:scale-110 transition" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
                                Upload CSV
                            </button>
                        </div>
                    </div>
                    <!-- Import Stories -->
                    <div class="card p-8 border-t-4 border-indigo-500 flex flex-col h-full">
                        <h4 class="text-[10px] font-extrabold mb-4 text-indigo-600 uppercase tracking-widest">Importar Histórias</h4>
                        <p class="text-xs text-gray-400 mb-6 leading-relaxed flex-grow">Carregue o backlog de histórias. Necessário vincular o ID da Feature se houver.</p>
                        <div class="space-y-3">
                            <button onclick="downloadTemplate('stories')" class="w-full py-3 bg-slate-50 text-slate-600 rounded-xl text-[10px] font-bold uppercase hover:bg-slate-100 transition border border-slate-200">Baixar Modelo CSV</button>
                            <input type="file" id="file-import-stories" class="hidden" accept=".csv" onchange="handleFileImport('stories', this)">
                            <button onclick="document.getElementById('file-import-stories').click()" class="w-full flex items-center justify-center gap-2 border-2 border-dashed border-indigo-100 rounded-xl py-5 text-indigo-600 font-bold text-xs hover:bg-indigo-50 transition group">
                                <svg class="w-5 h-5 group-hover:scale-110 transition" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
                                Upload CSV
                            </button>
                        </div>
                    </div>
                    <!-- Import Tasks -->
                    <div class="card p-8 border-t-4 border-blue-500 flex flex-col h-full">
                        <h4 class="text-[10px] font-extrabold mb-4 text-blue-600 uppercase tracking-widest">Importar Tasks</h4>
                        <p class="text-xs text-gray-400 mb-6 leading-relaxed flex-grow">Carregue tarefas. Informe o ID da História para associação correta.</p>
                        <div class="space-y-3">
                            <button onclick="downloadTemplate('tasks')" class="w-full py-3 bg-slate-50 text-slate-600 rounded-xl text-[10px] font-bold uppercase hover:bg-slate-100 transition border border-slate-200">Baixar Modelo CSV</button>
                            <input type="file" id="file-import-tasks" class="hidden" accept=".csv" onchange="handleFileImport('tasks', this)">
                            <button onclick="document.getElementById('file-import-tasks').click()" class="w-full flex items-center justify-center gap-2 border-2 border-dashed border-blue-100 rounded-xl py-5 text-blue-600 font-bold text-xs hover:bg-blue-50 transition group">
                                <svg class="w-5 h-5 group-hover:scale-110 transition" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
                                Upload CSV
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Task Modals -->
        <div id="task-list-modal" class="fixed inset-0 bg-slate-900/40 backdrop-blur-sm flex items-center justify-center z-[80] hidden p-4">
             <div class="card p-10 w-full max-w-4xl max-h-[85vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-8 pb-4 border-b border-gray-100">
                    <h3 id="task-modal-list-title" class="text-xl font-bold text-slate-900 tracking-tight">Detalhamento de Tarefas (Tasks)</h3>
                    <button onclick="closeStoryTasksModal()" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
                <div class="overflow-hidden border border-gray-100 rounded-2xl mb-8 shadow-sm">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-4 text-left text-[10px] font-bold text-gray-400 uppercase">ID Ext</th>
                                <th class="px-6 py-4 text-left text-[10px] font-bold text-gray-400 uppercase">Título da Tarefa</th>
                                <th class="px-6 py-4 text-left text-[10px] font-bold text-gray-400 uppercase">Status</th>
                                <th class="px-6 py-4 text-center text-[10px] font-bold text-gray-400 uppercase">Ações</th>
                            </tr>
                        </thead>
                        <tbody id="task-list-modal-table-body" class="bg-white"></tbody>
                    </table>
                </div>
                <div class="flex justify-end gap-3">
                     <button id="add-task-from-modal-btn" class="btn-primary text-xs">Adicionar Nova Tarefa</button>
                </div>
             </div>
        </div>

        <!-- Task Create Modal -->
        <div id="task-modal" class="fixed inset-0 bg-slate-900/40 backdrop-blur-sm flex items-center justify-center z-[90] hidden p-4">
            <div class="card p-10 w-full max-w-lg"> 
                <h3 id="task-modal-title" class="text-xl font-bold text-slate-900 mb-8 pb-4 border-b border-gray-100">Registrar Atividade</h3>
                <form id="task-form" class="space-y-5">
                    <input type="hidden" id="task-story-id"><input type="hidden" id="task-id"><input type="hidden" id="task-doc-id"> 
                    <div class="grid grid-cols-2 gap-4">
                        <div class="space-y-1">
                            <label class="text-[10px] font-bold text-gray-400 uppercase">ID Externo</label>
                            <input type="number" id="task-external-id" required class="w-full border border-gray-200 p-3 rounded-xl outline-none focus:ring-2 focus:ring-blue-100">
                        </div>
                        <div class="space-y-1">
                            <label class="text-[10px] font-bold text-gray-400 uppercase">Identificador GMUD</label>
                            <input type="text" id="task-gmud-id" class="w-full border border-gray-200 p-3 rounded-xl outline-none focus:ring-2 focus:ring-blue-100">
                        </div>
                    </div>
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-gray-400 uppercase">Nome da Atividade</label>
                        <input type="text" id="task-title" required class="w-full border border-gray-200 p-3 rounded-xl outline-none focus:ring-2 focus:ring-blue-100">
                    </div>
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-gray-400 uppercase">Link do PR / Repositório</label>
                        <input type="url" id="task-external-link" class="w-full border border-gray-200 p-3 rounded-xl outline-none focus:ring-2 focus:ring-blue-100">
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="space-y-1">
                            <label class="text-[10px] font-bold text-gray-400 uppercase">Plataforma</label>
                            <select id="task-system" required class="w-full border border-gray-200 p-3 rounded-xl outline-none text-xs"></select>
                        </div>
                        <div class="space-y-1">
                            <label class="text-[10px] font-bold text-gray-400 uppercase">Líder Técnico</label>
                            <select id="task-techlead" required class="w-full border border-gray-200 p-3 rounded-xl outline-none text-xs"></select>
                        </div>
                        <div class="space-y-1">
                            <label class="text-[10px] font-bold text-gray-400 uppercase">Situação</label>
                            <select id="task-status" required class="w-full border border-gray-200 p-3 rounded-xl outline-none text-xs"></select>
                        </div>
                    </div>
                    <div class="flex justify-end space-x-4 pt-6">
                        <button type="button" onclick="closeTaskModal()" class="text-xs font-bold text-gray-400">Voltar</button>
                        <button type="submit" class="btn-primary text-xs">Gravar Registro</button>
                    </div>
                </form>
            </div>
        </div>

    </main>

<script>
    const dateOptions = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
    document.getElementById('current-date-display').textContent = new Date().toLocaleDateString('pt-BR', dateOptions);

    var features = [];
    var stories = [];
    var tasks = [];
    var configs = {
        directorate: [], area: [], po: [], 
        statusStory: [], statusTask: [], statusFeature: [], 
        system: [], techlead: []
    };
    
    window.firestone = window.firestone || null;
    window._lastTaskModalStoryId = null;
    const STATUS_CONCLUIDO_NAME = 'Concluído';
    const generateId = () => Date.now() + Math.floor(Math.random() * 1000);

    const statusColors = {
        'A Fazer': 'bg-[#F95F53] text-white',
        'Em Desenvolvimento': 'bg-[#1F3BB3] text-white',
        'Em Teste': 'bg-[#F7941D] text-white',
        'Concluído': 'bg-[#05C283] text-white',
        'Pendente': 'bg-[#BECAD6] text-white',
        'Iniciado': 'bg-[#48A3D7] text-white',
        'Proposto': 'bg-slate-100 text-slate-500 border border-slate-200',
        'Aprovado': 'bg-[#05C283] text-white',
        'Em Andamento': 'bg-[#1F3BB3] text-white',
    };

    const priorityColors = {
        'Alta': 'bg-red-50 text-red-600',
        'Média': 'bg-amber-50 text-amber-600',
        'Baixa': 'bg-green-50 text-green-600',
    };

    // === TEMPLATE LOGIC ===
    function downloadTemplate(type) {
        let headers = [];
        let filename = `modelo_${type}.csv`;
        
        if (type === 'features') headers = ["ID Externo", "Titulo", "Diretoria", "PO", "Status"];
        else if (type === 'stories') headers = ["ID Externo", "Titulo", "Area", "PO", "Status", "Prioridade", "Solicitante", "Data", "FeatureID"];
        else if (type === 'tasks') headers = ["ID Externo", "Titulo", "HistoriaID", "Plataforma", "Lider Tecnico", "Status", "GMUD", "Link"];

        const csvString = "\ufeff" + headers.join(";"); // Usando ponto e vírgula por padrão para Excel BR
        const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = filename;
        link.click();
    }

    // === IMPORT LOGIC ===
    async function handleFileImport(type, input) {
        const file = input.files[0];
        if (!file) return;

        showModal("Processando", "Lendo ficheiro e preparando importação...", "");

        const reader = new FileReader();
        reader.onload = async (e) => {
            try {
                const text = e.target.result;
                const lines = text.split(/\r?\n/).filter(l => l.trim() !== "");
                if (lines.length <= 1) throw new Error("Ficheiro vazio ou sem dados.");

                // Detectar delimitador (vírgula ou ponto e vírgula)
                const headerLine = lines[0];
                const delimiter = headerLine.includes(';') ? ';' : ',';
                
                // Mapear cabeçalhos para índices
                const headers = headerLine.split(delimiter).map(h => h.trim().toLowerCase());
                const findIdx = (names) => headers.findIndex(h => names.some(n => h.includes(n.toLowerCase())));

                const dataLines = lines.slice(1);
                let count = 0;

                for (let line of dataLines) {
                    // Regex para lidar com valores entre aspas contendo delimitadores
                    const regex = new RegExp(`("${delimiter}"|[^"${delimiter}]+)(?=\\s*${delimiter}|\\s*$)`, 'g');
                    const values = line.match(regex) || [];
                    const cleanValues = values.map(v => v.replace(/^"|"$/g, '').trim());

                    if (type === 'features') {
                        const payload = {
                            id: generateId(),
                            externalId: cleanValues[findIdx(["externo", "ext"])] || "",
                            title: cleanValues[findIdx(["titulo", "nome", "iniciativa"])] || "Sem Titulo",
                            directorate: cleanValues[findIdx(["diretoria"])] || "",
                            po: cleanValues[findIdx(["po", "product"])] || "",
                            status: cleanValues[findIdx(["status", "situacao"])] || "Proposto",
                            updatedAt: new Date().toISOString()
                        };
                        await window.firestone.saveFeature(payload);
                    } else if (type === 'stories') {
                        const payload = {
                            id: generateId(),
                            externalId: cleanValues[findIdx(["externo", "ext"])] || "",
                            title: cleanValues[findIdx(["titulo", "historia"])] || "Sem Titulo",
                            area: cleanValues[findIdx(["area"])] || "",
                            po: cleanValues[findIdx(["po"])] || "",
                            status: cleanValues[findIdx(["status"])] || "A Fazer",
                            priority: cleanValues[findIdx(["prioridade"])] || "Média",
                            requesterName: cleanValues[findIdx(["solicitante"])] || "",
                            requestedDate: cleanValues[findIdx(["data"])] || new Date().toISOString().split('T')[0],
                            featureId: parseInt(cleanValues[findIdx(["featureid", "id feature"])]) || null,
                            updatedAt: new Date().toISOString()
                        };
                        await window.firestone.saveStory(payload);
                    } else if (type === 'tasks') {
                        const payload = {
                            id: generateId(),
                            externalId: cleanValues[findIdx(["externo", "ext"])] || "",
                            title: cleanValues[findIdx(["titulo", "tarefa"])] || "Sem Titulo",
                            storyId: parseInt(cleanValues[findIdx(["historiaid", "id historia"])]) || 0,
                            system: cleanValues[findIdx(["plataforma", "sistema"])] || "",
                            techlead: cleanValues[findIdx(["lider", "lead", "tech"])] || "",
                            status: cleanValues[findIdx(["status"])] || "A Fazer",
                            gmudId: cleanValues[findIdx(["gmud"])] || "",
                            externalLink: cleanValues[findIdx(["link", "pr"])] || "",
                            updatedAt: new Date().toISOString()
                        };
                        await window.firestone.saveTask(payload);
                    }
                    count++;
                }

                showModal("Sucesso", `${count} registos importados com sucesso baseados nos cabeçalhos encontrados.`, `<button onclick="closeModal()" class="btn-primary text-xs">Entendido</button>`);
                input.value = ''; 
            } catch (err) {
                console.error(err);
                showModal("Erro", "Falha ao processar o ficheiro. Certifique-se que o arquivo é um CSV válido e contém os cabeçalhos necessários.", `<button onclick="closeModal()" class="btn-primary text-xs">Fechar</button>`);
            }
        };
        reader.readAsText(file);
    }

    // === EXPORT LOGIC ===
    function exportData(type) {
        let dataToExport = [];
        let filename = "";
        let headers = [];

        if (type === 'features') {
            dataToExport = features;
            filename = `features_${new Date().getTime()}.csv`;
            headers = ["ID", "ID Externo", "Titulo", "Diretoria", "PO", "Status", "Atualizado"];
        } else if (type === 'stories') {
            dataToExport = stories;
            filename = `historias_${new Date().getTime()}.csv`;
            headers = ["ID", "ID Externo", "Titulo", "Area", "PO", "Status", "Prioridade", "Solicitante", "Data", "FeatureID"];
        } else if (type === 'tasks') {
            dataToExport = tasks;
            filename = `tarefas_${new Date().getTime()}.csv`;
            headers = ["ID", "ID Externo", "Titulo", "HistoriaID", "Sistema", "Lead", "Status", "GMUD", "Link"];
        }

        if (!dataToExport.length) {
            showModal("Vazio", "Nenhum dado encontrado para exportação.", `<button onclick="closeModal()" class="btn-primary text-xs">Fechar</button>`);
            return;
        }

        const csvRows = [headers.join(";")];
        dataToExport.forEach(item => {
            let row = [];
            if (type === 'features') row = [item.id, item.externalId, `"${item.title}"`, `"${item.directorate}"`, `"${item.po}"`, `"${item.status}"`, item.updatedAt];
            else if (type === 'stories') row = [item.id, item.externalId, `"${item.title}"`, `"${item.area}"`, `"${item.po}"`, `"${item.status}"`, `"${item.priority}"`, `"${item.requesterName}"`, item.requestedDate, item.featureId || "-"];
            else if (type === 'tasks') row = [item.id, item.externalId, `"${item.title}"`, item.storyId, `"${item.system}"`, `"${item.techlead}"`, `"${item.status}"`, `"${item.gmudId}"`, `"${item.externalLink}"` ];
            csvRows.push(row.join(";"));
        });

        const blob = new Blob(["\ufeff" + csvRows.join("\n")], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = filename;
        link.click();
    }

    function toggleMobileMenu(close = false) {
        const sidebar = document.getElementById('sidebar-menu');
        const overlay = document.getElementById('mobile-overlay');
        if(close || sidebar.classList.contains('open')) { 
            sidebar.classList.remove('open'); 
            overlay.classList.add('hidden'); 
        } else { 
            sidebar.classList.add('open'); 
            overlay.classList.remove('hidden'); 
        }
    }

    function toggleSubmenu(id) {
        const sub = document.getElementById(`submenu-${id}`);
        const arrow = document.getElementById(`arrow-${id}`);
        
        if (!sub) return;

        const isHidden = sub.classList.contains('hidden');
        
        document.querySelectorAll('[id^="submenu-"]').forEach(s => s.classList.add('hidden'));
        document.querySelectorAll('[id^="arrow-"]').forEach(a => a.classList.remove('rotate-180'));

        if(isHidden) { 
            sub.classList.remove('hidden'); 
            arrow?.classList.add('rotate-180'); 
        }
    }

    function showView(viewId) {
        document.querySelectorAll('.view').forEach(v => v.classList.add('hidden'));
        document.getElementById(`${viewId}-view`)?.classList.remove('hidden');
        
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.submenu-item').forEach(b => b.classList.remove('active'));

        if(viewId === 'dashboard') document.getElementById('nav-dashboard').classList.add('active');
        if(viewId === 'feature' || viewId === 'stories') document.getElementById('parent-registrar').classList.add('active');
        if(viewId === 'configs') document.getElementById('parent-configs').classList.add('active');
        if(viewId === 'import') document.getElementById('parent-import').classList.add('active');
        
        const subBtn = document.getElementById(`nav-${viewId}`);
        if(subBtn) subBtn.classList.add('active');

        if(viewId === 'configs') renderConfigLists();
        if(viewId === 'stories') { renderStories(); populateSelects(); populateStoryFeatureSelect(); }
        if(viewId === 'feature') { renderFeatures(); populateFeatureSelects(); }
        if(viewId === 'dashboard') renderDashboard();
    }

    function showModal(title, body, actions) {
        document.getElementById('modal-title').textContent = title;
        document.getElementById('modal-body').textContent = body;
        document.getElementById('modal-actions').innerHTML = actions;
        document.getElementById('message-modal').classList.remove('hidden');
    }
    function closeModal() { document.getElementById('message-modal').classList.add('hidden'); }

    // === FEATURES SELECTION & ACTIONS ===
    var selectedFeatureIds = new Set();
    function toggleFeatureSel(id, chk) { 
        if(chk) selectedFeatureIds.add(id); 
        else selectedFeatureIds.delete(id); 
        updateFeatureActionControls(); 
        renderFeatures(); 
    }
    function toggleSelectAllFeatures(chk) {
        document.querySelectorAll('#features-table-body input[type="checkbox"]').forEach(c => {
            const id = parseInt(c.getAttribute('data-id'));
            if(chk) selectedFeatureIds.add(id); else selectedFeatureIds.delete(id);
        });
        updateFeatureActionControls();
        renderFeatures();
    }
    function updateFeatureActionControls() {
        const ctrl = document.getElementById('feature-table-action-controls');
        if(selectedFeatureIds.size > 0) ctrl.classList.remove('hidden'); else ctrl.classList.add('hidden');
        document.getElementById('feature-selected-count-message').textContent = `${selectedFeatureIds.size} selecionada(s)`;
    }
    function editSelectedFeature() { 
        const id = Array.from(selectedFeatureIds)[0]; 
        const f = features.find(ft => ft.id === id); 
        if(f) openFeatureForm(f); 
    }
    function confirmDeleteSelectedFeatures() {
        showModal("Excluir Lote", `Deseja remover as ${selectedFeatureIds.size} iniciativas selecionadas definitivamente?`, 
            `<button onclick="closeModal()" class="text-xs font-bold text-gray-400">Cancelar</button>
             <button onclick="deleteMassFeatures(); closeModal();" class="btn-primary !bg-red-500 text-xs">Confirmar</button>`);
    }
    async function deleteMassFeatures() {
        for(const id of Array.from(selectedFeatureIds)) {
            const f = features.find(ft => ft.id === id);
            if(f && f._docId) await window.firestone.deleteFeatureByDocId(f._docId);
        }
        selectedFeatureIds.clear(); updateFeatureActionControls();
    }

    function renderConfigLists() {
        const container = document.getElementById('configs-content');
        container.innerHTML = '';
        const configLabels = { 'directorate': 'Diretoria', 'statusFeature': 'Status de Features', 'area': 'Áreas', 'po': 'Product Owners', 'statusStory': 'Status de Histórias', 'system': 'Sistema', 'techlead': 'Tech Lead', 'statusTask': 'Status de Tasks' };
        const groups = { 'Configurações de Features': ['directorate', 'statusFeature'], 'Configurações de Histórias': ['area', 'po', 'statusStory', 'system'], 'Configurações de Tasks': ['techlead', 'statusTask'] };

        for (const [groupName, types] of Object.entries(groups)) {
            const groupSection = document.createElement('div');
            groupSection.className = "space-y-6";
            groupSection.innerHTML = `<h3 class="text-md font-bold text-gray-800 border-b pb-2">${groupName}</h3>`;
            const grid = document.createElement('div');
            grid.className = "grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6";
            
            types.forEach(type => {
                const card = document.createElement('div');
                card.className = "card p-6 border-t-4 border-[#1F3BB3]";
                card.innerHTML = `
                    <h4 class="text-[10px] font-extrabold mb-4 text-[#1F3BB3] uppercase tracking-widest">${configLabels[type] || type}</h4>
                    <div id="list-${type}" class="space-y-2 mb-6 max-h-48 overflow-y-auto pr-2"></div>
                    <div class="flex space-x-2">
                        <input type="text" id="input-${type}" placeholder="Novo..." class="border border-gray-100 bg-gray-50 p-2 text-xs rounded-lg flex-1 focus:bg-white outline-none">
                        <button onclick="addConfigItem('${type}')" class="bg-[#1F3BB3] text-white px-3 py-2 rounded-lg font-bold shadow-sm">+</button>
                    </div>
                `;
                grid.appendChild(card);
                renderConfigItems(type, card.querySelector(`#list-${type}`));
            });
            groupSection.appendChild(grid);
            container.appendChild(groupSection);
        }
    }

    function renderConfigItems(type, listEl = null) {
        const list = listEl || document.getElementById(`list-${type}`);
        if(!list) return;
        list.innerHTML = '';
        configs[type].forEach(item => {
            const row = document.createElement('div');
            row.className = "flex justify-between items-center bg-gray-50 p-3 rounded-xl text-xs hover:bg-white border border-transparent hover:border-blue-100 transition";
            row.innerHTML = `
                <span class="${item.isActive ? 'font-bold text-slate-700' : 'line-through text-slate-400'}">${item.name}</span>
                <div class="flex space-x-3">
                    <button onclick="toggleConfigActive('${type}', '${item._docId}')" title="Inverter Status">
                        <span class="w-2 h-2 rounded-full inline-block ${item.isActive ? 'bg-[#05C283]' : 'bg-gray-300'}"></span>
                    </button>
                    <button onclick="deleteConfigItem('${type}', '${item._docId}')" class="text-gray-300 hover:text-red-500">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                    </button>
                </div>`;
            list.appendChild(row);
        });
    }

    async function addConfigItem(type) {
        const input = document.getElementById(`input-${type}`);
        const name = input.value.trim();
        if(!name || !window.firestone) return;
        await window.firestone.saveConfig({ type, name, isActive: true });
        input.value = '';
    }

    async function toggleConfigActive(type, docId) {
        const item = configs[type].find(i => i._docId === docId);
        if(!item || !window.firestone) return;
        await window.firestone.saveConfig({ ...item, isActive: !item.isActive });
    }

    async function deleteConfigItem(type, docId) {
        if(!window.firestone) return;
        showModal("Excluir", "Confirmar exclusão deste parâmetro?", 
            `<button onclick="closeModal()" class="text-xs font-bold text-gray-400">Cancelar</button>
             <button onclick="window.firestone.deleteConfig('${docId}'); closeModal();" class="btn-primary !bg-red-500 text-xs">Excluir</button>`);
    }

    function populateSelects() {
        const mappings = { 'story-area': 'area', 'story-po': 'po', 'story-status': 'statusStory' };
        for (const [id, type] of Object.entries(mappings)) {
            const el = document.getElementById(id); if(!el) continue;
            el.innerHTML = `<option value="">Selecionar...</option>`;
            configs[type].filter(c => c.isActive).forEach(c => { el.innerHTML += `<option value="${c.name}">${c.name}</option>`; });
        }
    }

    function populateFeatureSelects() {
        const mappings = { 'feature-directorate': 'directorate', 'feature-po': 'po', 'feature-status': 'statusFeature' };
        for (const [id, type] of Object.entries(mappings)) {
            const el = document.getElementById(id); if(!el) continue;
            el.innerHTML = `<option value="">Selecionar...</option>`;
            configs[type].filter(c => c.isActive).forEach(c => { el.innerHTML += `<option value="${c.name}">${c.name}</option>`; });
        }
    }

    function populateTaskSelects() {
        const mappings = { 'task-system': 'system', 'task-techlead': 'techlead', 'task-status': 'statusTask' };
        for (const [id, type] of Object.entries(mappings)) {
            const el = document.getElementById(id); if(!el) continue;
            el.innerHTML = `<option value="">Selecione...</option>`;
            configs[type].filter(c => c.isActive).forEach(c => { el.innerHTML += `<option value="${c.name}">${c.name}</option>`; });
        }
    }

    function populateStoryFeatureSelect() {
        const el = document.getElementById('story-feature-id');
        if(!el) return;
        el.innerHTML = `<option value="">Sem Feature Associada</option>`;
        features.forEach(f => { el.innerHTML += `<option value="${f.id}">${f.title}</option>`; });
    }

    function renderStories() {
        const body = document.getElementById('stories-table-body');
        if(!body) return; body.innerHTML = '';
        stories.forEach(s => {
            const prog = getStoryProg(s.id);
            const statusClass = statusColors[s.status] || 'bg-slate-100 text-slate-600';
            const isSelected = selectedStoryIds.has(s.id);

            body.innerHTML += `
                <tr class="hover:bg-blue-50/20 transition group ${isSelected ? 'bg-blue-50' : ''}">
                    <td class="text-center"><input type="checkbox" onchange="toggleStorySel(${s.id}, this.checked)" ${isSelected ? 'checked' : ''} class="w-4 h-4 rounded text-[#1F3BB3] border-gray-300" data-id="${s.id}"></td>
                    <td class="font-bold text-gray-400 text-[11px] uppercase">${s.externalId || '-'}</td>
                    <td class="cursor-pointer" onclick="openStoryFormById(${s.id})">
                        <div class="flex flex-col">
                            <span class="text-sm font-bold text-slate-800">${s.title}</span>
                            <span class="text-[10px] font-bold text-[#1F3BB3] uppercase mt-1 opacity-60">${s.po || 'N/A'}</span>
                        </div>
                    </td>
                    <td class="text-xs font-semibold text-gray-500">${s.area}</td>
                    <td><span class="status-badge ${statusClass}">${s.status}</span></td>
                    <td>
                        <div class="flex items-center space-x-3">
                            <div class="flex-1 completion-bar w-20">
                                <div class="completion-fill bg-[#1F3BB3]" style="width: ${prog.total ? (prog.done/prog.total*100) : 0}%"></div>
                            </div>
                            <button onclick="openStoryTasksModal(${s.id})" class="text-[10px] font-extrabold text-[#1F3BB3] hover:underline">
                                ${prog.done}/${prog.total}
                            </button>
                        </div>
                    </td>
                </tr>`;
        });
        updateActionControls();
    }

    function getStoryProg(id) {
        const ts = tasks.filter(t => t.storyId === id);
        const done = ts.filter(t => t.status === STATUS_CONCLUIDO_NAME).length;
        return { total: ts.length, done };
    }

    function openStoryForm(s = null) {
        document.getElementById('story-form-container').classList.remove('hidden');
        document.getElementById('story-form-container').scrollIntoView({ behavior: 'smooth' });
        if(s) {
            document.getElementById('story-doc-id').value = s._docId;
            document.getElementById('story-id').value = s.id;
            document.getElementById('story-external-id').value = s.externalId;
            document.getElementById('story-title').value = s.title;
            document.getElementById('story-area').value = s.area;
            document.getElementById('story-po').value = s.po;
            document.getElementById('story-status').value = s.status;
            document.getElementById('story-priority').value = s.priority;
            document.getElementById('story-description').value = s.description;
            document.getElementById('story-requested-date').value = s.requestedDate;
            document.getElementById('story-requester-name').value = s.requesterName;
            document.getElementById('story-feature-id').value = s.featureId || '';
            document.getElementById('insert-task-btn').classList.remove('opacity-50', 'pointer-events-none');
        } else {
            document.getElementById('story-form').reset();
            document.getElementById('story-id').value = generateId();
            document.getElementById('story-doc-id').value = '';
            document.getElementById('insert-task-btn').classList.add('opacity-50', 'pointer-events-none');
        }
    }
    function closeStoryForm() { document.getElementById('story-form-container').classList.add('hidden'); }
    function openStoryFormById(id) { const s = stories.find(st => st.id === id); if(s) openStoryForm(s); }

    document.getElementById('story-form').onsubmit = async function(e) {
        e.preventDefault();
        const data = {
            id: parseInt(document.getElementById('story-id').value),
            _docId: document.getElementById('story-doc-id').value || null,
            externalId: document.getElementById('story-external-id').value,
            title: document.getElementById('story-title').value,
            area: document.getElementById('story-area').value,
            po: document.getElementById('story-po').value,
            status: document.getElementById('story-status').value,
            priority: document.getElementById('story-priority').value,
            description: document.getElementById('story-description').value,
            requestedDate: document.getElementById('story-requested-date').value,
            requesterName: document.getElementById('story-requester-name').value,
            featureId: document.getElementById('story-feature-id').value ? parseInt(document.getElementById('story-feature-id').value) : null,
            updatedAt: new Date().toISOString()
        };
        await window.firestone.saveStory(data);
        if(!data._docId) { 
             setTimeout(() => {
                 const updated = stories.find(s => s.id === data.id);
                 if(updated) openStoryForm(updated);
             }, 500);
        } else {
            closeStoryForm();
        }
    };

    function renderFeatures() {
        const body = document.getElementById('features-table-body');
        if(!body) return; body.innerHTML = '';
        features.forEach(f => {
            const statusClass = statusColors[f.status] || 'bg-slate-100 text-slate-500';
            const isSelected = selectedFeatureIds.has(f.id);

            body.innerHTML += `
                <tr class="hover:bg-blue-50/20 transition group ${isSelected ? 'bg-blue-50' : ''}">
                    <td class="text-center"><input type="checkbox" onchange="toggleFeatureSel(${f.id}, this.checked)" ${isSelected ? 'checked' : ''} class="w-4 h-4 rounded text-[#1F3BB3] border-gray-300" data-id="${f.id}"></td>
                    <td class="font-bold text-gray-400 text-[11px] uppercase">${f.externalId || f.id}</td>
                    <td class="text-sm font-bold text-slate-800 cursor-pointer" onclick="openFeatureFormById(${f.id})">${f.title}</td>
                    <td class="text-xs font-semibold text-gray-500">${f.po}</td>
                    <td class="text-center"><span class="status-badge ${statusClass}">${f.status}</span></td>
                    <td class="text-right">
                         <button onclick="openFeatureFormById(${f.id})" class="text-gray-300 group-hover:text-[#1F3BB3] transition">
                             <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                         </button>
                    </td>
                </tr>`;
        });
        updateFeatureActionControls();
    }

    function openFeatureForm(f = null) {
        document.getElementById('feature-form-container').classList.remove('hidden');
        document.getElementById('feature-form-container').scrollIntoView({ behavior: 'smooth' });
        populateFeatureSelects();
        if(f) {
            document.getElementById('feature-doc-id').value = f._docId;
            document.getElementById('feature-id').value = f.id;
            document.getElementById('feature-external-id').value = f.externalId;
            document.getElementById('feature-title').value = f.title;
            document.getElementById('feature-directorate').value = f.directorate;
            document.getElementById('feature-po').value = f.po;
            document.getElementById('feature-status').value = f.status;
        } else {
            document.getElementById('feature-form').reset();
            document.getElementById('feature-id').value = generateId();
            document.getElementById('feature-doc-id').value = '';
        }
    }
    function closeFeatureForm() { document.getElementById('feature-form-container').classList.add('hidden'); }
    function openFeatureFormById(id) { const f = features.find(feat => feat.id === id); if(f) openFeatureForm(f); }

    document.getElementById('feature-form').onsubmit = async function(e) {
        e.preventDefault();
        const data = {
            id: parseInt(document.getElementById('feature-id').value),
            _docId: document.getElementById('feature-doc-id').value || null,
            externalId: document.getElementById('feature-external-id').value,
            title: document.getElementById('feature-title').value,
            directorate: document.getElementById('feature-directorate').value,
            po: document.getElementById('feature-po').value,
            status: document.getElementById('feature-status').value,
            updatedAt: new Date().toISOString()
        };
        await window.firestone.saveFeature(data);
        closeFeatureForm();
    };

    function openStoryTasksModal(id) {
        window._lastTaskModalStoryId = id;
        document.getElementById('task-list-modal').classList.remove('hidden');
        renderTasksInModal(id);
    }
    function closeStoryTasksModal() { 
        document.getElementById('task-list-modal').classList.add('hidden'); 
        window._lastTaskModalStoryId = null;
    }

    function renderTasksInModal(id) {
        const body = document.getElementById('task-list-modal-table-body');
        body.innerHTML = '';
        const ts = tasks.filter(t => t.storyId === id);
        if(!ts.length) {
            body.innerHTML = '<tr><td colspan="4" class="p-10 text-center text-gray-400">Backlog de tarefas vazio.</td></tr>';
        }
        ts.forEach(t => {
            const statusClass = statusColors[t.status] || 'bg-gray-100 text-gray-500';
            body.innerHTML += `
                <tr class="hover:bg-gray-50 transition border-b border-gray-50">
                    <td class="px-6 py-4 text-[10px] font-bold text-gray-400 uppercase">${t.externalId || '-'}</td>
                    <td class="px-6 py-4 text-sm font-bold text-slate-700">${t.title}</td>
                    <td class="px-6 py-4"><span class="status-badge !text-[8px] ${statusClass}">${t.status}</span></td>
                    <td class="px-6 py-4 text-center">
                        <button onclick="editTask(${t.id})" class="text-[#1F3BB3] font-bold text-xs mr-3">Editar</button>
                        <button onclick="confirmDelTask(${t.id})" class="text-red-500 font-bold text-xs">Excluir</button>
                    </td>
                </tr>`;
        });
        document.getElementById('add-task-from-modal-btn').onclick = () => {
             const s = stories.find(st => st.id === id);
             openTaskModal(id, s.title);
        };
    }

    function openTaskModal(sid, stitle, t = null) {
        document.getElementById('task-modal').classList.remove('hidden');
        populateTaskSelects();
        document.getElementById('task-story-id').value = sid;
        if(t) {
            document.getElementById('task-doc-id').value = t._docId;
            document.getElementById('task-id').value = t.id;
            document.getElementById('task-external-id').value = t.externalId;
            document.getElementById('task-gmud-id').value = t.gmudId;
            document.getElementById('task-title').value = t.title;
            document.getElementById('task-external-link').value = t.externalLink;
            document.getElementById('task-system').value = t.system;
            document.getElementById('task-techlead').value = t.techlead;
            document.getElementById('task-status').value = t.status;
        } else { 
            document.getElementById('task-form').reset(); 
            document.getElementById('task-id').value = generateId();
            document.getElementById('task-doc-id').value = '';
        }
    }
    function closeTaskModal() { document.getElementById('task-modal').classList.add('hidden'); }

    document.getElementById('task-form').onsubmit = async function(e) {
        e.preventDefault();
        const data = {
            id: parseInt(document.getElementById('task-id').value),
            _docId: document.getElementById('task-doc-id').value || null,
            storyId: parseInt(document.getElementById('task-story-id').value),
            externalId: document.getElementById('task-external-id').value,
            gmudId: document.getElementById('task-gmud-id').value,
            title: document.getElementById('task-title').value,
            externalLink: document.getElementById('task-external-link').value,
            system: document.getElementById('task-system').value,
            techlead: document.getElementById('task-techlead').value,
            status: document.getElementById('task-status').value,
            updatedAt: new Date().toISOString()
        };
        await window.firestone.saveTask(data);
        closeTaskModal();
    };

    function editTask(id) { 
        const t = tasks.find(tk => tk.id === id); 
        if(t) { const s = stories.find(st => st.id === t.storyId); openTaskModal(t.storyId, s.title, t); } 
    }
    
    function confirmDelTask(id) {
         showModal("Excluir Task", "Tem certeza que deseja remover este registro?", 
            `<button onclick="closeModal()" class="text-xs font-bold text-gray-400">Voltar</button>
             <button onclick="window.firestone.deleteTask('${tasks.find(tk=>tk.id===id)._docId}'); closeModal();" class="btn-primary !bg-red-500 text-xs">Confirmar</button>`);
    }

    function renderDashboard() {
        const done = stories.filter(s => s.status === STATUS_CONCLUIDO_NAME).length;
        const total = stories.length;
        const critical = stories.filter(s => s.priority === 'Alta').length;
        const summary = document.getElementById('dashboard-summary');
        if(!summary) return;
        
        const metrics = [
            { label: 'Histórias Totais', val: total, color: 'text-[#1F3BB3]', bg: 'bg-blue-50' },
            { label: 'Taxa de Entrega', val: total ? Math.round(done/total*100) + '%' : '0%', color: 'text-[#05C283]', bg: 'bg-green-50' },
            { label: 'Críticos (Alta)', val: critical, color: 'text-[#F95F53]', bg: 'bg-red-50' },
            { label: 'Tarefas Ativas', val: tasks.length, color: 'text-[#F7941D]', bg: 'bg-orange-50' }
        ];

        summary.innerHTML = metrics.map(m => `
            <div class="card p-6 flex flex-col justify-between">
                <p class="text-[10px] font-extrabold text-gray-400 uppercase tracking-widest">${m.label}</p>
                <div class="flex items-end justify-between mt-2">
                    <p class="text-2xl font-extrabold ${m.color}">${m.val}</p>
                    <div class="w-8 h-8 rounded-lg ${m.bg} flex items-center justify-center">
                        <svg class="w-4 h-4 ${m.color.replace('text-', 'text-')}" fill="currentColor" viewBox="0 0 20 20"><path d="M2 11a1 1 0 011-1h2a1 1 0 011 1v5a1 1 0 01-1 1H3a1 1 0 01-1-1v-5zM8 7a1 1 0 011-1h2a1 1 0 011 1v9a1 1 0 01-1 1H9a1 1 0 01-1-1V7zM14 4a1 1 0 011-1h2a1 1 0 011 1v12a1 1 0 01-1 1h-2a1 1 0 01-1-1V4z"></path></svg>
                    </div>
                </div>
            </div>`).join('');
        updateCharts();
    }

    let charts = { po: null, done: null };
    function updateCharts() {
        const ctxPo = document.getElementById('chart-po-status')?.getContext('2d');
        if(ctxPo) {
            if(charts.po) charts.po.destroy();
            const pos = Array.from(new Set(stories.map(s => s.po))).filter(p => p);
            const data = pos.map(p => stories.filter(s => s.po === p).length);
            charts.po = new Chart(ctxPo, {
                type: 'bar',
                data: { labels: pos, datasets: [{ data, backgroundColor: '#1F3BB3', borderRadius: 5, barThickness: 15 }] },
                options: { 
                    indexAxis: 'y', 
                    maintainAspectRatio: false, 
                    plugins: { legend: { display: false } },
                    scales: { x: { grid: { display: false } }, y: { grid: { display: false } } }
                }
            });
        }
        const ctxDone = document.getElementById('chart-done-pending')?.getContext('2d');
        if(ctxDone) {
            if(charts.done) charts.done.destroy();
            const dc = stories.filter(s => s.status === STATUS_CONCLUIDO_NAME).length;
            const pending = stories.length - dc;
            charts.done = new Chart(ctxDone, {
                type: 'doughnut',
                data: { 
                    labels: ['Concluído', 'Pendente'], 
                    datasets: [{ 
                        data: [dc, pending || 1], 
                        backgroundColor: ['#05C283', '#EEEEEE'],
                        borderWidth: 0
                    }] 
                },
                options: { cutout: '80%', maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });

            const legend = document.getElementById('chart-legend-container');
            legend.innerHTML = `
                <div class="flex items-center justify-between text-xs">
                    <span class="flex items-center"><span class="w-3 h-3 bg-[#05C283] rounded-full mr-2"></span> Concluídos</span>
                    <span class="font-bold">${dc}</span>
                </div>
                <div class="flex items-center justify-between text-xs">
                    <span class="flex items-center"><span class="w-3 h-3 bg-[#EEEEEE] rounded-full mr-2"></span> Pendentes</span>
                    <span class="font-bold">${pending}</span>
                </div>`;
        }
    }

    var selectedStoryIds = new Set();
    function toggleStorySel(id, chk) { if(chk) selectedStoryIds.add(id); else selectedStoryIds.delete(id); updateActionControls(); renderStories(); }
    function toggleSelectAll(chk) {
        document.querySelectorAll('#stories-table-body input[type="checkbox"]').forEach(c => {
            const id = parseInt(c.getAttribute('data-id'));
            if(chk) selectedStoryIds.add(id); else selectedStoryIds.delete(id);
        });
        updateActionControls();
        renderStories();
    }
    function updateActionControls() {
        const ctrl = document.getElementById('table-action-controls');
        if(selectedStoryIds.size > 0) ctrl.classList.remove('hidden'); else ctrl.classList.add('hidden');
        document.getElementById('selected-count-message').textContent = `${selectedStoryIds.size} selecionado(s)`;
    }
    function editSelectedStory() { const id = Array.from(selectedStoryIds)[0]; const s = stories.find(st => st.id === id); if(s) openStoryForm(s); }
    function confirmDeleteSelected() {
        showModal("Excluir Lote", `Deseja remover ${selectedStoryIds.size} histórias selecionadas?`, 
            `<button onclick="closeModal()" class="text-xs font-bold text-gray-400">Cancelar</button>
             <button onclick="deleteMass(); closeModal();" class="btn-primary !bg-red-500 text-xs">Confirmar</button>`);
    }
    async function deleteMass() {
        for(const id of Array.from(selectedStoryIds)) {
            const s = stories.find(st => st.id === id);
            if(s && s._docId) await window.firestone.deleteStoryByDocId(s._docId);
        }
        selectedStoryIds.clear(); updateActionControls();
    }

    function handleInsertTask() {
        const id = parseInt(document.getElementById('story-id').value);
        const s = stories.find(st => st.id === id);
        if(s) openTaskModal(id, s.title);
    }

    window.onload = () => showView('dashboard');
</script>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
  import { getFirestore, collection, addDoc, doc, updateDoc, deleteDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDU3nmuB6kOiVAxuqTdpzOUjtzhVtj1sBg",
    authDomain: "managerscrum-dc813.firebaseapp.com",
    projectId: "managerscrum-dc813",
    storageBucket: "managerscrum-dc813.firebasestorage.app",
    messagingSenderId: "840047163274",
    appId: "1:840047163274:web:f86a11927e2751a4f4fa73",
    measurementId: "G-NM19SWTFHG"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  function docToObj(snap) { return { _docId: snap.id, ...snap.data() }; }

  onSnapshot(collection(db, 'features'), (s) => {
    window.features = s.docs.map(docToObj);
    if(typeof window.renderFeatures === 'function') window.renderFeatures();
    if(typeof window.populateStoryFeatureSelect === 'function') window.populateStoryFeatureSelect();
  });

  onSnapshot(collection(db, 'stories'), (s) => {
    window.stories = s.docs.map(docToObj);
    if(typeof window.renderStories === 'function') window.renderStories();
    if(typeof window.renderDashboard === 'function') window.renderDashboard();
  });

  onSnapshot(collection(db, 'tasks'), (s) => {
    window.tasks = s.docs.map(docToObj);
    if(window._lastTaskModalStoryId && typeof window.renderTasksInModal === 'function') window.renderTasksInModal(window._lastTaskModalStoryId);
    if(typeof window.renderStories === 'function') window.renderStories();
  });

  onSnapshot(collection(db, 'app_configs'), (s) => {
    Object.keys(window.configs).forEach(k => window.configs[k] = []);
    s.docs.forEach(d => {
        const item = docToObj(d);
        if(window.configs[item.type]) window.configs[item.type].push(item);
    });
    if(!document.getElementById('configs-view').classList.contains('hidden')) window.renderConfigLists();
  });

  async function saveConfig(c) {
    const { _docId, ...payload } = c;
    if(_docId) await updateDoc(doc(db, 'app_configs', _docId), payload);
    else await addDoc(collection(db, 'app_configs'), payload);
  }
  async function deleteConfig(id) { await deleteDoc(doc(db, 'app_configs', id)); }
  async function saveFeature(f) {
    const { _docId, ...payload } = f;
    if(_docId) await updateDoc(doc(db, 'features', _docId), payload);
    else await addDoc(collection(db, 'features'), payload);
  }
  async function saveStory(s) {
    const { _docId, ...payload } = s;
    if(_docId) await updateDoc(doc(db, 'stories', _docId), payload);
    else { const ref = await addDoc(collection(db, 'stories'), payload); return ref.id; }
  }
  async function saveTask(t) {
    const { _docId, ...payload } = t;
    if(_docId) await updateDoc(doc(db, 'tasks', _docId), payload);
    else await addDoc(collection(db, 'tasks'), payload);
  }
  async function deleteStoryByDocId(id) { await deleteDoc(doc(db, 'stories', id)); }
  async function deleteFeatureByDocId(id) { await deleteDoc(doc(db, 'features', id)); }
  async function deleteTask(id) { await deleteDoc(doc(db, 'tasks', id)); }

  window.firestone = { saveFeature, saveStory, saveTask, deleteStoryByDocId, deleteFeatureByDocId, deleteTask, saveConfig, deleteConfig };
</script>
</body>
</html>
